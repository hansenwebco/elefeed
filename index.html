<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, interactive-widget=resizes-visual" />
  <title>Elefeed</title>
  <link rel="icon" type="image/svg+xml" href="favicon.svg" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display:ital@0;1&family=DM+Mono:wght@400;500&family=DM+Sans:ital,opsz,wght@0,9..40,300;0,9..40,400;0,9..40,500;1,9..40,300&display=swap" rel="stylesheet" />
  <style>
    *,
    *::before,
    *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    :root {
      color-scheme: dark;
      --bg: #0d0d0f;
      --surface: #141418;
      --surface2: #1c1c22;
      --border: #2a2a34;
      --border2: #3a3a48;
      --text: #e8e8f0;
      --text-muted: #8888a0;
      --text-dim: #55556a;
      --accent: #9b7fff;
      --accent2: #c4b0ff;
      --teal: #4ecdc4;
      --danger: #ff6b6b;
      --boost: #4ecdc4;
      --fav: #ffd93d;

      --font-display: 'DM Serif Display', Georgia, serif;
      --font-body: 'DM Sans', sans-serif;
      --font-mono: 'DM Mono', monospace;

      --radius: 8px;
      --radius-lg: 14px;
      --trans: 140ms ease;
    }

    html {
      scroll-behavior: smooth;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: var(--font-body);
      font-size: 15px;
      line-height: 1.6;
      min-height: 100dvh;
      -webkit-font-smoothing: antialiased;
    }

    /* ─── SCROLLBAR ─── */
    ::-webkit-scrollbar {
      width: 6px;
    }

    ::-webkit-scrollbar-track {
      background: transparent;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--border2);
      border-radius: 3px;
    }

    /* ═══════════════════════════════════════════════
       SCREENS
    ══════════════════════════════════════════════════ */
    .screen {
      display: none;
      flex-direction: column;
      min-height: 100dvh;
    }

    .screen.active {
      display: flex;
    }

    /* ═══════════════════════════════════════════════
       LOGIN SCREEN
    ══════════════════════════════════════════════════ */
    #login-screen {
      align-items: center;
      justify-content: center;
      background:
        radial-gradient(ellipse 70% 50% at 50% -10%, rgba(155, 127, 255, 0.18) 0%, transparent 70%),
        radial-gradient(ellipse 40% 30% at 90% 80%, rgba(78, 205, 196, 0.10) 0%, transparent 60%),
        var(--bg);
    }

    .login-card {
      width: 100%;
      max-width: 420px;
      padding: 0 20px;
    }

    .login-logo {
      text-align: center;
      margin-bottom: 40px;
    }

    .login-logo .wordmark {
      font-family: var(--font-display);
      font-size: 42px;
      letter-spacing: -1px;
      color: var(--text);
      line-height: 1;
    }

    .login-logo .wordmark span {
      color: var(--accent);
    }

    .login-logo .tagline {
      font-size: 13px;
      color: var(--text-dim);
      margin-top: 6px;
      font-family: var(--font-mono);
      letter-spacing: 0.06em;
    }

    .login-form-box {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      padding: 32px 28px;
    }

    .form-label {
      display: block;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 8px;
      font-family: var(--font-mono);
    }

    .server-input-wrap {
      display: flex;
      align-items: center;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      transition: border-color var(--trans);
    }

    .server-input-wrap:focus-within {
      border-color: var(--accent);
    }

    .server-prefix {
      padding: 0 10px 0 14px;
      color: var(--text-dim);
      font-family: var(--font-mono);
      font-size: 13px;
      white-space: nowrap;
      user-select: none;
    }

    .server-input {
      flex: 1;
      background: transparent;
      border: none;
      outline: none;
      color: var(--text);
      font-family: var(--font-mono);
      font-size: 14px;
      padding: 12px 14px 12px 0;
    }

    .server-input::placeholder {
      color: var(--text-dim);
    }

    .quick-servers {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 10px;
    }

    .quick-server-btn {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 4px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 4px 8px;
      cursor: pointer;
      transition: all var(--trans);
    }

    .quick-server-btn:hover {
      border-color: var(--accent);
      color: var(--accent2);
    }

    .login-btn {
      width: 100%;
      margin-top: 24px;
      padding: 14px;
      background: var(--accent);
      color: #0d0d0f;
      border: none;
      border-radius: var(--radius);
      font-family: var(--font-body);
      font-size: 15px;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--trans);
      letter-spacing: 0.01em;
    }

    .login-btn:hover {
      background: var(--accent2);
      transform: translateY(-1px);
    }

    .login-btn:active {
      transform: translateY(0);
    }

    .login-footer {
      text-align: center;
      margin-top: 24px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .login-footer a {
      color: var(--text-muted);
      text-decoration: none;
    }

    .login-footer a:hover {
      color: var(--accent2);
    }

    /* ═══════════════════════════════════════════════
       CALLBACK SCREEN
    ══════════════════════════════════════════════════ */
    #callback-screen {
      align-items: center;
      justify-content: center;
    }

    .callback-message {
      text-align: center;
    }

    .spinner {
      width: 32px;
      height: 32px;
      border: 2px solid var(--border);
      border-top-color: var(--accent);
      border-radius: 50%;
      animation: spin 700ms linear infinite;
      margin: 0 auto 20px;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .callback-message p {
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* ═══════════════════════════════════════════════
       APP SCREEN
    ══════════════════════════════════════════════════ */
    #app-screen {
      background: var(--bg);
      display: flex;
      flex-direction: row;
      justify-content: center;
      gap: 24px;
      padding: 0 20px;
    }

    /* Compose Sidebar */
    .compose-sidebar {
      width: 320px;
      flex-shrink: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin: 94px 0 20px 0;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 94px;
      align-self: flex-start;
      height: fit-content;
      max-height: calc(100vh - 114px);
      overflow-y: auto;
    }

    /* ═══════════════════════════════════════════════
       TRENDING TAB
    ══════════════════════════════════════════════════ */

    .trending-section {
      padding: 24px 20px 0;
    }

    .trending-section-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      color: var(--text-muted);
      font-family: var(--font-mono);
      margin-bottom: 14px;
    }

    .trending-section-title svg {
      color: var(--accent);
      flex-shrink: 0;
    }

    /* ── Trending Posts ── */
    .trending-posts-list {
      display: flex;
      flex-direction: column;
      gap: 0;
    }

    /* ── Trending Hashtags ── */
    .trending-tags-grid {
      display: flex;
      flex-direction: column;
      gap: 2px;
      margin-bottom: 8px;
    }

    .trending-tag-row {
      display: flex;
      align-items: center;
      padding: 10px 14px;
      border-radius: var(--radius);
      cursor: pointer;
      text-decoration: none;
      transition: background var(--trans);
      gap: 12px;
      border-bottom: 1px solid var(--border);
    }

    .trending-tag-row:last-child {
      border-bottom: none;
    }

    .trending-tag-row:hover {
      background: rgba(155, 127, 255, 0.06);
    }

    .trending-tag-rank {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      width: 18px;
      flex-shrink: 0;
      text-align: center;
    }

    .trending-tag-main {
      flex: 1;
      min-width: 0;
    }

    .trending-tag-name {
      font-size: 14px;
      font-weight: 600;
      color: var(--accent2);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .trending-tag-bar-wrap {
      flex: 1;
      min-width: 0;
    }

    .trending-tag-meta {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 3px;
    }

    .trending-tag-stat {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    .trending-tag-sparkline {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 20px;
      flex-shrink: 0;
    }

    .sparkline-bar {
      width: 4px;
      border-radius: 2px 2px 0 0;
      background: var(--accent);
      opacity: 0.5;
      transition: opacity var(--trans);
      min-height: 2px;
    }

    .trending-tag-row:hover .sparkline-bar {
      opacity: 0.85;
    }

    /* ── Trending People ── */
    .trending-people-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      padding-bottom: 8px;
    }

    .trending-person-card {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      text-align: center;
      gap: 8px;
      cursor: pointer;
      transition: border-color var(--trans), background var(--trans);
    }

    .trending-person-card:hover {
      border-color: var(--accent);
      background: rgba(155, 127, 255, 0.05);
    }

    .trending-person-avatar {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: 2px solid var(--border);
      overflow: hidden;
      flex-shrink: 0;
      background: var(--surface);
    }

    .trending-person-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .trending-person-name {
      font-size: 13px;
      font-weight: 600;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .trending-person-acct {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
    }

    .trending-person-stats {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    .trending-person-stat {
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .trending-person-stat-val {
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
    }

    .trending-person-stat-label {
      font-family: var(--font-mono);
      font-size: 10px;
      color: var(--text-dim);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    /* ── Trending Links / News ── */
    .trending-links-list {
      display: flex;
      flex-direction: column;
      gap: 0;
      margin-bottom: 8px;
    }

    .trending-link-card {
      display: flex;
      align-items: flex-start;
      gap: 14px;
      padding: 16px 0;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      text-decoration: none;
      transition: background var(--trans);
    }

    .trending-link-card:last-child {
      border-bottom: none;
    }

    .trending-link-card:hover .trending-link-title {
      color: var(--accent2);
    }

    .trending-link-thumb {
      width: 72px;
      height: 56px;
      border-radius: 6px;
      overflow: hidden;
      flex-shrink: 0;
      background: var(--surface2);
      border: 1px solid var(--border);
    }

    .trending-link-thumb img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .trending-link-thumb-placeholder {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
    }

    .trending-link-body {
      flex: 1;
      min-width: 0;
    }

    .trending-link-provider {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--accent);
      text-transform: uppercase;
      letter-spacing: 0.06em;
      margin-bottom: 4px;
    }

    .trending-link-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
      line-height: 1.4;
      transition: color var(--trans);
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .trending-link-desc {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.5;
      margin-top: 4px;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    .trending-link-stat {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      margin-top: 6px;
    }

    /* Trending sub-tabs */
    .trending-subtabs {
      display: flex;
      padding: 0 20px;
      gap: 0;
      border-bottom: 1px solid var(--border);
      margin-bottom: 4px;
      position: sticky;
      top: 94px;
      z-index: 50;
      background: var(--bg);
    }

    .trending-subtab-btn {
      flex: 1;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-dim);
      cursor: pointer;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      padding: 12px 0 10px;
      text-align: center;
      transition: all var(--trans);
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }

    .trending-subtab-btn:hover {
      color: var(--text-muted);
    }

    .trending-subtab-btn.active {
      color: var(--accent2);
      border-bottom-color: var(--accent);
    }

    .trending-subpanel {
      display: none;
    }

    .trending-subpanel.active {
      display: block;
    }

    .compose-sidebar-body {
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .main-wrapper {
      flex: 1;
      max-width: 680px;
      min-width: 0;
      display: flex;
      flex-direction: column;
    }

    /* Hide compose button in header when sidebar is visible */
    #compose-btn {
      display: none;
    }

    /* Responsive: Hide sidebar on mobile */
    @media (max-width: 900px) {
      .compose-sidebar {
        display: none;
      }

      #compose-btn {
        display: flex;
      }
    }

    @media (max-width: 500px) {
      .main-wrapper {
        max-width: 100%;
      }

      #app-screen {
        padding: 0;
      }
    }

    /* ─── HEADER ─── */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 100;
      background: rgba(13, 13, 15, 0.92);
      backdrop-filter: blur(16px);
      -webkit-backdrop-filter: blur(16px);
      border-bottom: 1px solid var(--border);
    }

    .header-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 0 20px;
      height: 54px;
      max-width: 680px;
      margin: 0 auto;
      width: 100%;
    }

    .header-wordmark {
      font-family: var(--font-display);
      font-size: 22px;
      color: var(--text);
      letter-spacing: -0.5px;
    }

    .header-wordmark span {
      color: var(--accent);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .icon-btn {
      background: none;
      border: 1px solid transparent;
      border-radius: var(--radius);
      color: var(--text-muted);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      transition: all var(--trans);
      flex-shrink: 0;
    }

    .icon-btn:hover {
      background: var(--surface2);
      border-color: var(--border);
      color: var(--text);
    }

    .icon-btn svg {
      pointer-events: none;
    }

    .avatar-btn {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      border: 2px solid var(--border);
      overflow: hidden;
      cursor: pointer;
      transition: border-color var(--trans);
      background: var(--surface2);
      flex-shrink: 0;
    }

    .avatar-btn:hover {
      border-color: var(--accent);
    }

    .avatar-btn img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    /* ─── TABS ─── */
    .tab-bar {
      display: flex;
      max-width: 680px;
      margin: 0 auto;
      width: 100%;
      padding: 0 12px;
    }

    .tab-btn {
      flex: 1;
      background: none;
      border: none;
      border-bottom: 2px solid transparent;
      color: var(--text-dim);
      cursor: pointer;
      font-family: var(--font-body);
      font-size: 13px;
      font-weight: 500;
      letter-spacing: 0.04em;
      padding: 10px 0;
      text-align: center;
      transition: all var(--trans);
      position: relative;
    }

    .tab-btn:hover {
      color: var(--text-muted);
    }

    .tab-btn.active {
      color: var(--accent2);
      border-bottom-color: var(--accent);
    }

    /* ─── FEED AREA ─── */
    .feed-container {
      flex: 1;
      max-width: 680px;
      margin: 0 auto;
      width: 100%;
      padding: 0 0 60px;
      display: flex;
      flex-direction: column;
    }

    /* ─── TAB PANELS ─── */
    .tab-panel {
      display: none;
    }

    .tab-panel.active {
      display: block;
    }

    /* ─── STATUS MESSAGES ─── */
    .feed-status {
      padding: 48px 20px;
      text-align: center;
      color: var(--text-dim);
    }

    .feed-status .status-icon {
      font-size: 32px;
      margin-bottom: 12px;
      opacity: 0.5;
    }

    .feed-status p {
      font-size: 14px;
      font-family: var(--font-mono);
    }

    .feed-status .status-sub {
      font-size: 12px;
      margin-top: 4px;
      color: var(--text-dim);
      opacity: 0.6;
    }

    /* ─── LOADING ─── */
    .feed-loading {
      padding: 40px 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 12px;
    }

    .skeleton-posts {
      width: 100%;
    }

    .skeleton-post {
      border-bottom: 1px solid var(--border);
      padding: 20px 20px;
    }

    .skel-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .skel-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--surface2);
      animation: shimmer 1.5s infinite;
      flex-shrink: 0;
    }

    .skel-meta {
      flex: 1;
    }

    .skel-line {
      height: 10px;
      border-radius: 4px;
      background: var(--surface2);
      animation: shimmer 1.5s infinite;
      margin-bottom: 6px;
    }

    .skel-line.w-60 {
      width: 60%;
    }

    .skel-line.w-40 {
      width: 40%;
    }

    .skel-line.w-80 {
      width: 80%;
    }

    .skel-line.w-90 {
      width: 90%;
    }

    .skel-line.w-70 {
      width: 70%;
    }

    @keyframes shimmer {

      0%,
      100% {
        opacity: 0.5;
      }

      50% {
        opacity: 1;
      }
    }

    /* ─── POST CARD ─── */
    .post {
      border-bottom: 1px solid var(--border);
      border-left: 2px solid var(--border2);
      padding: 18px 20px 18px 18px;
      transition: background var(--trans), border-color var(--trans);
      position: relative;
      cursor: pointer;
    }

    .post:hover {
      background: rgba(255, 255, 255, 0.015);
      border-left-color: var(--text-dim);
    }

    /* Context borders */
    .post.post--hashtag {
      border-left-color: rgba(155, 127, 255, 0.5);
      background: rgba(155, 127, 255, 0.04);
    }

    .post.post--hashtag:hover {
      border-left-color: rgba(155, 127, 255, 0.7);
      background: rgba(155, 127, 255, 0.07);
    }

    .post.post--boost {
      border-left-color: rgba(78, 205, 196, 0.5);
      background: rgba(78, 205, 196, 0.04);
    }

    .post.post--boost:hover {
      border-left-color: rgba(78, 205, 196, 0.7);
      background: rgba(78, 205, 196, 0.07);
    }

    .post.post--reply {
      border-left-color: rgba(136, 136, 160, 0.3);
      background: rgba(136, 136, 160, 0.03);
    }

    .post.post--reply:hover {
      border-left-color: rgba(136, 136, 160, 0.5);
      background: rgba(136, 136, 160, 0.06);
    }

    /* Hashtag banner — sits above post header */
    .post-hashtag-banner {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-bottom: 10px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--accent);
    }

    .post-hashtag-banner svg {
      opacity: 0.7;
      flex-shrink: 0;
    }

    .post-hashtag-banner-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .post-hashtag-banner-tag {
      color: var(--accent2);
      font-weight: 500;
      text-decoration: none;
      transition: color var(--trans);
    }

    .post-hashtag-banner-tag:hover {
      color: var(--accent);
    }

    .post-hashtag-banner-tag+.post-hashtag-banner-tag::before {
      content: '·';
      margin-right: 4px;
      color: var(--text-dim);
    }

    .boost-divider {
      display: flex;
      align-items: center;
      justify-content: flex-start;
      gap: 12px;
      margin-bottom: 16px;
      color: var(--text-dim);
    }

    .boost-divider-line {
      flex: 1;
      height: 1px;
      background: var(--border);
      opacity: 0.6;
    }

    .boost-divider-arrow {
      color: var(--border);
      opacity: 0.6;
      flex-shrink: 0;
    }

    .boost-text {
      display: flex;
      align-items: center;
      gap: 6px;
      color: var(--text-muted);
      font-size: 12px;
      font-family: var(--font-mono);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .boost-text svg {
      color: var(--boost);
      margin-right: 2px;
    }

    .boost-text .post-display-name {
      text-transform: none;
      font-family: var(--font-body);
      font-size: 13.5px;
      letter-spacing: 0;
      color: var(--text);
      font-weight: 600;
      cursor: pointer;
      text-decoration: none;
    }

    /* Post header */
    .post-header {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-bottom: 10px;
    }

    .post-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      border: 1px solid var(--border);
      overflow: hidden;
      flex-shrink: 0;
      background: var(--surface2);
      cursor: pointer;
      transition: border-color var(--trans);
    }

    .post-avatar:hover {
      border-color: var(--accent);
    }

    .post-avatar img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .post-meta {
      flex: 1;
      min-width: 0;
    }

    .post-author {
      display: flex;
      align-items: baseline;
      gap: 6px;
      flex-wrap: wrap;
    }

    .post-display-name {
      font-weight: 500;
      font-size: 14px;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      cursor: pointer;
    }

    .post-display-name:hover {
      color: var(--accent2);
    }

    .post-acct {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .post-time {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      white-space: nowrap;
      margin-left: auto;
      padding-left: 8px;
    }

    /* Post content */
    .post-content {
      font-size: 14.5px;
      line-height: 1.65;
      color: var(--text);
      word-break: break-word;
      overflow-wrap: anywhere;
    }

    .post-content p {
      margin-bottom: 8px;
    }

    .post-content p:last-child {
      margin-bottom: 0;
    }

    .post-content a {
      color: var(--accent2);
      text-decoration: none;
    }

    .post-content a:hover {
      text-decoration: underline;
    }

    .post-content .hashtag {
      color: var(--accent);
    }

    .post-content .mention {
      color: var(--teal);
    }

    /* Content warning */
    .cw-wrapper {
      background: rgba(255, 107, 107, 0.06);
      border-left: 3px solid var(--danger);
      padding: 10px 12px;
      border-radius: 0 var(--radius) var(--radius) 0;
      margin: 8px 0;
    }

    .cw-summary {
      display: flex;
      align-items: center;
      gap: 10px;
      color: var(--text);
      font-size: 14px;
      font-weight: 500;
    }

    .cw-summary span:first-child {
      flex: 1;
      overflow-wrap: anywhere;
    }

    .cw-toggle {
      background: var(--surface2);
      border: 1px solid var(--danger);
      border-radius: 4px;
      color: var(--text);
      cursor: pointer;
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 600;
      padding: 5px 12px;
      margin-left: auto;
      transition: all var(--trans);
      white-space: nowrap;
    }

    .cw-toggle:hover {
      background: var(--danger);
      color: #fff;
    }

    .cw-body {
      display: none;
      margin-top: 10px;
    }

    .cw-body.expanded {
      display: block;
    }

    /* Media attachments */
    .post-media {
      margin-top: 12px;
      border-radius: var(--radius);
      overflow: hidden;
      border: 1px solid var(--border);
    }

    .post-media-grid {
      display: grid;
      gap: 2px;
    }

    .post-media-grid.count-1 {
      grid-template-columns: 1fr;
    }

    .post-media-grid.count-2 {
      grid-template-columns: 1fr 1fr;
    }

    .post-media-grid.count-3 {
      grid-template-columns: 2fr 1fr;
    }

    .post-media-grid.count-4 {
      grid-template-columns: 1fr 1fr;
    }

    .media-item {
      overflow: hidden;
      position: relative;
      background: transparent;
      cursor: pointer;
      transition: transform var(--trans);
    }

    .media-item:hover {
      transform: scale(1.02);
    }

    .count-1 .media-item {
      max-height: 500px;
      height: auto;
      min-height: 200px;
      display: flex;
      justify-content: flex-start;
      align-items: flex-start;
    }

    .count-1 .media-item img.vertical-image,
    .count-1 .media-item video.vertical-image {
      object-position: 0 0;
    }

    .count-1 .media-item img.horizontal-image,
    .count-1 .media-item video.horizontal-image {
      object-position: center center;
    }

    .count-2 .media-item,
    .count-4 .media-item {
      height: 200px;
    }

    .count-3 .media-item {
      height: 200px;
    }

    .count-3 .media-item:first-child {
      height: 300px;
    }

    .media-item img,
    .media-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
      display: block;
      transition: object-fit var(--trans);
    }

    /* Lightbox */
    .lightbox-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.95);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      z-index: 3000;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: zoom-out;
      opacity: 0;
      transition: opacity 200ms ease;
      padding: 20px;
    }

    .lightbox-overlay.open {
      opacity: 1;
    }

    .lightbox-content {
      position: relative;
      max-width: 100%;
      max-height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      transform: scale(0.96);
      transition: transform 250ms cubic-bezier(0.16, 1, 0.3, 1);
      cursor: default;
    }

    .lightbox-overlay.open .lightbox-content {
      transform: scale(1);
    }

    .lightbox-content img,
    .lightbox-content video {
      display: block;
      max-width: 100%;
      max-height: calc(100vh - 40px);
      width: auto;
      height: auto;
      border-radius: 4px;
      box-shadow: 0 30px 90px rgba(0, 0, 0, 0.8);
      background: var(--bg);
    }

    .lightbox-close {
      position: absolute;
      top: 24px;
      right: 24px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.1);
      color: white;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
      z-index: 3100;
    }

    .lightbox-close:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: rotate(90deg);
    }

    .media-sensitive-blur {
      filter: blur(20px);
    }

    .sensitive-overlay {
      position: absolute;
      inset: 0;
      background: rgba(13, 13, 15, 0.6);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      gap: 6px;
      cursor: pointer;
      transition: opacity var(--trans);
    }

    .sensitive-overlay:hover {
      opacity: 0.8;
    }

    .sensitive-overlay span {
      color: var(--text-muted);
      font-size: 12px;
      font-family: var(--font-mono);
    }

    /* Hide Mastodon's native fallback quote inline text */
    .quote-inline {
      display: none !important;
    }

    /* Quote */
    .post-quote {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 14px;
      background: var(--surface2);
      cursor: pointer;
      transition: border-color var(--trans), background var(--trans);
    }

    .post-quote:hover {
      border-color: var(--text-dim);
      background: rgba(255, 255, 255, 0.02);
    }

    /* Poll */
    .post-poll {
      margin-top: 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .poll-option {
      padding: 10px 14px;
      border-bottom: 1px solid var(--border);
      position: relative;
      font-size: 13px;
      overflow: hidden;
    }

    .poll-option:last-child {
      border-bottom: none;
    }

    .poll-bar {
      position: absolute;
      inset: 0 auto 0 0;
      background: rgba(155, 127, 255, 0.1);
      transition: width 0.5s ease;
    }

    .poll-option-text {
      position: relative;
      z-index: 1;
    }

    .poll-pct {
      float: right;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-muted);
    }

    .poll-meta {
      padding: 8px 14px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      background: var(--surface);
    }

    /* Post footer */
    .post-footer {
      display: flex;
      align-items: center;
      gap: 16px;
      margin-top: 12px;
    }

    .post-stat {
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
    }

    .post-stat svg {
      opacity: 0.6;
    }

    .post-reply-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: all var(--trans);
    }

    .post-reply-btn:hover {
      color: var(--teal);
    }

    .post-reply-btn:hover svg {
      opacity: 1;
    }

    .post-boost-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: all var(--trans);
      position: relative;
    }

    .post-boost-btn:hover,
    .post-boost-btn.boosted {
      color: var(--boost);
    }

    .post-boost-btn:hover svg,
    .post-boost-btn.boosted svg {
      opacity: 1;
    }

    .boost-dropdown {
      position: absolute;
      bottom: calc(100% + 4px);
      left: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 6px 0;
      display: none;
      flex-direction: column;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
      z-index: 100;
      min-width: 140px;
    }

    .boost-dropdown.show {
      display: flex;
    }

    .boost-dropdown-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 10px 14px;
      color: var(--text);
      font-family: var(--font-body);
      font-size: 13.5px;
      font-weight: 500;
      cursor: pointer;
      background: none;
      border: none;
      width: 100%;
      text-align: left;
      transition: background var(--trans);
    }

    .boost-dropdown-item:hover {
      background: var(--surface2);
    }

    .post-fav-btn {
      background: none;
      border: none;
      padding: 0;
      cursor: pointer;
      transition: all var(--trans);
    }

    .post-fav-btn:hover {
      color: var(--fav);
    }

    .post-fav-btn:hover svg {
      opacity: 1;
      transform: scale(1.1);
    }

    .post-fav-btn.favourited {
      color: var(--fav);
    }

    .post-fav-btn.favourited svg {
      opacity: 1;
    }

    .post-fav-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Star favorite animation */
    @keyframes starFavorite {
      0% {
        transform: scale(1) rotate(0deg);
      }

      50% {
        transform: scale(1.3) rotate(72deg);
      }

      100% {
        transform: scale(1) rotate(144deg);
      }
    }

    /* Star unfavorite animation (reverse) */
    @keyframes starUnfavorite {
      0% {
        transform: scale(1) rotate(144deg);
      }

      50% {
        transform: scale(1.3) rotate(72deg);
      }

      100% {
        transform: scale(1) rotate(0deg);
      }
    }

    .post-fav-btn.favoriting svg {
      animation: starFavorite 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    .post-fav-btn.favoriting,
    .post-fav-btn.unfavoriting {
      color: var(--fav);
    }

    .post-fav-btn.favoriting svg,
    .post-fav-btn.unfavoriting svg {
      opacity: 1;
    }

    .post-fav-btn.unfavoriting svg {
      animation: starUnfavorite 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
    }

    @keyframes fadeOut {
      0% {
        opacity: 1;
        color: var(--fav);
      }

      100% {
        opacity: 0.5;
        color: inherit;
      }
    }

    .post-fav-btn.unfavorite-fade svg {
      animation: fadeOut 0.3s ease-out forwards;
    }

    /* Hashtag section header */
    .section-header {
      padding: 16px 20px 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .section-header-tag {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--accent);
      font-weight: 500;
    }

    .section-header-line {
      flex: 1;
      height: 1px;
      background: var(--border);
    }

    .section-header-count {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
    }

    /* ─── TOAST ─── */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%) translateY(12px);
      background: var(--surface2);
      border: 1px solid var(--border2);
      border-radius: var(--radius);
      padding: 10px 18px;
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text);
      opacity: 0;
      pointer-events: none;
      transition: all 250ms ease;
      z-index: 9999;
      white-space: nowrap;
    }

    .toast.show {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ─── ERROR BANNER ─── */
    .error-banner {
      background: rgba(255, 107, 107, 0.1);
      border: 1px solid rgba(255, 107, 107, 0.25);
      border-radius: var(--radius);
      color: var(--danger);
      font-family: var(--font-mono);
      font-size: 12px;
      margin: 16px 20px;
      padding: 10px 14px;
      display: none;
    }

    .error-banner.visible {
      display: block;
    }

    /* ─── LOAD MORE ─── */
    .load-more-btn {
      display: block;
      width: calc(100% - 40px);
      margin: 20px auto;
      padding: 12px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 12px;
      cursor: pointer;
      text-align: center;
      transition: all var(--trans);
    }

    .load-more-btn:hover {
      border-color: var(--accent);
      color: var(--accent2);
    }

    /* ─── PROFILE DRAWER ─── */
    .profile-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 200;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
    }

    .profile-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    .profile-drawer {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(420px, 100%);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 201;
      transform: translateX(100%);
      transition: transform 260ms cubic-bezier(0.4, 0, 0.2, 1);
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .profile-drawer.open {
      transform: translateX(0);
    }

    @media (max-width: 900px) {
      .profile-drawer {
        width: 100%;
        /* full screen on mobile */
        border-left: none;
        /* no border that adds 1px overflow */
      }
    }

    .profile-drawer-inner {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      position: relative;
    }

    .profile-close {
      position: absolute;
      top: 14px;
      right: 14px;
      z-index: 10;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--trans);
    }

    .profile-close:hover {
      border-color: var(--border2);
      color: var(--text);
    }

    .profile-loading {
      display: flex;
      align-items: center;
      justify-content: center;
      height: 200px;
    }

    /* Profile header */
    .profile-header-img {
      width: 100%;
      height: 120px;
      object-fit: cover;
      display: block;
      background: var(--surface2);
    }

    .profile-header-img.empty {
      background: linear-gradient(135deg, var(--surface2) 0%, var(--border) 100%);
    }

    .profile-identity {
      padding: 0 20px 16px;
      border-bottom: 1px solid var(--border);
      position: relative;
    }

    .profile-avatar-wrap {
      margin-top: -28px;
      margin-bottom: 10px;
    }

    .profile-avatar-large {
      width: 56px;
      height: 56px;
      border-radius: 50%;
      border: 3px solid var(--surface);
      background: var(--surface2);
      object-fit: cover;
    }

    .profile-display-name {
      font-size: 17px;
      font-weight: 500;
      color: var(--text);
      line-height: 1.2;
    }

    .profile-acct {
      font-family: var(--font-mono);
      font-size: 12px;
      color: var(--text-dim);
      margin-top: 2px;
    }

    .profile-name-row {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: 12px;
    }

    .profile-follow-btn {
      flex-shrink: 0;
      background: var(--accent);
      border: 1px solid var(--accent);
      border-radius: 6px;
      color: var(--bg);
      font-family: var(--font-sans);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 16px;
      cursor: pointer;
      transition: all var(--trans);
      margin-top: 2px;
    }

    .profile-follow-btn:hover {
      background: var(--accent2);
      border-color: var(--accent2);
    }

    .profile-follow-btn.following {
      background: transparent;
      border-color: var(--border2);
      color: var(--text-muted);
    }

    .profile-follow-btn.following:hover {
      background: rgba(255, 107, 107, 0.1);
      border-color: rgba(255, 107, 107, 0.4);
      color: #ff8080;
    }

    .profile-follow-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .profile-edit-btn {
      flex-shrink: 0;
      background: transparent;
      border: 1px solid var(--border2);
      border-radius: 6px;
      color: var(--text-muted);
      font-family: var(--font-body);
      font-size: 12px;
      font-weight: 500;
      padding: 6px 16px;
      cursor: pointer;
      transition: all var(--trans);
      margin-top: 2px;
      text-decoration: none;
      display: inline-block;
    }

    .profile-edit-btn:hover {
      background: var(--surface2);
      border-color: var(--accent);
      color: var(--accent2);
    }

    .profile-bio {
      font-size: 13.5px;
      line-height: 1.6;
      color: var(--text-muted);
      margin-top: 10px;
    }

    .profile-bio a {
      color: var(--accent2);
      text-decoration: none;
    }

    .profile-bio a:hover {
      text-decoration: underline;
    }

    .profile-stats {
      display: flex;
      gap: 20px;
      margin-top: 12px;
    }

    .profile-stat {
      display: flex;
      flex-direction: column;
      gap: 1px;
    }

    .profile-stat-num {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 500;
      color: var(--text);
    }

    .profile-stat-label {
      font-size: 11px;
      color: var(--text-dim);
    }

    /* Profile fields & join date */
    .profile-fields {
      display: flex;
      flex-direction: column;
      gap: 1px;
      margin-top: 14px;
      background: var(--border);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
    }

    .profile-field {
      display: flex;
      flex-direction: column;
      padding: 8px 12px;
      background: var(--surface);
      gap: 1px;
      position: relative;
    }

    .profile-field.verified {
      background: rgba(78, 205, 196, 0.04);
    }

    .profile-field-name {
      font-family: var(--font-mono);
      font-size: 10px;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-dim);
    }

    .profile-field-value {
      font-size: 13px;
      color: var(--text-muted);
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .profile-field-value a {
      color: var(--accent2);
      text-decoration: none;
    }

    .profile-field.verified .profile-field-name {
      color: var(--teal);
    }

    .profile-field.verified .verified-icon {
      position: absolute;
      top: 10px;
      right: 12px;
      color: var(--teal);
    }

    .profile-joined {
      display: flex;
      align-items: center;
      gap: 6px;
      margin-top: 12px;
      font-size: 12px;
      color: var(--text-dim);
      font-family: var(--font-mono);
    }

    .profile-joined svg {
      opacity: 0.6;
    }

    .profile-open-link {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      margin-top: 12px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      text-decoration: none;
      border: 1px solid var(--border);
      border-radius: 4px;
      padding: 4px 9px;
      transition: all var(--trans);
    }

    .profile-open-link:hover {
      border-color: var(--accent);
      color: var(--accent2);
    }

    /* Profile posts section */
    .profile-posts-header {
      padding: 12px 20px 8px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border);
    }

    /* Profile posts reuse .post styles but need tighter padding */
    .profile-drawer-inner .post {
      padding: 14px 20px;
    }

    /* ─── PINNED POSTS ─── */
    .pinned-section {
      border-bottom: 1px solid var(--border);
    }

    /* Header row — label on left, nav controls on right */
    .pinned-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 10px 16px 10px 20px;
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--accent);
      letter-spacing: 0.06em;
      text-transform: uppercase;
      border-bottom: 1px solid var(--border2);
    }

    .pinned-header-label {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .pinned-header-label svg {
      opacity: 0.8;
      flex-shrink: 0;
    }

    /* Nav controls in header */
    .pinned-header-nav {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .pinned-nav {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 4px;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--trans);
    }

    .pinned-nav:hover {
      background: var(--surface2);
      color: var(--accent2);
      border-color: var(--accent);
    }

    .pinned-counter {
      font-family: var(--font-mono);
      font-size: 11px;
      color: var(--text-dim);
      min-width: 28px;
      text-align: center;
    }

    /* Single pinned post — no nav chrome */
    .pinned-single .post {
      padding: 14px 20px;
      border-bottom: none;
    }

    /* Slide show/hide with fade */
    .pinned-slide {
      display: none;
    }

    .pinned-slide.active {
      display: block;
      animation: pinnedFadeIn 180ms ease;
    }

    @keyframes pinnedFadeIn {
      from {
        opacity: 0;
        transform: translateY(4px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .pinned-slide .post {
      padding: 14px 20px;
      border-bottom: none;
    }

    /* Dot position indicators */
    .pinned-dots {
      display: flex;
      justify-content: center;
      gap: 5px;
      padding: 8px 0 10px;
    }

    .pinned-dot {
      width: 5px;
      height: 5px;
      border-radius: 50%;
      background: var(--border2);
      border: none;
      cursor: pointer;
      padding: 0;
      transition: background var(--trans), transform var(--trans);
    }

    .pinned-dot.active {
      background: var(--accent);
      transform: scale(1.3);
    }

    /* ─── COMPOSE DRAWER ─── */
    .compose-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.6);
      z-index: 1001;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
    }

    .compose-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    /* OPTION 1: Bottom Slide-Up (Current) */
    .compose-drawer.layout-bottom {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-height: 80vh;
      background: var(--surface);
      border-top: 1px solid var(--border);
      z-index: 1002;
      transform: translateY(100%);
      transition: transform 280ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }

    .compose-drawer.layout-bottom.open {
      transform: translateY(0);
      pointer-events: auto;
    }

    /* OPTION 2: Center Modal */
    .compose-drawer.layout-center {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) scale(0.9);
      width: min(600px, 90vw);
      max-height: 85vh;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      z-index: 1002;
      opacity: 0;
      transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: 0 20px 40px rgba(0, 0, 0, 0.5);
      pointer-events: none;
    }

    .compose-drawer.layout-center.open {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
    }

    /* OPTION 3: Right Sidebar */
    .compose-drawer.layout-right {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(480px, 100%);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 1002;
      transform: translateX(100%);
      transition: transform 280ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }

    .compose-drawer.layout-right.open {
      transform: translateX(0);
      pointer-events: auto;
    }

    /* OPTION 4: Top Bar */
    .compose-drawer.layout-top {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      max-height: 70vh;
      background: var(--surface);
      border-bottom: 1px solid var(--border);
      z-index: 1002;
      transform: translateY(-100%);
      transition: transform 280ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      pointer-events: none;
    }

    .compose-drawer.layout-top.open {
      transform: translateY(0);
      pointer-events: auto;
    }


    /* OPTION 5: Compact Floating */
    .compose-drawer.layout-float {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: min(420px, calc(100% - 40px));
      max-height: 500px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: 12px;
      z-index: 1002;
      transform: translateY(20px);
      opacity: 0;
      transition: all 250ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.4);
      pointer-events: none;
    }

    .compose-drawer.layout-float.open {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }

    /* ─── MOBILE COMPOSE: full-screen, anchored to top, keyboard folds under ─── */
    @media (max-width: 900px) {

      /* Override any desktop layout variant on mobile */
      .compose-drawer.layout-float,
      .compose-drawer.layout-bottom,
      .compose-drawer.layout-center,
      .compose-drawer.layout-right,
      .compose-drawer.layout-top {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: auto;
        width: 100%;
        /* 100dvh = visual viewport — shrinks as keyboard rises */
        height: 100dvh;
        max-height: 100dvh;
        border-radius: 0;
        border: none;
        border-bottom: 1px solid var(--border);
        box-shadow: 0 4px 24px rgba(0, 0, 0, 0.5);
        transform: translateY(-100%);
        opacity: 1;
        transition: transform 280ms cubic-bezier(0.4, 0, 0.2, 1);
        pointer-events: none;
        display: flex;
        flex-direction: column;
        overflow: hidden;
      }

      .compose-drawer.layout-float.open,
      .compose-drawer.layout-bottom.open,
      .compose-drawer.layout-center.open,
      .compose-drawer.layout-right.open,
      .compose-drawer.layout-top.open {
        transform: translateY(0);
        pointer-events: auto;
      }

      /* Inner scroll so long posts don't overflow */
      .compose-drawer .compose-body {
        flex: 1;
        overflow-y: auto;
        -webkit-overflow-scrolling: touch;
      }

      /* Let textarea grow freely within the scrollable area */
      .compose-drawer .compose-textarea {
        min-height: 100px;
        max-height: none;
      }
    }

    /* Common drawer styles */
    .compose-drawer {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .compose-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 20px;
      border-bottom: 1px solid var(--border);
    }

    .compose-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
    }

    .compose-close {
      background: transparent;
      border: none;
      width: 28px;
      height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 4px;
      transition: all var(--trans);
    }

    .compose-close:hover {
      background: var(--surface2);
      color: var(--text);
    }

    .compose-body {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow-y: auto;
      padding: 20px;
      gap: 12px;
    }

    .compose-cw-section {
      animation: slideDown 200ms ease;
    }

    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-10px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .compose-cw-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px 12px;
      font-size: 14px;
      color: var(--text);
      font-family: var(--font-sans);
    }

    .compose-cw-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    .compose-textarea {
      width: 100%;
      min-height: 120px;
      max-height: 300px;
      background: transparent;
      border: none;
      font-size: 15px;
      color: var(--text);
      font-family: var(--font-sans);
      resize: none;
      line-height: 1.5;
      overflow-y: auto;
    }

    .compose-textarea:focus {
      outline: none;
    }

    .compose-textarea[placeholder]:empty::before {
      content: attr(placeholder);
      color: var(--text-dim);
      pointer-events: none;
      display: block;
    }

    .compose-custom-emoji {
      height: 1.4em;
      vertical-align: middle;
      display: inline-block;
      margin: 0 2px;
      user-select: all;
    }

    .custom-emoji {
      height: 1.25em;
      width: auto;
      vertical-align: top;
      display: inline-block;
      margin: 0 1px;
    }

    .compose-media-preview {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 8px;
    }

    .compose-media-item-alt-btn {
      position: absolute;
      bottom: 6px;
      left: 6px;
      background: rgba(0, 0, 0, 0.65);
      backdrop-filter: blur(4px);
      -webkit-backdrop-filter: blur(4px);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 4px;
      color: #fff;
      font-size: 11px;
      font-weight: 500;
      padding: 3px 6px;
      cursor: pointer;
      z-index: 5;
    }

    .compose-media-item-alt-btn.missing {
      background: rgba(255, 107, 107, 0.9);
      border-color: #ff6b6b;
    }

    .compose-media-item-alt-btn:hover {
      background: rgba(0, 0, 0, 0.85);
    }

    .compose-media-item-alt-btn.missing:hover {
      background: #ff6b6b;
    }

    .compose-media-item {
      position: relative;
      aspect-ratio: 1;
      border-radius: 8px;
      overflow: hidden;
      background: var(--surface2);
    }

    .compose-media-item img,
    .compose-media-item video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .compose-media-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      background: rgba(0, 0, 0, 0.7);
      border: none;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      cursor: pointer;
      transition: all var(--trans);
    }

    .compose-media-remove:hover {
      background: rgba(0, 0, 0, 0.9);
    }

    .compose-toolbar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
      border-top: 1px solid var(--border);
    }

    .compose-toolbar-left {
      display: flex;
      gap: 4px;
    }

    .compose-tool-btn {
      background: transparent;
      border: none;
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-dim);
      cursor: pointer;
      border-radius: 6px;
      transition: all var(--trans);
    }

    .compose-tool-btn:hover {
      background: var(--surface2);
      color: var(--accent2);
    }

    .compose-tool-btn.active {
      background: rgba(155, 127, 255, 0.15);
      color: var(--accent2);
    }



    .hashtag-filter-bar {
      margin-bottom: 24px;
      padding-top: 24px;
      display: flex;
      justify-content: flex-start;
    }

    .hashtag-filter-select {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 32px 8px 12px;
      font-size: 13px;
      color: var(--text);
      font-family: var(--font-body);
      font-weight: 500;
      cursor: pointer;
      appearance: none;
      -webkit-appearance: none;
      background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%239C9C9C%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
      background-repeat: no-repeat;
      background-position: right 12px top 50%;
      background-size: 10px auto;
      transition: border-color var(--trans);
      color-scheme: dark;
    }

    .hashtag-filter-select option {
      background-color: #1c1c22;
      color: #e8e8f0;
    }

    .hashtag-filter-select option:checked {
      background-color: #2a2a34;
    }

    .hashtag-filter-select:focus {
      outline: none;
      border-color: var(--accent);
    }

    .hashtag-search-wrap {
      position: relative;
      flex: 1;
      min-width: 200px;
    }

    .hashtag-search-input {
      width: 100%;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px 8px 32px;
      font-size: 13px;
      color: var(--text);
      font-family: var(--font-body);
      transition: border-color var(--trans);
    }

    .hashtag-search-input:focus {
      outline: none;
      border-color: var(--accent);
      background: var(--surface);
    }

    .compose-footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding-top: 12px;
    }

    .compose-char-count {
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-dim);
      transition: color var(--trans);
    }

    .compose-char-count.warning {
      color: #ffb86c;
    }

    .compose-char-count.error {
      color: var(--danger);
    }

    .compose-post-btn {
      background: var(--accent);
      border: none;
      border-radius: 6px;
      padding: 8px 24px;
      font-size: 14px;
      font-weight: 500;
      color: var(--bg);
      cursor: pointer;
      transition: all var(--trans);
    }

    .compose-post-btn:hover:not(:disabled) {
      background: var(--accent2);
    }

    .compose-post-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* ─── EMOJI PICKER ─── */
    .emoji-picker {
      position: fixed;
      z-index: 1000;
      width: 300px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-lg);
      box-shadow: 0 12px 32px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      overflow: hidden;
    }

    .emoji-picker-header {
      padding: 10px;
      border-bottom: 1px solid var(--border);
      background: var(--surface2);
    }

    .emoji-picker-search {
      width: 100%;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 8px 12px;
      color: var(--text);
      font-size: 13px;
      font-family: var(--font-body);
    }

    .emoji-picker-search:focus {
      outline: none;
      border-color: var(--accent);
    }

    .emoji-picker-body {
      max-height: 220px;
      overflow-y: auto;
      padding: 10px;
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      gap: 4px;
    }

    .emoji-category-title {
      grid-column: 1 / -1;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-dim);
      padding: 8px 4px 2px;
      margin-top: 4px;
    }

    .emoji-btn {
      background: none;
      border: none;
      font-size: 22px;
      cursor: pointer;
      border-radius: 4px;
      padding: 4px;
      transition: background var(--trans);
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .emoji-btn:hover {
      background: var(--surface2);
    }

    /* ─── MENTION AUTOCOMPLETE ─── */
    .mention-suggestions {
      position: fixed;
      z-index: 2000;
      width: 280px;
      max-height: 300px;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.5);
      display: none;
      flex-direction: column;
      overflow-y: auto;
    }

    .mention-item {
      display: flex;
      align-items: center;
      padding: 10px 12px;
      gap: 12px;
      cursor: pointer;
      transition: background var(--trans);
      border-bottom: 1px solid var(--border);
    }

    .mention-item:last-child {
      border-bottom: none;
    }

    .mention-item:hover,
    .mention-item.selected {
      background: var(--surface2);
    }

    .mention-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      flex-shrink: 0;
    }

    .mention-info {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .mention-name {
      font-size: 13px;
      font-weight: 500;
      color: var(--text);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .mention-acct {
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    /* ─── RESPONSIVE ─── */
    @media (max-width: 500px) {
      .header-wordmark {
        font-size: 18px;
      }

      .post {
        padding: 16px 14px 16px 12px;
      }



      .section-header {
        padding: 14px 14px 8px;
      }

      .post-content {
        font-size: 14px;
      }

      .login-form-box {
        padding: 24px 20px;
      }
    }

    /* ─── OFFLINE / CONNECTION NOTICE ─── */
    .offline-bar {
      background: rgba(255, 107, 107, 0.12);
      border-bottom: 1px solid rgba(255, 107, 107, 0.2);
      color: var(--danger);
      font-family: var(--font-mono);
      font-size: 12px;
      padding: 8px 20px;
      text-align: center;
      display: none;
    }

    .offline-bar.visible {
      display: block;
    }

    /* ─── DEMO NOTICE ─── */
    .demo-notice {
      background: rgba(155, 127, 255, 0.08);
      border-bottom: 1px solid rgba(155, 127, 255, 0.15);
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 11px;
      padding: 6px 20px;
      text-align: center;
    }
  </style>

  <style>
    /* ═══════════════════════════════════════════════
       THREAD DRAWER
    ══════════════════════════════════════════════════ */

    /* Backdrop — mobile/overlay mode only */
    .thread-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 300;
      opacity: 0;
      pointer-events: none;
      transition: opacity 220ms ease;
    }

    .thread-backdrop.open {
      opacity: 1;
      pointer-events: all;
    }

    /* ── Drawer (mobile: slide-in overlay) ── */
    .thread-drawer {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: min(600px, 100%);
      background: var(--surface);
      border-left: 1px solid var(--border);
      z-index: 301;
      transform: translateX(100%);
      transition: transform 260ms cubic-bezier(0.4, 0, 0.2, 1);
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .thread-drawer.open {
      transform: translateX(0);
    }

    @media (max-width: 900px) {
      .thread-drawer {
        width: 100%;
        border-left: none;
      }
    }

    /* ── Desktop inline mode ──
       On desktop (≥901px), the thread replaces the feed column
       instead of floating over it. The drawer becomes invisible,
       and a dedicated inline panel inside .main-wrapper takes over.
    */
    @media (min-width: 901px) {

      /* When thread is active on desktop, hide the drawer */
      body.thread-inline-active .thread-drawer {
        display: none;
      }

      body.thread-inline-active .thread-backdrop {
        display: none;
      }

      /* Show the inline thread panel */
      body.thread-inline-active .thread-inline-panel {
        display: flex;
      }

      /* Hide normal tab-bar */
      body.thread-inline-active .tab-bar {
        display: none;
      }

      /* Hide the tab panels inside feed-container (NOT the container itself,
         since thread-inline-panel also lives there) */
      body.thread-inline-active .feed-container>.tab-panel {
        display: none !important;
      }
    }

    /* Inline thread panel (desktop) */
    .thread-inline-panel {
      display: none;
      flex-direction: column;
      flex: 1;
      overflow: hidden;
      background: var(--surface);
    }

    /* Back bar that replaces the tab-bar on desktop */
    .thread-back-bar {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 20px;
      height: 48px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .thread-back-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: var(--accent);
      font-family: var(--font-body);
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      padding: 6px 10px 6px 6px;
      border-radius: 6px;
      transition: background var(--trans), color var(--trans);
    }

    .thread-back-btn:hover {
      background: rgba(155, 127, 255, 0.1);
      color: var(--accent2);
    }

    .thread-back-btn svg {
      flex-shrink: 0;
    }

    .thread-back-bar-title {
      font-size: 14px;
      font-weight: 500;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    /* Scrollable area inside inline panel */
    .thread-inline-inner {
      flex: 1;
      min-height: 0;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* In inline mode: thread panel fills available vertical space */
    @media (min-width: 901px) {
      body.thread-inline-active .feed-container {
        padding-bottom: 0;
        overflow: hidden;
      }

      /* Give the inline panel a viewport-relative height so it scrolls internally */
      body.thread-inline-active .thread-inline-panel {
        height: calc(100svh - 97px);
        /* header-top(54px) + tab-bar(43px) */
        max-height: calc(100svh - 97px);
      }
    }

    /* ── Close button (top-right corner, absolute, both modes) ── */
    .thread-drawer-header {
      position: relative;
      padding: 14px 50px 14px 18px;
      /* room for abs close btn */
      border-bottom: 1px solid var(--border);
      flex-shrink: 0;
      background: var(--surface);
      min-height: 52px;
      display: flex;
      align-items: center;
    }

    .thread-drawer-title {
      font-size: 15px;
      font-weight: 500;
      color: var(--text);
    }

    /* Close button — positioned top-right like media viewer */
    .thread-close-btn {
      position: absolute;
      top: 11px;
      right: 12px;
      background: var(--surface2);
      border: 1px solid var(--border);
      border-radius: 50%;
      width: 30px;
      height: 30px;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-muted);
      cursor: pointer;
      transition: all var(--trans);
      flex-shrink: 0;
      z-index: 10;
    }

    .thread-close-btn:hover {
      border-color: var(--border2);
      color: var(--text);
      background: var(--surface);
    }

    /* Scroll area (drawer/mobile mode) */
    .thread-drawer-inner {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
    }

    /* Loading & error states */
    .thread-status {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 60px 24px;
      flex-direction: column;
      gap: 12px;
      color: var(--text-muted);
      font-family: var(--font-mono);
      font-size: 13px;
    }

    /* ── Thread Post Variants ── */

    /* Shared wrapper for all thread post types */
    .thread-post-ancestor,
    .thread-post-focal,
    .thread-post-reply {
      position: relative;
    }

    /* Ancestor posts — vertical line on left edge threads them together */
    .thread-post-ancestor {
      border-bottom: none;
    }

    .thread-post-ancestor::after {
      content: '';
      position: absolute;
      left: 36px;
      /* avatar left edge + half avatar width */
      bottom: 0;
      width: 2px;
      height: 12px;
      background: var(--border2);
      pointer-events: none;
      z-index: 2;
    }

    /* Focal (clicked) post */
    .thread-post-focal {
      background: rgba(155, 127, 255, 0.07);
      border-left: 3px solid var(--accent);
      border-bottom: 1px solid var(--border);
    }

    .thread-post-focal .post {
      padding-left: 15px;
    }

    /* Reply posts */
    .thread-post-reply {
      border-bottom: 1px solid var(--border);
    }

    /* "Replying to" pill shown above each reply */
    .thread-reply-to {
      display: flex;
      align-items: center;
      gap: 5px;
      font-size: 11px;
      font-family: var(--font-mono);
      color: var(--text-dim);
      padding: 8px 18px 0;
    }

    .thread-reply-to-acct {
      color: var(--accent2);
      font-weight: 500;
    }

    /* Indent children of a single direct-reply chain (depth 2+) */
    .thread-reply-children {
      border-left: 2px solid var(--border);
      margin-left: 36px;
    }

    /* Posts inside the thread drawer lose their own left border */
    .thread-drawer-inner .post,
    .thread-inline-inner .post {
      border-radius: 0;
      border-left: none;
      border-right: none;
      border-top: none;
      border-bottom: none;
      cursor: default !important;
    }

    .thread-post-focal .post {
      background: transparent;
    }

    /* Section labels */
    .thread-section-label {
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--text-dim);
      padding: 12px 18px 6px;
      border-bottom: 1px solid var(--border);
    }

    /* Focal post separator */
    .thread-focal-label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-family: var(--font-mono);
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 0.1em;
      text-transform: uppercase;
      color: var(--accent);
      padding: 10px 18px 6px;
      border-bottom: 1px solid var(--border);
    }

    .thread-focal-label::before {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--accent);
      opacity: 0.2;
    }

    .thread-focal-label::after {
      content: '';
      flex: 1;
      height: 1px;
      background: var(--accent);
      opacity: 0.2;
    }

    /* "Show N more replies" collapsed branch button */
    .thread-show-more-btn {
      display: flex;
      align-items: center;
      gap: 6px;
      background: none;
      border: none;
      color: var(--accent);
      font-family: var(--font-mono);
      font-size: 11px;
      cursor: pointer;
      padding: 8px 18px;
      transition: color var(--trans);
    }

    .thread-show-more-btn:hover {
      color: var(--accent2);
    }
  </style>
</head>

<body>

  <!-- ═════════════════ LOGIN SCREEN ═════════════════ -->
  <div id="login-screen" class="screen active">
    <div class="login-card">
      <div class="login-logo">
        <div class="wordmark"><span>e</span>lefeed</div>
        <div class="tagline">// a quieter mastodon client</div>
      </div>

      <div class="login-form-box">
        <label class="form-label" for="server-input">mastodon server</label>
        <div class="server-input-wrap">
          <span class="server-prefix">https://</span>
          <input type="text" id="server-input" class="server-input" placeholder="mastodon.social" autocomplete="off" autocapitalize="off" spellcheck="false" />
        </div>
        <div class="quick-servers">
          <button class="quick-server-btn" data-server="mastodon.social">mastodon.social</button>
          <button class="quick-server-btn" data-server="mastodon.online">mastodon.online</button>
          <button class="quick-server-btn" data-server="fosstodon.org">fosstodon.org</button>
          <button class="quick-server-btn" data-server="hachyderm.io">hachyderm.io</button>
          <button class="quick-server-btn" data-server="infosec.exchange">infosec.exchange</button>
          <button class="quick-server-btn" data-server="chaos.social">chaos.social</button>
        </div>

        <button class="login-btn" id="login-btn">Log in with Mastodon →</button>
        <div id="login-error" style="display:none;margin-top:14px;background:rgba(255,107,107,0.10);border:1px solid rgba(255,107,107,0.25);border-radius:6px;color:#ff8080;font-family:var(--font-mono);font-size:11.5px;padding:10px 12px;line-height:1.6;white-space:pre-wrap;word-break:break-word;"></div>
      </div>

      <p class="login-footer">
        No account data is stored on any server.<br />
        Your access token lives in your browser only.<br />
        <a href="https://joinmastodon.org" target="_blank">New to Mastodon?</a>
      </p>
    </div>
  </div>

  <!-- ═════════════════ CALLBACK SCREEN ═════════════════ -->
  <div id="callback-screen" class="screen">
    <div class="callback-message">
      <div class="spinner"></div>
      <p>Completing sign-in…</p>
    </div>
  </div>

  <!-- ═════════════════ APP SCREEN ═════════════════ -->
  <div id="app-screen" class="screen">
    <!-- Compose Sidebar -->
    <aside class="compose-sidebar">
      <div class="compose-sidebar-body">
        <div style="display:flex; gap:8px; margin-bottom:4px;">
          <select class="hashtag-filter-select compose-visibility" id="compose-visibility-sidebar" style="padding:6px 28px 6px 10px;font-size:12px;">
            <option value="public">🌐 Public</option>
            <option value="unlisted">🔓 Unlisted</option>
            <option value="private">🔒 Followers</option>
            <option value="direct">✉️ Direct</option>
          </select>
          <button style="border:1px solid var(--border); border-radius:4px; padding:4px 8px; font-size:12px; color:var(--text-muted); background:transparent; font-family:var(--font-body); cursor:pointer; display:flex; gap:4px; align-items:center;">
            <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <path d="M12 2A10 10 0 1 0 22 12 10 10 0 0 0 12 2z" />
              <line x1="2" y1="12" x2="22" y2="12" />
              <path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z" />
            </svg>
            English
          </button>
        </div>

        <div class="compose-cw-section" id="compose-cw-section-sidebar" style="display:none;">
          <input type="text" class="compose-cw-input" id="compose-cw-input-sidebar" placeholder="Content warning" maxlength="500" />
        </div>

        <div id="compose-reply-bar-sidebar" style="display:none;font-size:12px;color:var(--text-muted);margin-bottom:8px;">
          <span id="compose-context-type-sidebar">Replying to</span> <span id="compose-reply-to-sidebar" style="color:var(--accent2);font-weight:500;"></span>
          <button id="compose-reply-cancel-sidebar" onclick="resetReplyState()" style="margin-left:8px;background:none;border:none;color:var(--danger);cursor:pointer;font-size:11px;">Cancel</button>
        </div>

        <div class="compose-textarea" id="compose-textarea-sidebar" contenteditable="true" placeholder="What's on your mind?" style="min-height:90px;"></div>

        <div class="compose-media-preview" id="compose-media-preview-sidebar"></div>

        <div class="compose-toolbar" style="border-top:none; padding-top:4px;">
          <div class="compose-toolbar-left">
            <button class="compose-tool-btn" id="compose-media-btn-sidebar" title="Add media">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                <circle cx="8.5" cy="8.5" r="1.5" />
                <polyline points="21 15 16 10 5 21" />
              </svg>
            </button>
            <button class="compose-tool-btn" id="compose-emoji-btn-sidebar" title="Emoji">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <circle cx="12" cy="12" r="10" />
                <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                <line x1="9" y1="9" x2="9.01" y2="9" />
                <line x1="15" y1="9" x2="15.01" y2="9" />
              </svg>
            </button>
            <button class="compose-tool-btn" id="compose-cw-btn-sidebar" title="Content warning">
              <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                <line x1="12" y1="9" x2="12" y2="13" />
                <line x1="12" y1="17" x2="12.01" y2="17" />
              </svg>
            </button>
            <input type="file" id="compose-media-input-sidebar" accept="image/*,video/*" multiple style="display:none;" />
          </div>
          <div style="display:flex; align-items:center; justify-content:flex-end; gap:12px; margin-left:auto;">
            <span class="compose-char-count" id="compose-char-count-sidebar" style="font-size:14px; color:var(--text-dim);">500</span>
            <button class="compose-post-btn" id="compose-post-btn-sidebar">Post</button>
          </div>
        </div>
      </div>
    </aside>

    <!-- Trending Now panel removed - now a dedicated tab -->
    <!-- Main Feed Area -->
    <div class="main-wrapper">
      <header class="app-header">
        <div class="header-top">
          <div class="header-wordmark" id="header-wordmark-btn" style="cursor:pointer;" title="Refresh feed"><span>e</span>lefeed</div>
          <div class="header-actions">
            <button class="icon-btn" id="compose-btn" title="New post">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 20h9"></path>
                <path d="M16.5 3.5a2.121 2.121 0 0 1 3 3L7 19l-4 1 1-4L16.5 3.5z"></path>
              </svg>
            </button>
            <button class="icon-btn" id="refresh-btn" title="Refresh feed">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="23 4 23 10 17 10"></polyline>
                <polyline points="1 20 1 14 7 14"></polyline>
                <path d="M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15"></path>
              </svg>
            </button>
            <div style="position:relative; display:inline-flex;">
              <div class="avatar-btn" id="avatar-btn" title="Profile options">
                <img id="user-avatar" src="" alt="" />
              </div>
              <div class="boost-dropdown" id="profile-dropdown" style="right:0; left:auto; top:100%; margin-top:8px; min-width:150px; transform-origin: top right;">
                <button class="boost-dropdown-item" id="profile-view-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2" />
                    <circle cx="12" cy="7" r="4" />
                  </svg>
                  <span>View Profile</span>
                </button>
                <button class="boost-dropdown-item" id="logout-btn">
                  <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5">
                    <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" />
                    <polyline points="16 17 21 12 16 7" />
                    <line x1="21" y1="12" x2="9" y2="12" />
                  </svg>
                  <span style="color:var(--danger)">Sign Out</span>
                </button>
              </div>
            </div>
          </div>
        </div>

        <div class="tab-bar" role="tablist">
          <button class="tab-btn active" role="tab" data-tab="home" aria-selected="true">
            Home
          </button>
          <button class="tab-btn" role="tab" data-tab="following" aria-selected="false">
            Following
          </button>
          <button class="tab-btn" role="tab" data-tab="hashtags" aria-selected="false">
            Hashtags
          </button>
          <button class="tab-btn" role="tab" data-tab="trending" aria-selected="false">
            Trending
          </button>
        </div>
      </header>

      <div class="demo-notice" id="demo-notice" style="display:none;">
        ⚡ Demo mode — showing sample data. Connect to a real Mastodon server to see your actual feed.
      </div>

      <div class="offline-bar" id="offline-bar">
        ⚠ Network unavailable — showing cached data
      </div>

      <main class="feed-container">
        <!-- Inline thread panel (desktop: replaces the feed with back button) -->
        <div class="thread-inline-panel" id="thread-inline-panel">
          <div class="thread-back-bar">
            <button class="thread-back-btn" id="thread-back-btn" aria-label="Back to feed">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12" />
                <polyline points="12 19 5 12 12 5" />
              </svg>
              Back
            </button>
            <span class="thread-back-bar-title">Thread</span>
          </div>
          <div class="thread-inline-inner" id="thread-inline-content">
            <div class="thread-status">
              <div class="spinner"></div>
            </div>
          </div>
        </div>
        <!-- Home Tab -->
        <div class="tab-panel active" id="panel-home" role="tabpanel">
          <div class="feed-loading" id="home-loading">
            <div class="skeleton-posts" id="home-skeleton"></div>
          </div>
          <div class="error-banner" id="home-error"></div>
          <div id="home-posts"></div>
        </div>

        <!-- Following Tab -->
        <div class="tab-panel" id="panel-following" role="tabpanel">
          <div class="feed-loading" id="following-loading" style="display:none;">
            <div class="skeleton-posts" id="following-skeleton"></div>
          </div>
          <div class="error-banner" id="following-error"></div>
          <div id="following-posts"></div>
        </div>

        <div class="tab-panel" id="panel-hashtags" role="tabpanel">
          <div class="hashtag-filter-bar" id="hashtag-filter-bar">
            <div style="display:flex; gap:12px; align-items:center; flex-wrap:wrap; width: 100%;">
              <select class="hashtag-filter-select" id="hashtag-filter-select">
                <option value="all">All Followed Hashtags</option>
              </select>
              <div class="hashtag-search-wrap">
                <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="position:absolute; left:10px; top:50%; transform:translateY(-50%); color:var(--text-dim); pointer-events:none;">
                  <circle cx="11" cy="11" r="8" />
                  <line x1="21" y1="21" x2="16.65" y2="16.65" />
                </svg>
                <input type="text" id="hashtag-search-input" class="hashtag-search-input" placeholder="Search hashtag..." autocomplete="off" />
              </div>
              <button id="hashtag-follow-btn" class="profile-follow-btn" style="display:none; margin-top:0; height:36px;"></button>
            </div>
          </div>
          <div class="feed-loading" id="hashtags-loading" style="display:none;">
            <div class="skeleton-posts" id="hashtags-skeleton"></div>
          </div>
          <div class="error-banner" id="hashtags-error"></div>
          <div id="hashtags-posts"></div>
        </div>

        <!-- Trending Tab -->
        <div class="tab-panel" id="panel-trending" role="tabpanel">
          <!-- Sub-navigation -->
          <div class="trending-subtabs" id="trending-subtabs">
            <button class="trending-subtab-btn active" data-subtab="posts" id="trending-subtab-posts">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
              </svg>
              Posts
            </button>
            <button class="trending-subtab-btn" data-subtab="hashtags" id="trending-subtab-hashtags">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <line x1="4" y1="9" x2="20" y2="9" />
                <line x1="4" y1="15" x2="20" y2="15" />
                <line x1="10" y1="3" x2="8" y2="21" />
                <line x1="16" y1="3" x2="14" y2="21" />
              </svg>
              Hashtags
            </button>
            <button class="trending-subtab-btn" data-subtab="people" id="trending-subtab-people">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2" />
                <circle cx="9" cy="7" r="4" />
                <path d="M23 21v-2a4 4 0 0 0-3-3.87" />
                <path d="M16 3.13a4 4 0 0 1 0 7.75" />
              </svg>
              People
            </button>
            <button class="trending-subtab-btn" data-subtab="news" id="trending-subtab-news">
              <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2" />
                <path d="M18 14h-8" />
                <path d="M15 18h-5" />
                <path d="M10 6h8v4h-8V6Z" />
              </svg>
              News
            </button>
          </div>

          <!-- Posts subpanel -->
          <div class="trending-subpanel active" id="trending-subpanel-posts">
            <div class="feed-loading" id="trending-posts-loading" style="display:none;">
              <div class="skeleton-posts" id="trending-posts-skeleton"></div>
            </div>
            <div class="error-banner" id="trending-posts-error"></div>
            <div id="trending-posts-list"></div>
          </div>

          <!-- Hashtags subpanel -->
          <div class="trending-subpanel" id="trending-subpanel-hashtags">
            <div class="feed-loading" id="trending-hashtags-loading" style="display:none;">
              <div class="skeleton-posts" id="trending-hashtags-skeleton"></div>
            </div>
            <div class="error-banner" id="trending-hashtags-error"></div>
            <div class="trending-section">
              <div id="trending-hashtags-list" class="trending-tags-grid"></div>
            </div>
          </div>

          <!-- People subpanel -->
          <div class="trending-subpanel" id="trending-subpanel-people">
            <div class="feed-loading" id="trending-people-loading" style="display:none;">
              <div class="skeleton-posts" id="trending-people-skeleton"></div>
            </div>
            <div class="error-banner" id="trending-people-error"></div>
            <div class="trending-section">
              <div id="trending-people-list" class="trending-people-grid"></div>
            </div>
          </div>

          <!-- News subpanel -->
          <div class="trending-subpanel" id="trending-subpanel-news">
            <div class="feed-loading" id="trending-news-loading" style="display:none;">
              <div class="skeleton-posts" id="trending-news-skeleton"></div>
            </div>
            <div class="error-banner" id="trending-news-error"></div>
            <div class="trending-section">
              <div id="trending-news-list" class="trending-links-list"></div>
            </div>
          </div>
        </div>
      </main>
    </div><!-- end main-wrapper -->

    <!-- Profile Drawer -->
    <div class="profile-backdrop" id="profile-backdrop"></div>
    <aside class="profile-drawer" id="profile-drawer" aria-hidden="true">
      <div class="profile-drawer-inner">
        <button class="profile-close" id="profile-close" aria-label="Close profile">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
        <div id="profile-content">
          <div class="profile-loading">
            <div class="spinner"></div>
          </div>
        </div>
      </div>
    </aside>

    <!-- Thread Drawer -->
    <div class="thread-backdrop" id="thread-backdrop"></div>
    <aside class="thread-drawer" id="thread-drawer" aria-hidden="true" aria-label="Thread view">
      <div class="thread-drawer-header">
        <button class="thread-close-btn" id="thread-close-btn" aria-label="Close thread">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
        <span class="thread-drawer-title">Thread</span>
      </div>
      <div class="thread-drawer-inner" id="thread-content">
        <div class="thread-status">
          <div class="spinner"></div>
        </div>
      </div>
    </aside>

    <!-- Compose Drawer -->
    <div class="compose-backdrop" id="compose-backdrop"></div>
    <aside class="compose-drawer layout-float" id="compose-drawer" aria-hidden="true">
      <div class="compose-drawer-inner">
        <div class="compose-header">
          <span class="compose-title">New post</span>
          <button class="compose-close" id="compose-close" aria-label="Close">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
              <line x1="18" y1="6" x2="6" y2="18" />
              <line x1="6" y1="6" x2="18" y2="18" />
            </svg>
          </button>
        </div>

        <div class="compose-body">
          <!-- Content Warning Toggle -->
          <div class="compose-cw-section" id="compose-cw-section" style="display:none;">
            <input type="text" class="compose-cw-input" id="compose-cw-input" placeholder="Content warning" maxlength="500" />
          </div>

          <!-- Main Text Area -->
          <div id="compose-reply-bar" style="display:none;font-size:12px;color:var(--text-muted);margin-bottom:8px;">
            <span id="compose-context-type">Replying to</span> <span id="compose-reply-to" style="color:var(--accent2);font-weight:500;"></span>
            <button id="compose-reply-cancel" onclick="resetReplyState()" style="margin-left:8px;background:none;border:none;color:var(--danger);cursor:pointer;font-size:11px;">Cancel</button>
          </div>
          <div class="compose-textarea" id="compose-textarea" contenteditable="true" placeholder="What's on your mind?"></div>

          <!-- Media Preview -->
          <div class="compose-media-preview" id="compose-media-preview"></div>

          <!-- Toolbar -->
          <div class="compose-toolbar">
            <div class="compose-toolbar-left">
              <button class="compose-tool-btn" id="compose-media-btn" title="Add media">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2" />
                  <circle cx="8.5" cy="8.5" r="1.5" />
                  <polyline points="21 15 16 10 5 21" />
                </svg>
              </button>
              <button class="compose-tool-btn" id="compose-emoji-btn" title="Emoji">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <circle cx="12" cy="12" r="10" />
                  <path d="M8 14s1.5 2 4 2 4-2 4-2" />
                  <line x1="9" y1="9" x2="9.01" y2="9" />
                  <line x1="15" y1="9" x2="15.01" y2="9" />
                </svg>
              </button>
              <button class="compose-tool-btn" id="compose-cw-btn" title="Content warning">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z" />
                  <line x1="12" y1="9" x2="12" y2="13" />
                  <line x1="12" y1="17" x2="12.01" y2="17" />
                </svg>
              </button>
              <input type="file" id="compose-media-input" accept="image/*,video/*" multiple style="display:none;" />
            </div>
            <div class="compose-toolbar-right">
              <select class="hashtag-filter-select compose-visibility" id="compose-visibility" style="padding:6px 28px 6px 10px;font-size:12px;">
                <option value="public">🌐 Public</option>
                <option value="unlisted">🔓 Unlisted</option>
                <option value="private">🔒 Followers</option>
                <option value="direct">✉️ Direct</option>
              </select>
            </div>
          </div>

          <!-- Character Counter & Post Button -->
          <div class="compose-footer">
            <span class="compose-char-count" id="compose-char-count">500</span>
            <button class="compose-post-btn" id="compose-post-btn">Post</button>
          </div>
        </div>
      </div>
    </aside>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Emoji Picker -->
  <div class="emoji-picker" id="emoji-picker">
    <div class="emoji-picker-header">
      <input type="text" id="emoji-search" class="emoji-picker-search" placeholder="Search emojis..." autocomplete="off">
    </div>
    <div class="emoji-picker-body" id="emoji-picker-body"></div>
  </div>

  <div class="mention-suggestions" id="mention-suggestions"></div>

  <!-- ALT TEXT MODAL -->
  <div id="alt-text-modal" class="compose-alt-modal" style="display:none; position:fixed; inset:0; z-index:9999; background:rgba(13,13,15,0.85); align-items:center; justify-content:center; backdrop-filter:blur(4px); -webkit-backdrop-filter:blur(4px);">
    <div style="background:var(--surface); width:min(500px, 100%); margin: 0 16px; border:1px solid var(--border); border-radius:12px; display:flex; flex-direction:column; overflow:hidden; box-shadow:0 12px 32px rgba(0,0,0,0.5);">
      <div style="padding:16px; border-bottom:1px solid var(--border); display:flex; justify-content:space-between; align-items:center;">
        <h3 style="font-size:16px; font-weight:500;">Image Description</h3>
        <button id="alt-modal-close" style="background:none; border:none; color:var(--text-muted); cursor:pointer;">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
            <line x1="18" y1="6" x2="6" y2="18" />
            <line x1="6" y1="6" x2="18" y2="18" />
          </svg>
        </button>
      </div>
      <div style="padding:16px; flex:1; overflow-y:auto;">
        <img id="alt-modal-img" src="" style="width:100%; max-height:200px; object-fit:contain; border-radius:8px; margin-bottom:16px; background:var(--bg);" />
        <textarea id="alt-modal-input" placeholder="Describe this image for users with visual impairments..." style="width:100%; min-height:120px; background:var(--bg); border:1px solid var(--border); border-radius:8px; padding:12px; color:var(--text); font-family:var(--font-body); font-size:14px; resize:vertical; outline:none; transition:border-color 0.2s;"></textarea>
      </div>
      <div style="padding:16px; border-top:1px solid var(--border); display:flex; justify-content:flex-end; gap:12px;">
        <span id="alt-modal-count" style="margin-right:auto; color:var(--text-muted); font-size:13px; align-self:center;">1500</span>
        <button id="alt-modal-cancel" style="padding:8px 16px; background:none; border:1px solid var(--border); border-radius:6px; color:var(--text); cursor:pointer;">Cancel</button>
        <button id="alt-modal-save" style="padding:8px 16px; background:var(--accent); border:none; border-radius:6px; color:#fff; font-weight:500; cursor:pointer;">Done</button>
      </div>
    </div>
  </div>

  <script>
    /* ═══════════════════════════════════════════════════════
       ELEFEED — Lightweight Mastodon Client
       v0.1 | Single-file, no build step required
       ══════════════════════════════════════════════════════ */

    const CLIENT_NAME = 'Elefeed';
    const CLIENT_WEBSITE = location.origin;
    // Normalize redirect URI - must match exactly between registration and authorization
    const REDIRECT_URI = (() => {
      const path = location.pathname;
      // If root or ends with /, use as-is
      if (path === '/' || path.endsWith('/')) {
        return location.origin + path.replace(/\/$/, '');
      }
      // Otherwise use full path including filename
      return location.origin + path;
    })();
    const SCOPES = 'read write write:statuses write:media write:favourites';

    /* ─── Storage helpers ─── */
    const store = {
      get: k => { try { return localStorage.getItem(k); } catch { return null; } },
      set: (k, v) => { try { localStorage.setItem(k, v); } catch { } },
      del: k => { try { localStorage.removeItem(k); } catch { } },
    };

    /* ─── App state ─── */
    const state = {
      server: null,
      token: null,
      clientId: null,
      clientSecret: null,
      account: null,
      homeFeed: null,
      followingFeed: null,
      hashtagFeed: null,
      followedHashtags: [],
      selectedHashtagFilter: 'all',
      homeFilter: 'all',
      knownFollowing: new Set(),
      knownNotFollowing: new Set(),
      activeTab: 'home',
      demoMode: false,
      trendingPostsLoaded: false,
      trendingHashtagsLoaded: false,
      trendingPeopleLoaded: false,
      trendingNewsLoaded: false,
    };

    /* ─── Utility ─── */
    const $ = id => document.getElementById(id);
    const qs = sel => document.querySelector(sel);

    function showScreen(id) {
      document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
      $(id).classList.add('active');
    }

    function showToast(msg, duration = 2500) {
      const t = $('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(t._timer);
      t._timer = setTimeout(() => t.classList.remove('show'), duration);
    }

    function showLoginError(msg) {
      const el = $('login-error');
      el.textContent = msg;
      el.style.display = 'block';
    }

    function clearLoginError() {
      const el = $('login-error');
      el.style.display = 'none';
      el.textContent = '';
    }

    function setError(section, msg) {
      const el = $(`${section}-error`);
      if (msg) {
        el.textContent = msg;
        el.classList.add('visible');
      } else {
        el.classList.remove('visible');
      }
    }

    function makeSkeleton(count = 5) {
      return Array.from({ length: count }, () => `
    <div class="skeleton-post">
      <div class="skel-header">
        <div class="skel-avatar"></div>
        <div class="skel-meta">
          <div class="skel-line w-40"></div>
          <div class="skel-line w-60" style="margin-top:4px;height:8px;"></div>
        </div>
      </div>
      <div class="skel-line w-90"></div>
      <div class="skel-line w-80" style="margin-top:5px;"></div>
      <div class="skel-line w-70" style="margin-top:5px;"></div>
    </div>
  `).join('');
    }

    function setLoading(section, on) {
      const el = $(`${section}-loading`);
      if (!el) return;
      if (on) {
        $(`${section}-skeleton`).innerHTML = makeSkeleton(5);
        el.style.display = 'flex';
      } else {
        el.style.display = 'none';
      }
    }

    function relativeTime(dateStr) {
      const diff = (Date.now() - new Date(dateStr)) / 1000;
      if (diff < 60) return `${Math.floor(diff)}s`;
      if (diff < 3600) return `${Math.floor(diff / 60)}m`;
      if (diff < 86400) return `${Math.floor(diff / 3600)}h`;
      if (diff < 604800) return `${Math.floor(diff / 86400)}d`;
      return new Date(dateStr).toLocaleDateString('en', { month: 'short', day: 'numeric' });
    }

    function sanitizeHTML(html) {
      // Create a safe version of the HTML
      const div = document.createElement('div');
      div.innerHTML = html;
      // Style hashtags and mentions
      div.querySelectorAll('a').forEach(a => {
        const href = a.getAttribute('href') || '';
        const text = a.textContent;
        if (text.startsWith('#')) a.classList.add('hashtag');
        else if (text.startsWith('@')) a.classList.add('mention');
        a.setAttribute('target', '_blank');
        a.setAttribute('rel', 'noopener noreferrer');
      });
      return div.innerHTML;
    }

    function processContent(html) {
      const div = document.createElement('div');
      div.innerHTML = html;
      // Process YouTube links
      div.querySelectorAll('a').forEach(a => {
        const href = a.getAttribute('href') || '';
        const youtubeMatch = href.match(/(?:youtube\.com\/watch\?v=|youtu\.be\/)([a-zA-Z0-9_-]{11})/);
        if (youtubeMatch) {
          const videoId = youtubeMatch[1];
          const embedHTML = `
            <div class="youtube-embed" style="margin: 10px 0; max-width: 100%; position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
              <iframe src="https://www.youtube.com/embed/${videoId}" 
                      style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;" 
                      allowfullscreen>
              </iframe>
            </div>
          `;
          a.outerHTML = embedHTML;
        }
      });
      return div.innerHTML;
    }

    function expandMedia(mediaItem) {
      const fullUrl = mediaItem.dataset.fullUrl;
      const type = mediaItem.dataset.type;
      if (!fullUrl) return;

      // Create lightbox overlay
      const overlay = document.createElement('div');
      overlay.className = 'lightbox-overlay';

      const content = document.createElement('div');
      content.className = 'lightbox-content';

      let mediaEl;
      if (type === 'video') {
        mediaEl = document.createElement('video');
        mediaEl.src = fullUrl;
        mediaEl.controls = true;
        mediaEl.autoplay = true;
      } else {
        mediaEl = document.createElement('img');
        mediaEl.src = fullUrl;
      }

      const closeBtn = document.createElement('button');
      closeBtn.className = 'lightbox-close';
      closeBtn.innerHTML = '<svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>';

      content.appendChild(mediaEl);
      overlay.appendChild(content);
      overlay.appendChild(closeBtn);
      document.body.appendChild(overlay);

      // Animation
      requestAnimationFrame(() => {
        overlay.classList.add('open');
      });

      // Interaction
      const close = () => {
        overlay.classList.remove('open');
        setTimeout(() => overlay.remove(), 250);
        document.removeEventListener('keydown', handleEsc);
      };

      const handleEsc = (e) => {
        if (e.key === 'Escape') {
          e.stopPropagation();
          close();
        }
      };

      overlay.onclick = close;
      closeBtn.onclick = (e) => {
        e.stopPropagation();
        close();
      };
      mediaEl.onclick = (e) => e.stopPropagation();

      document.addEventListener('keydown', handleEsc);
    }

    function adjustImageAlignment(img) {
      if (img.complete) {
        const aspectRatio = img.naturalWidth / img.naturalHeight;
        if (aspectRatio < 1) { // Vertical image
          img.classList.add('vertical-image');
        } else { // Horizontal or square image
          img.classList.add('horizontal-image');
        }
      } else {
        // Image not loaded yet, check when it loads
        img.onload = () => adjustImageAlignment(img);
      }
    }

    /* ─── Render a single post ─── */
    function renderPost(status, opts = {}) {
      const isBoost = !!status.reblog;
      const boostBy = isBoost ? status.account : null;
      const s = isBoost ? status.reblog : status;

      // Media
      let mediaHTML = '';
      if (s.media_attachments && s.media_attachments.length > 0) {
        const count = Math.min(s.media_attachments.length, 4);
        const items = s.media_attachments.slice(0, 4).map(m => {
          const sensitive = s.sensitive;
          const blurClass = sensitive ? 'media-sensitive-blur' : '';
          const overlay = sensitive ? `
        <div class="sensitive-overlay" onclick="event.stopPropagation(); this.parentElement.querySelector('img,video').classList.remove('media-sensitive-blur'); this.style.display='none'">
          <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
          <span>sensitive content</span>
        </div>` : '';

          if (m.type === 'image' || m.type === 'gifv') {
            return `<div class="media-item" data-full-url="${m.url}" data-type="image" onclick="expandMedia(this)">
          <img src="${m.preview_url || m.url}" alt="${(m.description || '').replace(/"/g, '&quot;')}" class="${blurClass}" loading="lazy" onload="adjustImageAlignment(this)"/>
          ${overlay}
        </div>`;
          } else if (m.type === 'video') {
            return `<div class="media-item" data-full-url="${m.url}" data-type="video" onclick="expandMedia(this)">
          <video src="${m.url}" poster="${m.preview_url || ''}" controls muted class="${blurClass}"></video>
          ${overlay}
        </div>`;
          }
          return '';
        }).join('');

        mediaHTML = `<div class="post-media">
      <div class="post-media-grid count-${count}">${items}</div>
    </div>`;
      }

      // Poll
      let pollHTML = '';
      if (s.poll) {
        const total = s.poll.votes_count || 1;
        const options = s.poll.options.map(opt => {
          const pct = total > 0 ? Math.round((opt.votes_count / total) * 100) : 0;
          return `<div class="poll-option">
        <div class="poll-bar" style="width:${pct}%"></div>
        <span class="poll-option-text">${escapeHTML(opt.title)}</span>
        <span class="poll-pct">${pct}%</span>
      </div>`;
        }).join('');
        pollHTML = `<div class="post-poll">
      ${options}
      <div class="poll-meta">${total} votes · ${s.poll.expired ? 'closed' : 'open'}</div>
    </div>`;
      }

      // Quote
      let quoteHTML = '';
      const qStatus = s.quote && (s.quote.quoted_status || (s.quote.account ? s.quote : null));
      if (qStatus) {
        const qHasCW = (qStatus.spoiler_text && qStatus.spoiler_text.length > 0) || qStatus.sensitive;
        const qCwText = qStatus.spoiler_text ? escapeHTML(qStatus.spoiler_text) : 'Sensitive content';
        const qCwId = `qcw-${qStatus.id}-${status.id}`;
        let qContentHTML = '';
        if (qHasCW) {
          qContentHTML = `
            <div class="cw-wrapper">
              <div class="cw-summary" style="cursor: pointer;" onclick="event.stopPropagation(); window.toggleCW('${qCwId}', this.querySelector('.cw-toggle'))">
                <span>${qCwText}</span>
                <button class="cw-toggle" onclick="event.stopPropagation(); window.toggleCW('${qCwId}', this)">show</button>
              </div>
              <div class="cw-body" id="${qCwId}">
                <div class="post-content">${processContent(sanitizeHTML(qStatus.content))}</div>
              </div>
            </div>`;
        } else {
          qContentHTML = `<div class="post-content" style="margin-bottom:0">${processContent(sanitizeHTML(qStatus.content))}</div>`;
        }

        quoteHTML = `
        <div class="post-quote" onclick="event.stopPropagation(); window.open('${qStatus.url}', '_blank')">
          <div class="post-header" style="margin-bottom:8px;">
            <div class="post-avatar" style="width:24px;height:24px;">
              <img src="${qStatus.account.avatar_static || qStatus.account.avatar}" alt="" loading="lazy"/>
            </div>
            <div class="post-meta">
              <div class="post-author" style="font-size:13px;">
                <span class="post-display-name">${renderCustomEmojis(qStatus.account.display_name || qStatus.account.username, qStatus.account.emojis)}</span>
                <span class="post-acct">@${escapeHTML(qStatus.account.acct)}</span>
                <span class="post-time">${relativeTime(qStatus.created_at)}</span>
              </div>
            </div>
          </div>
          ${qContentHTML}
        </div>`;
      }

      // Content warning
      const hasCW = (s.spoiler_text && s.spoiler_text.length > 0) || s.sensitive;
      const cwText = s.spoiler_text ? escapeHTML(s.spoiler_text) : 'Sensitive content';
      const cwId = `cw-${status.id}`;
      let contentHTML = '';
      if (hasCW) {
        contentHTML = `
      <div class="cw-wrapper">
        <div class="cw-summary" style="cursor: pointer;" onclick="event.stopPropagation(); window.toggleCW('${cwId}', this.querySelector('.cw-toggle'))">
          <span>${cwText}</span>
          <button class="cw-toggle" onclick="event.stopPropagation(); window.toggleCW('${cwId}', this)">show</button>
        </div>
        <div class="cw-body" id="${cwId}">
          <div class="post-content">${processContent(sanitizeHTML(s.content))}</div>
          ${mediaHTML}
          ${pollHTML}
          ${quoteHTML}
        </div>
      </div>`;
      } else {
        contentHTML = `
      <div class="post-content">${processContent(sanitizeHTML(s.content))}</div>
      ${mediaHTML}
      ${pollHTML}
      ${quoteHTML}`;
      }

      // Hashtag banner — shown when post is sourced from a followed hashtag
      const tagList = opts.tags && opts.tags.length ? opts.tags : (opts.tag ? [opts.tag] : []);
      const isHashtagPost = tagList.length > 0;

      const hashtagBanner = (isHashtagPost && !boostBy) ? `
    <div class="post-hashtag-banner">
      <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><line x1="4" y1="9" x2="20" y2="9"/><line x1="4" y1="15" x2="20" y2="15"/><line x1="10" y1="3" x2="8" y2="21"/><line x1="16" y1="3" x2="14" y2="21"/></svg>
      via
      <div class="post-hashtag-banner-tags">${tagList.map(t =>
        `<a href="#" class="hashtag post-hashtag-banner-tag">#${escapeHTML(t)}</a>`
      ).join('')}</div>
    </div>` : '';

      // Boost header
      const boostLabelHTML = boostBy ? `
    <div class="boost-divider">
      <div class="boost-text">
        <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
        <span class="post-display-name" data-profile-id="${boostBy.id}" data-profile-server="${escapeHTML(state.server || '')}">${renderCustomEmojis(boostBy.display_name || boostBy.username, boostBy.emojis)}</span> <span style="opacity:0.8;text-transform:uppercase;font-size:11px;font-weight:500;">boosted</span>
      </div>
      <div class="boost-divider-line"></div>
      <svg class="boost-divider-arrow" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 5v14M19 12l-7 7-7-7"/></svg>
    </div>` : '';

      // Context styling
      let contextClass = '';
      if (boostBy) {
        contextClass = ' post--boost';
      } else if (isHashtagPost) {
        contextClass = ' post--hashtag';
      } else if (s.in_reply_to_id) {
        contextClass = ' post--reply';
      }

      return `
    <article class="post${contextClass}" data-id="${s.id}">
      ${boostLabelHTML}
      ${hashtagBanner}
      <div class="post-header">
        <div class="post-avatar" data-profile-id="${s.account.id}" data-profile-server="${escapeHTML(state.server || '')}" style="cursor:pointer">
          <img src="${s.account.avatar_static || s.account.avatar}" alt="${escapeHTML(s.account.display_name || s.account.username)}" loading="lazy"/>
        </div>
        <div class="post-meta">
          <div class="post-author">
            <span class="post-display-name" data-profile-id="${s.account.id}" data-profile-server="${escapeHTML(state.server || '')}">${renderCustomEmojis(s.account.display_name || s.account.username, s.account.emojis)}</span>
            <span class="post-acct">@${escapeHTML(s.account.acct)}</span>
            <span class="post-time">${relativeTime(s.created_at)}</span>
          </div>
        </div>
      </div>
      ${contentHTML}
      <div class="post-footer">
        <button class="post-stat post-reply-btn" data-post-id="${s.id}" data-account-acct="${s.account.acct}" title="Reply">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10l5-5v3c8 0 13 4 13 11-3-4-7-5-13-5v3l-5-5z"></path></svg>
          <span style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim);">${s.replies_count || 0}</span>
        </button>
        <div style="position:relative;display:inline-flex;">
          <button class="post-stat post-boost-btn ${s.reblogged ? 'boosted' : ''}" data-post-id="${s.id}" title="Boost or Quote">
            <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--boost)"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
            <span class="boost-count" style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim);">${(s.reblogs_count || 0) + (s.quotes_count || 0)}</span>
          </button>
          <div class="boost-dropdown" id="boost-menu-${s.id}">
            <button class="boost-dropdown-item" data-action="boost" data-post-id="${s.id}" data-is-boosted="${s.reblogged ? 'true' : 'false'}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
              <span>${s.reblogged ? 'Undo Boost' : 'Boost'}</span>
              <span class="dropdown-stat-count" style="margin-left:auto;color:var(--text-muted);font-size:12.5px;font-family:var(--font-mono);">${s.reblogs_count || 0}</span>
            </button>
            <button class="boost-dropdown-item" data-action="quote" data-post-id="${s.id}" data-acct="${escapeHTML(s.account.acct)}">
              <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 11h-4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2zm10 0h-4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2z"/></svg>
              <span>Quote</span>
              <span class="dropdown-stat-count" style="margin-left:auto;color:var(--text-muted);font-size:12.5px;font-family:var(--font-mono);">${s.quotes_count || 0}</span>
            </button>
          </div>
        </div>
        <button class="post-stat post-fav-btn ${s.favourited ? 'favourited' : ''}" data-post-id="${s.id}" data-favourited="${s.favourited ? 'true' : 'false'}" title="${s.favourited ? 'Unfavorite' : 'Favorite'}">
          <svg width="13" height="13" viewBox="0 0 24 24" fill="${s.favourited ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" style="color:var(--fav)"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
          <span class="post-fav-count">${s.favourites_count || 0}</span>
        </button>
        <a href="${s.url}" target="_blank" rel="noopener" style="margin-left:auto;color:var(--text-dim);font-family:var(--font-mono);font-size:11px;text-decoration:none;" title="Open original">↗</a>
      </div>
    </article>`;
    }

    function escapeHTML(str) {
      if (!str) return '';
      return str.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
    }

    function renderCustomEmojis(text, emojis = []) {
      if (!text) return '';
      let escaped = escapeHTML(text);
      if (emojis && emojis.length > 0) {
        emojis.forEach(e => {
          const regex = new RegExp(`:${e.shortcode}:`, 'g');
          escaped = escaped.replace(regex, `<img src="${e.url}" alt=":${e.shortcode}:" title=":${e.shortcode}:" class="custom-emoji" />`);
        });
      }
      return escaped;
    }

    window.toggleCW = function (id, btn) {
      const body = document.getElementById(id);
      const expanded = body.classList.toggle('expanded');
      btn.textContent = expanded ? 'hide' : 'show';
    };

    /* ─── API helpers ─── */
    async function apiGet(path, token, server, signal) {
      const base = server || state.server;
      let res;
      try {
        res = await fetch(`https://${base}${path}`, {
          headers: token ? { 'Authorization': `Bearer ${token}` } : {},
          cache: 'no-store',
          signal: signal,
        });
      } catch (networkErr) {
        throw new Error(`Network error fetching ${path}. Are you online?`);
      }
      if (!res.ok) {
        let detail = '';
        try { const j = await res.json(); detail = j.error || ''; } catch { }
        throw new Error(`API error ${res.status}${detail ? ': ' + detail : ` (${res.statusText})`}`);
      }
      return res.json();
    }

    /* ─── OAuth flow ─── */
    async function registerApp(server) {
      // Check cached registration and validate redirect_uri AND scopes
      const stored = store.get(`app_${server}`);
      if (stored) {
        try {
          const app = JSON.parse(stored);
          // Validate the cached app has the correct redirect_uri and scopes
          // If not, clear cache and re-register
          if (app.redirect_uri === REDIRECT_URI && app.scopes === SCOPES) {
            return app;
          }
          // Stale cache with wrong URI or scopes - clear it
          store.del(`app_${server}`);
        } catch {
          // Corrupt cache - clear it
          store.del(`app_${server}`);
        }
      }

      // Mastodon requires application/x-www-form-urlencoded for /api/v1/apps
      const body = new URLSearchParams({
        client_name: CLIENT_NAME,
        redirect_uris: REDIRECT_URI,
        scopes: SCOPES,
        website: CLIENT_WEBSITE,
      });

      let res;
      try {
        res = await fetch(`https://${server}/api/v1/apps`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString(),
        });
      } catch (networkErr) {
        // fetch() itself threw — almost always a CORS or network issue
        const isFile = location.protocol === 'file:';
        if (isFile) {
          throw new Error(
            'Cannot connect from a file:// URL. ' +
            'Serve this file with a local web server:\n\n' +
            '  python3 -m http.server 8080\n\n' +
            'Then open http://localhost:8080/elefeed.html'
          );
        }
        throw new Error(
          `Network error reaching ${server}. ` +
          'Check the server name, your connection, or whether the server is online.'
        );
      }

      if (!res.ok) {
        let detail = '';
        try { const j = await res.json(); detail = j.error || JSON.stringify(j); } catch { }
        throw new Error(`Server rejected app registration (${res.status})${detail ? ': ' + detail : '.'}`);
      }

      const app = await res.json();
      if (!app.client_id || !app.client_secret) {
        throw new Error('Server returned invalid app credentials.');
      }

      // Store with redirect_uri and scopes for validation on next load
      store.set(`app_${server}`, JSON.stringify({ ...app, redirect_uri: REDIRECT_URI, scopes: SCOPES }));
      return app;
    }

    async function exchangeCode(server, clientId, clientSecret, code) {
      // Token exchange also requires form-urlencoded on most servers
      const body = new URLSearchParams({
        client_id: clientId,
        client_secret: clientSecret,
        redirect_uri: REDIRECT_URI,
        grant_type: 'authorization_code',
        code,
        scope: SCOPES,
      });

      let res;
      try {
        res = await fetch(`https://${server}/oauth/token`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
          body: body.toString(),
        });
      } catch (networkErr) {
        throw new Error(`Network error during token exchange with ${server}.`);
      }

      if (!res.ok) {
        let detail = '';
        try { const j = await res.json(); detail = j.error_description || j.error || ''; } catch { }
        throw new Error(`Token exchange failed (${res.status})${detail ? ': ' + detail : '.'}`);
      }

      const data = await res.json();
      if (!data.access_token) throw new Error('Server did not return an access token.');
      return data;
    }

    /* ─── Login button ─── */
    $('login-btn').addEventListener('click', async () => {
      const serverRaw = $('server-input').value.trim()
        .replace(/^https?:\/\//, '')
        .replace(/\/+$/, '');

      if (!serverRaw) {
        showLoginError('Please enter a server domain.');
        return;
      }

      const server = serverRaw.toLowerCase();
      $('login-btn').textContent = 'Connecting…';
      $('login-btn').disabled = true;
      clearLoginError();

      try {
        const app = await registerApp(server);
        store.set('pending_server', server);
        store.set('pending_client_id', app.client_id);
        store.set('pending_client_secret', app.client_secret);

        const authUrl = `https://${server}/oauth/authorize?` + new URLSearchParams({
          client_id: app.client_id,
          redirect_uri: REDIRECT_URI,
          response_type: 'code',
          scope: SCOPES,
        });

        // Open OAuth in a popup so the user never leaves this page
        const W = 520, H = 680;
        const left = Math.round(window.screenX + (window.outerWidth - W) / 2);
        const top = Math.round(window.screenY + (window.outerHeight - H) / 2);
        const popup = window.open(
          authUrl,
          'elefeed_oauth',
          `width=${W},height=${H},left=${left},top=${top},toolbar=no,menubar=no,location=yes,status=no`
        );

        if (!popup || popup.closed) {
          // Popup blocked — fall back to same-tab redirect
          showLoginError('Popup was blocked. Redirecting in this tab instead…');
          await delay(1200);
          location.href = authUrl;
          return;
        }

        $('login-btn').textContent = 'Waiting for sign-in…';

        // Poll for the popup writing the token to localStorage, or for it closing
        const poll = setInterval(async () => {
          const token = store.get('oauth_done_token');
          const server = store.get('oauth_done_server');
          const scopes = store.get('oauth_done_scopes');

          if (token && server) {
            clearInterval(poll);
            store.del('oauth_done_token');
            store.del('oauth_done_server');
            store.del('oauth_done_scopes');
            try { popup.close(); } catch { }

            store.set('token', token);
            store.set('server', server);
            store.set('token_scopes', scopes || SCOPES);

            $('login-btn').textContent = 'Log in with Mastodon →';
            $('login-btn').disabled = false;

            await initApp(server, token);
            return;
          }

          if (popup.closed) {
            clearInterval(poll);
            // Popup closed without completing — check if callback happened in this tab
            const tabToken = store.get('token');
            const tabServer = store.get('server');
            if (tabToken && tabServer) {
              await initApp(tabServer, tabToken);
            } else {
              $('login-btn').textContent = 'Log in with Mastodon →';
              $('login-btn').disabled = false;
              showLoginError('Sign-in was cancelled or the window was closed.');
            }
          }
        }, 400);

      } catch (err) {
        $('login-btn').textContent = 'Log in with Mastodon →';
        $('login-btn').disabled = false;
        showLoginError(err.message);
        console.error('[Elefeed] Login error:', err);
      }
    });

    /* Quick server buttons */
    document.querySelectorAll('.quick-server-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        $('server-input').value = btn.dataset.server;
        $('server-input').focus();
      });
    });

    /* Enter key in input */
    $('server-input').addEventListener('keydown', e => {
      if (e.key === 'Enter') $('login-btn').click();
    });

    /* ─── OAuth callback ─── */
    async function handleCallback(code) {
      const server = store.get('pending_server');
      const clientId = store.get('pending_client_id');
      const clientSecret = store.get('pending_client_secret');

      const isPopup = !!(window.opener && window.opener !== window);

      if (!server || !clientId || !clientSecret) {
        if (isPopup) { window.close(); return; }
        showScreen('login-screen');
        showLoginError('Auth state lost. Please try again.');
        return;
      }

      // Show spinner — either in the popup itself or the callback screen
      if (isPopup) {
        document.body.innerHTML = `
      <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#0d0d0f;color:#8888a0;font-family:'DM Mono',monospace;font-size:13px;gap:16px;">
        <div style="width:28px;height:28px;border:2px solid #2a2a34;border-top-color:#9b7fff;border-radius:50%;animation:spin 700ms linear infinite;"></div>
        <p>Completing sign-in…</p>
        <style>@keyframes spin{to{transform:rotate(360deg)}}</style>
      </div>`;
      } else {
        showScreen('callback-screen');
      }

      try {
        const tokenData = await exchangeCode(server, clientId, clientSecret, code);
        store.del('pending_server');
        store.del('pending_client_id');
        store.del('pending_client_secret');
        history.replaceState(null, '', location.pathname);

        if (isPopup) {
          // Signal the parent window via localStorage, then close
          store.set('oauth_done_token', tokenData.access_token);
          store.set('oauth_done_server', server);
          store.set('oauth_done_scopes', SCOPES);
          window.close();
        } else {
          // Full-tab fallback: just proceed normally
          store.set('token', tokenData.access_token);
          store.set('server', server);
          store.set('token_scopes', SCOPES);
          await initApp(server, tokenData.access_token);
        }
      } catch (err) {
        console.error('[Elefeed] Callback error:', err);
        if (isPopup) {
          document.body.innerHTML = `
        <div style="display:flex;flex-direction:column;align-items:center;justify-content:center;height:100vh;background:#0d0d0f;color:#ff8080;font-family:'DM Mono',monospace;font-size:12px;gap:12px;padding:24px;text-align:center;">
          <p>Sign-in failed.</p>
          <p style="color:#55556a;">${err.message}</p>
          <p style="color:#55556a;">You can close this window and try again.</p>
        </div>`;
        } else {
          showScreen('login-screen');
          showLoginError('Sign-in failed: ' + err.message + '\n\nPlease try again.');
        }
      }
    }

    /* ─── Init app ─── */
    async function initApp(server, token, demo = false) {
      state.server = server;
      state.token = token;
      state.demoMode = demo;
      showScreen('app-screen');

      if (demo) {
        $('demo-notice').style.display = 'block';
        loadDemoData();
        return;
      }

      // Load account info
      try {
        state.account = await apiGet('/api/v1/accounts/verify_credentials', token, server);
        const avatarEl = $('user-avatar');
        avatarEl.src = state.account.avatar_static || state.account.avatar;
        avatarEl.alt = state.account.display_name || state.account.username;
      } catch (err) {
        console.warn('Could not load account info:', err);
      }

      // Load home feed
      loadHomeTab();
      startPolling();
    }

    /* ─── TAB SWITCHING ─── */
    let tabSwitchTimeout = null;
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const tab = btn.dataset.tab;
        if (tab === state.activeTab) return;

        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.tab === tab);
          b.setAttribute('aria-selected', b.dataset.tab === tab);
        });
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.toggle('active', p.id === `panel-${tab}`);
        });

        state.activeTab = tab;

        // Debounce tab loads to prevent rapid-fire API calls
        clearTimeout(tabSwitchTimeout);
        tabSwitchTimeout = setTimeout(() => {
          if (tab === 'home') loadHomeTab();
          else if (tab === 'following') loadFollowingTab();
          else if (tab === 'hashtags') loadHashtagsTab();
          else if (tab === 'trending') loadTrendingTab();
        }, 100);
      });
    });

    /* ─── Trending sub-tab switching ─── */
    document.querySelectorAll('.trending-subtab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        const subtab = btn.dataset.subtab;
        document.querySelectorAll('.trending-subtab-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.subtab === subtab);
        });
        document.querySelectorAll('.trending-subpanel').forEach(p => {
          p.classList.toggle('active', p.id === `trending-subpanel-${subtab}`);
        });
        // Load if not yet populated
        if (subtab === 'hashtags' && !state.trendingHashtagsLoaded) loadTrendingHashtags();
        else if (subtab === 'people' && !state.trendingPeopleLoaded) loadTrendingPeople();
        else if (subtab === 'news' && !state.trendingNewsLoaded) loadTrendingNews();
      });
    });


    /* ─── Refresh button & Logo click ─── */
    const doRefresh = () => {
      const tab = state.activeTab;
      if (tab === 'home') loadHomeTab();
      else if (tab === 'following') loadFollowingTab();
      else if (tab === 'hashtags') loadHashtagsTab();
      else if (tab === 'trending') {
        state.trendingPostsLoaded = false;
        state.trendingHashtagsLoaded = false;
        state.trendingPeopleLoaded = false;
        state.trendingNewsLoaded = false;
        loadTrendingTab();
      }
      showToast('Refreshing…');
    };
    $('refresh-btn').addEventListener('click', doRefresh);
    $('header-wordmark-btn').addEventListener('click', doRefresh);

    /* ─── Avatar Menu ─── */
    $('avatar-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      document.querySelectorAll('.boost-dropdown').forEach(m => {
        if (m.id !== 'profile-dropdown') m.classList.remove('show');
      });
      const menu = $('profile-dropdown');
      if (menu) menu.classList.toggle('show');
    });

    $('profile-view-btn').addEventListener('click', () => {
      if (state.account) {
        openProfileDrawer(state.account.id, state.server);
      }
    });

    /* ─── Logout ─── */
    $('logout-btn').addEventListener('click', () => {
      store.del('token');
      store.del('server');
      store.del('token_scopes');
      state.server = null;
      state.token = null;
      state.account = null;
      state.homeFeed = null;
      state.followingFeed = null;
      state.hashtagFeed = null;
      state.followedHashtags = null;
      state.activeTab = 'home';
      state.trendingPostsLoaded = false;
      state.trendingHashtagsLoaded = false;
      state.trendingPeopleLoaded = false;
      state.trendingNewsLoaded = false;
      $('demo-notice').style.display = 'none';
      $('home-posts').innerHTML = '';
      $('following-posts').innerHTML = '';
      $('hashtags-posts').innerHTML = '';
      $('trending-posts-list').innerHTML = '';
      $('trending-hashtags-list').innerHTML = '';
      $('trending-people-list').innerHTML = '';
      $('trending-news-list').innerHTML = '';

      // Reset tabs
      document.querySelectorAll('.tab-btn').forEach((b, i) => {
        b.classList.toggle('active', i === 0);
      });
      document.querySelectorAll('.tab-panel').forEach((p, i) => {
        p.classList.toggle('active', i === 0);
      });

      showScreen('login-screen');
      showToast('Signed out.');
      stopPolling();
    });

    /* ═══════════════════════════════════════════════
       POLLING
    ══════════════════════════════════════════════════ */
    let pollInterval = null;

    function startPolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = setInterval(pollForNewPosts, 20000);  // every 20 seconds
    }

    function stopPolling() {
      if (pollInterval) clearInterval(pollInterval);
      pollInterval = null;
    }

    async function pollForNewPosts() {
      if (!state.token || state.demoMode || !state.activeTab) return;
      const feed = state.activeTab;

      let minIdToUse = state.homeFeed && state.homeFeed.length > 0 ? state.homeFeed[0].id : null;
      if (feed === 'hashtags' && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
        minIdToUse = state.hashtagFeed && state.hashtagFeed.length > 0 ? state.hashtagFeed[0].id : null;
      }
      if (!minIdToUse) return;

      try {
        let newPosts = [];
        if (feed === 'hashtags' && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
          const tag = encodeURIComponent(state.selectedHashtagFilter);
          newPosts = await apiGet(`/api/v1/timelines/tag/${tag}?limit=40&min_id=${minIdToUse}`, state.token);
          newPosts.forEach(p => p._sourceTags = [state.selectedHashtagFilter]);
          if (newPosts.length > 0) {
            state.hashtagFeed = [...newPosts, ...state.hashtagFeed];
          }
        } else {
          newPosts = await apiGet(`/api/v1/timelines/home?limit=40&min_id=${minIdToUse}`, state.token);
          const followedTagNames = new Set((state.followedHashtags || []).map(t => t.name.toLowerCase()));
          newPosts.forEach(p => {
            p._sourceTags = [];
            const inner = p.reblog || p;
            if (inner.tags && Array.isArray(inner.tags)) {
              inner.tags.forEach(t => {
                if (followedTagNames.has(t.name.toLowerCase())) p._sourceTags.push(t.name.toLowerCase());
              });
            }
          });
          if (newPosts.length > 0) {
            state.homeFeed = [...newPosts, ...state.homeFeed];
            renderTrendingNowFromState();
          }
        }

        if (!newPosts.length) return;

        let display = newPosts;
        if (feed === 'following') display = await filterForFollowing(newPosts);
        else if (feed === 'hashtags') {
          if (state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
            display = newPosts;
          } else {
            display = newPosts.filter(p => p._sourceTags && p._sourceTags.length > 0);
          }
        }

        if (!display.length) return;

        const html = display.map(p => renderPost(p, { tags: p._sourceTags || [] })).join('');
        const container = $(`${feed}-posts`);
        if (!container) return;

        const tmp = document.createElement('div');
        tmp.innerHTML = html;

        const currentScroll = window.scrollY || document.documentElement.scrollTop;
        const originalHeight = document.documentElement.scrollHeight;

        while (tmp.lastChild) {
          container.insertBefore(tmp.lastChild, container.firstChild);
        }

        if (currentScroll > 50) {
          requestAnimationFrame(() => {
            const newHeight = document.documentElement.scrollHeight;
            window.scrollTo(0, currentScroll + (newHeight - originalHeight));
          });
        }

      } catch (err) {
        console.warn('Silent polling failed:', err.message);
      }
    }

    /* ═══════════════════════════════════════════════
       FEED LOADERS
    ══════════════════════════════════════════════════ */

    function checkInfiniteScroll() {
      const activePanel = document.querySelector('.tab-panel.active');
      if (!activePanel) return;

      const btn = activePanel.querySelector('.load-more-btn');
      if (btn && !btn.disabled) {
        const rect = btn.getBoundingClientRect();
        if (rect.top > 0 && rect.top <= window.innerHeight + 800) {
          handleLoadMore(btn);
        }
      }
    }

    let scrollTimeout = null;
    window.addEventListener('scroll', () => {
      if (!scrollTimeout) {
        scrollTimeout = requestAnimationFrame(() => {
          checkInfiniteScroll();
          scrollTimeout = null;
        });
      }
    }, { passive: true });

    async function filterForFollowing(page) {
      if (state.account && state.account.id) {
        state.knownFollowing.add(state.account.id);
      }
      const idsToCheck = new Set();
      page.forEach(p => {
        const authorId = (p.reblog || p).account.id;
        if (!state.knownFollowing.has(authorId) && !state.knownNotFollowing.has(authorId)) {
          idsToCheck.add(authorId);
        }
      });
      const idsArr = Array.from(idsToCheck);
      if (idsArr.length > 0) {
        for (let i = 0; i < idsArr.length; i += 40) {
          const chunk = idsArr.slice(i, i + 40);
          const relPath = '/api/v1/accounts/relationships?' + chunk.map(id => `id[]=${id}`).join('&');
          try {
            const rels = await apiGet(relPath, state.token);
            rels.forEach(r => {
              if (r.following) state.knownFollowing.add(r.id);
              else state.knownNotFollowing.add(r.id);
            });
          } catch (err) {
            chunk.forEach(id => state.knownFollowing.add(id)); // Fail open
          }
        }
      }
      return page.filter(p => {
        const inner = p.reblog || p;
        return state.knownFollowing.has(inner.account.id);
      });
    }

    async function ensureHomeFeedLoaded() {
      if (state.demoMode) {
        if (!state.homeFeed) state.homeFeed = getDemoHomePosts();
        if (!state.followedHashtags) state.followedHashtags = getDemoHashtagData().tags;
        return;
      }
      if (!state.homeFeed) {
        const posts = await apiGet('/api/v1/timelines/home?limit=40', state.token);
        const tags = await apiGet('/api/v1/followed_tags?limit=100', state.token).catch(() => []);
        state.followedHashtags = tags;
        const followedTagNames = new Set(tags.map(t => t.name.toLowerCase()));

        posts.forEach(p => {
          p._sourceTags = [];
          const inner = p.reblog || p;
          if (inner.tags && Array.isArray(inner.tags)) {
            inner.tags.forEach(t => {
              if (followedTagNames.has(t.name.toLowerCase())) {
                p._sourceTags.push(t.name.toLowerCase());
              }
            });
          }
        });

        state.homeFeed = posts;
        state.homeMaxId = posts.length ? posts[posts.length - 1].id : null;
      }
    }

    /* ─── TRENDING TAB ─── */
    function formatCount(n) {
      if (n >= 1000000) return (n / 1000000).toFixed(1) + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1) + 'K';
      return String(n);
    }

    function buildSparkline(history) {
      if (!Array.isArray(history) || history.length === 0) return '';
      // history is newest first, we want oldest first for left-to-right display
      const values = history.slice(0, 7).reverse().map(h => parseInt(h.uses, 10) || 0);
      const maxVal = Math.max(...values, 1);
      const bars = values.map(v => {
        const pct = Math.round((v / maxVal) * 100);
        return `<div class="sparkline-bar" style="height:${Math.max(pct, 5)}%"></div>`;
      }).join('');
      return `<div class="trending-tag-sparkline">${bars}</div>`;
    }

    async function loadTrendingPosts() {
      const container = $('trending-posts-list');
      const loading = $('trending-posts-loading');
      const errEl = $('trending-posts-error');

      errEl.classList.remove('visible');
      $('trending-posts-skeleton').innerHTML = makeSkeleton(5);
      loading.style.display = 'flex';
      container.innerHTML = '';

      try {
        const posts = await apiGet('/api/v1/trends/statuses?limit=20', state.token);
        loading.style.display = 'none';

        if (!Array.isArray(posts) || posts.length === 0) {
          container.innerHTML = `<div class="feed-status"><div class="status-icon">📈</div><p>No trending posts right now.</p></div>`;
          return;
        }

        container.innerHTML = posts.map(p => renderPost(p, { tags: [] })).join('');
        state.trendingPostsLoaded = true;
      } catch (err) {
        loading.style.display = 'none';
        errEl.textContent = 'Could not load trending posts: ' + err.message;
        errEl.classList.add('visible');
      }
    }

    async function loadTrendingHashtags() {
      const container = $('trending-hashtags-list');
      const loading = $('trending-hashtags-loading');
      const errEl = $('trending-hashtags-error');

      errEl.classList.remove('visible');
      $('trending-hashtags-skeleton').innerHTML = makeSkeleton(3);
      loading.style.display = 'flex';
      container.innerHTML = '';

      try {
        const tags = await apiGet('/api/v1/trends/tags?limit=20', state.token);
        loading.style.display = 'none';

        if (!Array.isArray(tags) || tags.length === 0) {
          container.innerHTML = `<div class="feed-status"><div class="status-icon">#️⃣</div><p>No trending hashtags right now.</p></div>`;
          return;
        }

        container.innerHTML = tags.map((tag, i) => {
          const totalUses = (tag.history || []).reduce((s, h) => s + (parseInt(h.uses, 10) || 0), 0);
          const todayAccounts = tag.history && tag.history[0] ? parseInt(tag.history[0].accounts, 10) || 0 : 0;
          const sparkline = buildSparkline(tag.history);
          return `
            <a class="trending-tag-row" href="#" data-trending-tag="${escapeHTML(tag.name)}">
              <span class="trending-tag-rank">${i + 1}</span>
              <div class="trending-tag-main">
                <div class="trending-tag-name">#${escapeHTML(tag.name)}</div>
                <div class="trending-tag-meta">
                  <span class="trending-tag-stat">${formatCount(totalUses)} uses</span>
                  <span class="trending-tag-stat">&middot; ${formatCount(todayAccounts)} people today</span>
                </div>
              </div>
              ${sparkline}
            </a>`;
        }).join('');
        state.trendingHashtagsLoaded = true;
      } catch (err) {
        loading.style.display = 'none';
        errEl.textContent = 'Could not load trending hashtags: ' + err.message;
        errEl.classList.add('visible');
      }
    }

    async function loadTrendingPeople() {
      const container = $('trending-people-list');
      const loading = $('trending-people-loading');
      const errEl = $('trending-people-error');

      errEl.classList.remove('visible');
      $('trending-people-skeleton').innerHTML = makeSkeleton(3);
      loading.style.display = 'flex';
      container.innerHTML = '';

      try {
        // GET /api/v1/directory?order=active&limit=12 — local active accounts
        const people = await apiGet('/api/v1/directory?order=active&limit=12&local=true', state.token);
        loading.style.display = 'none';

        if (!Array.isArray(people) || people.length === 0) {
          container.innerHTML = `<div class="feed-status"><div class="status-icon">👥</div><p>No accounts found.</p></div>`;
          return;
        }

        container.innerHTML = people.map(acct => `
          <div class="trending-person-card" data-profile-id="${escapeHTML(acct.id)}" data-profile-server="">
            <div class="trending-person-avatar">
              <img src="${escapeHTML(acct.avatar_static || acct.avatar)}" alt="" loading="lazy" />
            </div>
            <div class="trending-person-name">${renderCustomEmojis(acct.display_name || acct.username, acct.emojis || [])}</div>
            <div class="trending-person-acct">@${escapeHTML(acct.acct)}</div>
            <div class="trending-person-stats">
              <div class="trending-person-stat">
                <span class="trending-person-stat-val">${formatCount(acct.followers_count || 0)}</span>
                <span class="trending-person-stat-label">followers</span>
              </div>
              <div class="trending-person-stat">
                <span class="trending-person-stat-val">${formatCount(acct.statuses_count || 0)}</span>
                <span class="trending-person-stat-label">posts</span>
              </div>
            </div>
          </div>`).join('');
        state.trendingPeopleLoaded = true;
      } catch (err) {
        loading.style.display = 'none';
        errEl.textContent = 'Could not load people: ' + err.message;
        errEl.classList.add('visible');
      }
    }

    async function loadTrendingNews() {
      const container = $('trending-news-list');
      const loading = $('trending-news-loading');
      const errEl = $('trending-news-error');

      errEl.classList.remove('visible');
      $('trending-news-skeleton').innerHTML = makeSkeleton(4);
      loading.style.display = 'flex';
      container.innerHTML = '';

      try {
        // GET /api/v1/trends/links — trending links/articles
        const links = await apiGet('/api/v1/trends/links?limit=20', state.token);
        loading.style.display = 'none';

        if (!Array.isArray(links) || links.length === 0) {
          container.innerHTML = `<div class="feed-status"><div class="status-icon">📰</div><p>No trending links right now.</p></div>`;
          return;
        }

        container.innerHTML = links.map(link => {
          const totalUses = (link.history || []).reduce((s, h) => s + (parseInt(h.uses, 10) || 0), 0);
          const provider = link.provider_name || link.author_name || (link.url ? new URL(link.url).hostname.replace('www.', '') : '');
          const thumb = link.image
            ? `<div class="trending-link-thumb"><img src="${escapeHTML(link.image)}" alt="" loading="lazy" /></div>`
            : `<div class="trending-link-thumb"><div class="trending-link-thumb-placeholder"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 22h16a2 2 0 0 0 2-2V4a2 2 0 0 0-2-2H8a2 2 0 0 0-2 2v16a2 2 0 0 1-2 2Zm0 0a2 2 0 0 1-2-2v-9c0-1.1.9-2 2-2h2"/></svg></div></div>`;
          return `
            <a class="trending-link-card" href="${escapeHTML(link.url)}" target="_blank" rel="noopener noreferrer">
              ${thumb}
              <div class="trending-link-body">
                ${provider ? `<div class="trending-link-provider">${escapeHTML(provider)}</div>` : ''}
                <div class="trending-link-title">${escapeHTML(link.title || link.url)}</div>
                ${link.description ? `<div class="trending-link-desc">${escapeHTML(link.description)}</div>` : ''}
                <div class="trending-link-stat">${formatCount(totalUses)} shares</div>
              </div>
            </a>`;
        }).join('');
        state.trendingNewsLoaded = true;
      } catch (err) {
        loading.style.display = 'none';
        errEl.textContent = 'Could not load trending news: ' + err.message;
        errEl.classList.add('visible');
      }
    }

    async function loadTrendingTab() {
      window.scrollTo({ top: 0, behavior: 'instant' });
      // Reset to first subtab
      document.querySelectorAll('.trending-subtab-btn').forEach((b, i) => b.classList.toggle('active', i === 0));
      document.querySelectorAll('.trending-subpanel').forEach((p, i) => p.classList.toggle('active', i === 0));

      // Always reload posts on tab switch (they change frequently)
      state.trendingPostsLoaded = false;
      state.trendingHashtagsLoaded = false;
      state.trendingPeopleLoaded = false;
      state.trendingNewsLoaded = false;

      loadTrendingPosts();
      loadTrendingHashtags();
      loadTrendingPeople();
      loadTrendingNews();
    }

    function renderFilteredPosts(tab, displayPosts) {
      const container = $(`${tab}-posts`);
      if (!displayPosts.length) {
        let msg = "Nothing here yet.";
        if (tab === 'following') msg = "No recent posts from people you follow.";
        if (tab === 'hashtags') msg = "No recent posts matching your hashtags.";
        container.innerHTML = `<div class="feed-status"><div class="status-icon">📭</div><p>${msg}</p></div>`;
        return;
      }

      let maxId = state.homeMaxId;
      if (tab === 'hashtags' && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
        maxId = state.hashtagMaxId;
      }

      const html = displayPosts.map(p => renderPost(p, { tags: p._sourceTags || [] })).join('');
      const loadMoreBtn = maxId ? `<button class="load-more-btn" data-feed="${tab}">Load More</button>` : '';
      container.innerHTML = html + loadMoreBtn;
      setTimeout(checkInfiniteScroll, 100);
    }

    async function loadHomeTab() {
      window.scrollTo({ top: 0, behavior: 'instant' });
      setLoading('home', true);
      setError('home', null);

      try {
        await ensureHomeFeedLoaded();
        renderFilteredPosts('home', state.homeFeed);
      } catch (err) {
        setError('home', "Failed to load feed");
      }
      setLoading('home', false);
    }

    async function loadFollowingTab() {
      window.scrollTo({ top: 0, behavior: 'instant' });
      setLoading('following', true);
      setError('following', null);

      try {
        await ensureHomeFeedLoaded();
        const display = state.demoMode ? state.homeFeed.filter(p => !p.reblog) : await filterForFollowing(state.homeFeed);
        renderFilteredPosts('following', display);
      } catch (err) {
        setError('following', "Failed to load following feed: " + err.message);
      }
      setLoading('following', false);
    }

    async function loadHashtagsTab() {
      window.scrollTo({ top: 0, behavior: 'instant' });
      setLoading('hashtags', true);
      setError('hashtags', null);
      $('hashtags-posts').innerHTML = '';

      try {
        if (!state.demoMode) {
          const tags = await apiGet('/api/v1/followed_tags?limit=100', state.token).catch(() => []);
          state.followedHashtags = tags;
        }
        await ensureHomeFeedLoaded();
        const tags = state.followedHashtags || [];

        // Build filter dropdown
        const filterSelect = $('hashtag-filter-select');
        filterSelect.innerHTML = '<option value="all">All Followed Hashtags</option>';
        const sortedTags = [...tags].sort((a, b) => a.name.toLowerCase().localeCompare(b.name.toLowerCase()));

        let found = state.selectedHashtagFilter === 'all';
        sortedTags.forEach(t => {
          const opt = document.createElement('option');
          opt.value = t.name.toLowerCase();
          opt.textContent = '#' + t.name;
          if (state.selectedHashtagFilter === t.name.toLowerCase()) {
            opt.selected = true;
            found = true;
          }
          filterSelect.appendChild(opt);
        });

        // Add searched tag if not following
        if (!found && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
          const opt = document.createElement('option');
          opt.value = state.selectedHashtagFilter;
          opt.textContent = '#' + state.selectedHashtagFilter;
          opt.selected = true;
          filterSelect.appendChild(opt);
        }

        // Update Follow Button
        const followBtn = $('hashtag-follow-btn');
        if (state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
          const isFollowing = tags.some(t => t.name.toLowerCase() === state.selectedHashtagFilter);
          followBtn.style.display = 'block';
          followBtn.textContent = isFollowing ? 'Following' : `Follow #${state.selectedHashtagFilter}`;
          followBtn.dataset.tag = state.selectedHashtagFilter;
          followBtn.dataset.following = isFollowing ? 'true' : 'false';
          followBtn.classList.toggle('following', isFollowing);
        } else {
          followBtn.style.display = 'none';
        }

        let display = [];
        if (state.demoMode) {
          display = state.homeFeed.filter(p => p._sourceTags && p._sourceTags.length > 0);
          if (state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
            display = display.filter(p => p._sourceTags.includes(state.selectedHashtagFilter));
          }
        } else {
          if (state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
            const tag = encodeURIComponent(state.selectedHashtagFilter);
            const tagPosts = await apiGet(`/api/v1/timelines/tag/${tag}?limit=40`, state.token);
            tagPosts.forEach(p => p._sourceTags = [state.selectedHashtagFilter]);
            state.hashtagFeed = tagPosts;
            state.hashtagMaxId = tagPosts.length ? tagPosts[tagPosts.length - 1].id : null;
            display = tagPosts;
          } else {
            display = state.homeFeed.filter(p => p._sourceTags && p._sourceTags.length > 0);
            state.hashtagMaxId = state.homeMaxId;
          }
        }

        renderFilteredPosts('hashtags', display);
      } catch (err) {
        setError('hashtags', "Failed to load hashtags feed: " + err.message);
      }
      setLoading('hashtags', false);
    }

    function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

    /* ═══════════════════════════════════════════════
       PROFILE DRAWER
    ══════════════════════════════════════════════════ */

    function openProfileDrawer(accountId, server) {
      const drawer = $('profile-drawer');
      const backdrop = $('profile-backdrop');
      const content = $('profile-content');

      // Show spinner
      content.innerHTML = `<div class="profile-loading"><div class="spinner"></div></div>`;
      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      backdrop.classList.add('open');
      document.body.style.overflow = 'hidden';

      const srv = server || state.server;

      Promise.all([
        apiGet(`/api/v1/accounts/${accountId}`, state.token, srv),
        apiGet(`/api/v1/accounts/${accountId}/statuses?limit=20&exclude_replies=true`, state.token, srv),
        apiGet(`/api/v1/accounts/relationships?id[]=${accountId}`, state.token, srv).catch(() => []),
        apiGet(`/api/v1/accounts/${accountId}/statuses?pinned=true`, state.token, srv).catch(() => []),
      ]).then(([account, statuses, relationships, pinnedStatuses]) => {
        const relationship = relationships && relationships.length ? relationships[0] : null;
        const isFollowing = relationship && relationship.following;

        const headerImg = account.header && !account.header.includes('missing')
          ? `<img class="profile-header-img" src="${escapeHTML(account.header)}" alt="" loading="lazy"/>`
          : `<div class="profile-header-img empty"></div>`;

        const bio = account.note
          ? `<div class="profile-bio">${account.note}</div>`
          : '';

        const isSelf = state.account && state.account.id === accountId;

        const followButton = isSelf
          ? `<a
              class="profile-edit-btn"
              href="https://${srv}/settings/profile"
              target="_blank"
              rel="noopener"
            >Edit Profile</a>`
          : `<button
              class="profile-follow-btn ${isFollowing ? 'following' : ''}"
              data-account-id="${accountId}"
              data-following="${isFollowing ? 'true' : 'false'}"
            >${isFollowing ? 'Following' : 'Follow'}</button>`;

        const postsHtml = statuses.length
          ? statuses.map(s => renderPost(s)).join('')
          : `<div class="feed-status"><p style="font-size:13px;">No posts yet.</p></div>`;

        // ── Pinned posts ──────────────────────────────────────────────
        let pinnedHtml = '';
        // The ?pinned=true query already guarantees all returned posts are pinned.
        // The .pinned property is only true for your own posts; for other accounts
        // it is null/false even though the posts are genuinely pinned.
        const pinned = pinnedStatuses || [];
        if (pinned.length === 1) {
          pinnedHtml = `
        <div class="pinned-section">
          <div class="pinned-header">
            <div class="pinned-header-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17z"/></svg>
              pinned
            </div>
          </div>
          <div class="pinned-single">${renderPost(pinned[0])}</div>
        </div>`;
        } else if (pinned.length > 1) {
          const carouselId = `pinned-carousel-${accountId}`;
          const slides = pinned.map((s, i) =>
            `<div class="pinned-slide${i === 0 ? ' active' : ''}" data-index="${i}">${renderPost(s)}</div>`
          ).join('');
          pinnedHtml = `
        <div class="pinned-section">
          <div class="pinned-header">
            <div class="pinned-header-label">
              <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="17" x2="12" y2="22"/><path d="M5 17h14v-1.76a2 2 0 0 0-1.11-1.79l-1.78-.9A2 2 0 0 1 15 10.76V6h1a2 2 0 0 0 0-4H8a2 2 0 0 0 0 4h1v4.76a2 2 0 0 1-1.11 1.79l-1.78.9A2 2 0 0 0 5 15.24V17z"/></svg>
              pinned
            </div>
            <div class="pinned-header-nav">
              <button class="pinned-nav prev" aria-label="Previous pinned post">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="15 18 9 12 15 6"/></svg>
              </button>
              <span class="pinned-counter">1 / ${pinned.length}</span>
              <button class="pinned-nav next" aria-label="Next pinned post">
                <svg width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><polyline points="9 18 15 12 9 6"/></svg>
              </button>
            </div>
          </div>
          <div id="${carouselId}">${slides}</div>
          <div class="pinned-dots">${pinned.map((_, i) =>
            `<button class="pinned-dot${i === 0 ? ' active' : ''}" data-index="${i}" aria-label="Post ${i + 1}"></button>`
          ).join('')}</div>
        </div>`;
        }
        // ─────────────────────────────────────────────────────────────

        content.innerHTML = `
      ${headerImg}
      <div class="profile-identity">
        <div class="profile-avatar-wrap">
          <img class="profile-avatar-large" src="${escapeHTML(account.avatar_static || account.avatar)}" alt=""/>
        </div>
        <div class="profile-name-row">
          <div>
            <div class="profile-display-name">${renderCustomEmojis(account.display_name || account.username, account.emojis)}</div>
            <div class="profile-acct">@${escapeHTML(account.acct)}</div>
          </div>
          ${followButton}
        </div>
        ${bio}
        <div class="profile-stats">
          <div class="profile-stat">
            <span class="profile-stat-num">${formatNum(account.statuses_count)}</span>
            <span class="profile-stat-label">Posts</span>
          </div>
          <div class="profile-stat">
            <span class="profile-stat-num">${formatNum(account.following_count)}</span>
            <span class="profile-stat-label">Following</span>
          </div>
          <div class="profile-stat">
            <span class="profile-stat-num">${formatNum(account.followers_count)}</span>
            <span class="profile-stat-label">Followers</span>
          </div>
        </div>
        
        ${(account.fields && account.fields.length) ? `
          <div class="profile-fields">
            ${account.fields.map(f => {
          const isVerified = !!f.verified_at;
          return `
                <div class="profile-field ${isVerified ? 'verified' : ''}">
                  <span class="profile-field-name">${escapeHTML(f.name)}</span>
                  <div class="profile-field-value">${sanitizeHTML(f.value)}</div>
                  ${isVerified ? '<svg class="verified-icon" width="12" height="12" viewBox="0 0 24 24" fill="currentColor"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-2 15l-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8l-9 9z"/></svg>' : ''}
                </div>
              `;
        }).join('')}
          </div>
        ` : ''}

        <div class="profile-joined">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M19 4H5a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6a2 2 0 0 0-2-2z"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
          Joined ${new Date(account.created_at).toLocaleDateString(undefined, { year: 'numeric', month: 'long', day: 'numeric' })}
        </div>

        <a class="profile-open-link" href="${escapeHTML(account.url)}" target="_blank" rel="noopener">
          <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
          View on ${account.url ? new URL(account.url).hostname : srv}
        </a>
      </div>
      ${pinnedHtml}
      <div class="profile-posts-header">recent posts</div>
      ${postsHtml}
    `;

        // Wire up pinned navigation after HTML is injected
        if (pinned.length > 1) {
          const carouselEl = $(`pinned-carousel-${accountId}`);
          if (carouselEl) {
            const slides = carouselEl.querySelectorAll('.pinned-slide');
            const dots = carouselEl.closest('.pinned-section').querySelectorAll('.pinned-dot');
            const counter = carouselEl.closest('.pinned-section').querySelector('.pinned-counter');
            const total = slides.length;
            let current = 0;

            function goTo(idx) {
              slides[current].classList.remove('active');
              dots[current].classList.remove('active');
              current = (idx + total) % total;
              slides[current].classList.add('active');
              dots[current].classList.add('active');
              if (counter) counter.textContent = `${current + 1} / ${total}`;
            }

            carouselEl.closest('.pinned-section').querySelector('.pinned-nav.prev')
              .addEventListener('click', e => { e.stopPropagation(); goTo(current - 1); });
            carouselEl.closest('.pinned-section').querySelector('.pinned-nav.next')
              .addEventListener('click', e => { e.stopPropagation(); goTo(current + 1); });

            // Touch swipe on the slide container
            let touchStartX = 0;
            carouselEl.addEventListener('touchstart', e => { touchStartX = e.touches[0].clientX; }, { passive: true });
            carouselEl.addEventListener('touchend', e => {
              const dx = e.changedTouches[0].clientX - touchStartX;
              if (Math.abs(dx) > 40) goTo(dx < 0 ? current + 1 : current - 1);
            }, { passive: true });
          }
        }
      }).catch(err => {
        content.innerHTML = `<div class="feed-status" style="padding-top:60px;">
      <p style="font-size:13px;font-family:var(--font-mono);color:var(--danger);">Could not load profile.</p>
      <p class="status-sub">${escapeHTML(err.message)}</p>
    </div>`;
      });
    }

    function closeProfileDrawer() {
      const drawer = $('profile-drawer');
      const backdrop = $('profile-backdrop');
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('open');
      document.body.style.overflow = '';
    }

    function formatNum(n) {
      if (!n) return '0';
      if (n >= 1000000) return (n / 1000000).toFixed(1).replace(/\.0$/, '') + 'M';
      if (n >= 1000) return (n / 1000).toFixed(1).replace(/\.0$/, '') + 'K';
      return String(n);
    }

    // Close handlers
    $('profile-close').addEventListener('click', closeProfileDrawer);
    $('profile-backdrop').addEventListener('click', closeProfileDrawer);
    document.addEventListener('keydown', e => {
      if (e.key === 'Escape') {
        if (document.body.classList.contains('thread-inline-active') || $('thread-drawer').classList.contains('open')) {
          closeThreadDrawer();
        } else {
          closeProfileDrawer();
          closeComposeDrawer();
        }
      }
    });

    /* ═══════════════════════════════════════════════
       THREAD DRAWER
    ══════════════════════════════════════════════════ */

    function openThreadDrawer(statusId) {
      const isDesktop = window.innerWidth > 900;

      if (isDesktop) {
        // Desktop: replace feed with inline thread panel
        const inlineContent = $('thread-inline-content');
        inlineContent.innerHTML = `<div class="thread-status"><div class="spinner"></div></div>`;
        document.body.classList.add('thread-inline-active');
        loadThread(statusId, inlineContent);
      } else {
        // Mobile: slide-in drawer
        const drawer = $('thread-drawer');
        const backdrop = $('thread-backdrop');
        const content = $('thread-content');
        content.innerHTML = `<div class="thread-status"><div class="spinner"></div></div>`;
        drawer.classList.add('open');
        drawer.setAttribute('aria-hidden', 'false');
        backdrop.classList.add('open');
        document.body.style.overflow = 'hidden';
        loadThread(statusId, content);
      }
    }

    function closeThreadDrawer() {
      // Desktop inline mode
      document.body.classList.remove('thread-inline-active');
      // Mobile drawer mode
      const drawer = $('thread-drawer');
      const backdrop = $('thread-backdrop');
      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('open');
      document.body.style.overflow = '';
    }

    $('thread-close-btn').addEventListener('click', closeThreadDrawer);
    $('thread-backdrop').addEventListener('click', closeThreadDrawer);
    $('thread-back-btn').addEventListener('click', closeThreadDrawer);

    async function loadThread(statusId, container) {
      try {
        const [focalStatus, context] = await Promise.all([
          apiGet(`/api/v1/statuses/${statusId}`, state.token),
          apiGet(`/api/v1/statuses/${statusId}/context`, state.token),
        ]);

        const ancestors = context.ancestors || [];
        const descendants = context.descendants || [];

        renderThread(focalStatus, ancestors, descendants, container);
      } catch (err) {
        container.innerHTML = `
          <div class="thread-status">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
            <span>Could not load thread: ${escapeHTML(err.message)}</span>
          </div>`;
      }
    }

    /**
     * Build a tree from the flat descendants list.
     * Returns an array of node objects: { status, children: [...] }
     * starting from replies to focalId.
     */
    function buildReplyTree(descendants, rootId) {
      const map = {};
      const roots = [];

      // Index all by id
      descendants.forEach(s => { map[s.id] = { status: s, children: [] }; });

      // Wire up children
      descendants.forEach(s => {
        if (s.in_reply_to_id === rootId) {
          roots.push(map[s.id]);
        } else if (map[s.in_reply_to_id]) {
          map[s.in_reply_to_id].children.push(map[s.id]);
        } else {
          // Orphaned descendant (in_reply_to not in context) - attach at root level
          roots.push(map[s.id]);
        }
      });

      return roots;
    }

    /**
     * Render a post for use inside the thread drawer.
     * variant: 'ancestor' | 'focal' | 'reply'
     */
    function renderThreadPost(status, variant) {
      const isBoost = !!status.reblog;
      const s = isBoost ? status.reblog : status;

      // Media
      let mediaHTML = '';
      if (s.media_attachments && s.media_attachments.length > 0) {
        const count = Math.min(s.media_attachments.length, 4);
        const items = s.media_attachments.slice(0, 4).map(m => {
          const sensitive = s.sensitive;
          const blurClass = sensitive ? 'media-sensitive-blur' : '';
          const overlay = sensitive ? `<div class="sensitive-overlay" onclick="event.stopPropagation(); this.parentElement.querySelector('img,video').classList.remove('media-sensitive-blur'); this.style.display='none'">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94"/><path d="M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19"/><line x1="1" y1="1" x2="23" y2="23"/></svg>
            <span>sensitive content</span></div>` : '';
          if (m.type === 'image' || m.type === 'gifv') {
            return `<div class="media-item" data-full-url="${m.url}" data-type="image" onclick="expandMedia(this)"><img src="${m.preview_url || m.url}" alt="${(m.description || '').replace(/"/g, '&quot;')}" class="${blurClass}" loading="lazy" onload="adjustImageAlignment(this)"/>${overlay}</div>`;
          } else if (m.type === 'video') {
            return `<div class="media-item" data-full-url="${m.url}" data-type="video" onclick="expandMedia(this)"><video src="${m.url}" poster="${m.preview_url || ''}" controls muted class="${blurClass}"></video>${overlay}</div>`;
          }
          return '';
        }).join('');
        mediaHTML = `<div class="post-media"><div class="post-media-grid count-${count}">${items}</div></div>`;
      }

      // Poll
      let pollHTML = '';
      if (s.poll) {
        const total = s.poll.votes_count || 1;
        const options = s.poll.options.map(opt => {
          const pct = total > 0 ? Math.round((opt.votes_count / total) * 100) : 0;
          return `<div class="poll-option"><div class="poll-bar" style="width:${pct}%"></div><span class="poll-option-text">${escapeHTML(opt.title)}</span><span class="poll-pct">${pct}%</span></div>`;
        }).join('');
        pollHTML = `<div class="post-poll">${options}<div class="poll-meta">${total} votes · ${s.poll.expired ? 'closed' : 'open'}</div></div>`;
      }

      // Quote
      let quoteHTML = '';
      const qStatus = s.quote && (s.quote.quoted_status || (s.quote.account ? s.quote : null));
      if (qStatus) {
        const qHasCW = (qStatus.spoiler_text && qStatus.spoiler_text.length > 0) || qStatus.sensitive;
        const qCwText = qStatus.spoiler_text ? escapeHTML(qStatus.spoiler_text) : 'Sensitive content';
        const qCwId = `qcw-thread-${qStatus.id}-${status.id}`;
        let qContentHTML = qHasCW
          ? `<div class="cw-wrapper"><div class="cw-summary" style="cursor:pointer;" onclick="event.stopPropagation(); window.toggleCW('${qCwId}', this.querySelector('.cw-toggle'))"><span>${qCwText}</span><button class="cw-toggle" onclick="event.stopPropagation(); window.toggleCW('${qCwId}', this)">show</button></div><div class="cw-body" id="${qCwId}"><div class="post-content">${processContent(sanitizeHTML(qStatus.content))}</div></div></div>`
          : `<div class="post-content" style="margin-bottom:0">${processContent(sanitizeHTML(qStatus.content))}</div>`;
        quoteHTML = `<div class="post-quote" onclick="event.stopPropagation(); window.open('${qStatus.url}', '_blank')">
          <div class="post-header" style="margin-bottom:8px;">
            <div class="post-avatar" style="width:24px;height:24px;"><img src="${qStatus.account.avatar_static || qStatus.account.avatar}" alt="" loading="lazy"/></div>
            <div class="post-meta"><div class="post-author" style="font-size:13px;"><span class="post-display-name">${renderCustomEmojis(qStatus.account.display_name || qStatus.account.username, qStatus.account.emojis)}</span><span class="post-acct">@${escapeHTML(qStatus.account.acct)}</span><span class="post-time">${relativeTime(qStatus.created_at)}</span></div></div>
          </div>${qContentHTML}</div>`;
      }

      // Content warning
      const hasCW = (s.spoiler_text && s.spoiler_text.length > 0) || s.sensitive;
      const cwText = s.spoiler_text ? escapeHTML(s.spoiler_text) : 'Sensitive content';
      const cwId = `cw-thread-${status.id}`;
      let contentHTML = '';
      if (hasCW) {
        contentHTML = `<div class="cw-wrapper"><div class="cw-summary" style="cursor:pointer;" onclick="event.stopPropagation(); window.toggleCW('${cwId}', this.querySelector('.cw-toggle'))"><span>${cwText}</span><button class="cw-toggle" onclick="event.stopPropagation(); window.toggleCW('${cwId}', this)">show</button></div><div class="cw-body" id="${cwId}"><div class="post-content">${processContent(sanitizeHTML(s.content))}</div>${mediaHTML}${pollHTML}${quoteHTML}</div></div>`;
      } else {
        contentHTML = `<div class="post-content">${processContent(sanitizeHTML(s.content))}</div>${mediaHTML}${pollHTML}${quoteHTML}`;
      }

      // Boost header
      const boostBy = isBoost ? status.account : null;
      const boostLabelHTML = boostBy ? `<div class="boost-divider"><div class="boost-text"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg><span class="post-display-name" data-profile-id="${boostBy.id}" data-profile-server="">${renderCustomEmojis(boostBy.display_name || boostBy.username, boostBy.emojis)}</span> <span style="opacity:0.8;text-transform:uppercase;font-size:11px;font-weight:500;">boosted</span></div><div class="boost-divider-line"></div></div>` : '';

      const variantClass = variant === 'focal' ? 'thread-post-focal' : variant === 'ancestor' ? 'thread-post-ancestor' : 'thread-post-reply';

      return `
        <div class="${variantClass}" data-status-id="${s.id}">
          <article class="post" data-id="${status.id}">
            ${boostLabelHTML}
            <div class="post-header">
              <div class="post-avatar" data-profile-id="${s.account.id}" data-profile-server="" style="cursor:pointer">
                <img src="${s.account.avatar_static || s.account.avatar}" alt="${escapeHTML(s.account.display_name || s.account.username)}" loading="lazy"/>
              </div>
              <div class="post-meta">
                <div class="post-author">
                  <span class="post-display-name" data-profile-id="${s.account.id}" data-profile-server="">${renderCustomEmojis(s.account.display_name || s.account.username, s.account.emojis)}</span>
                  <span class="post-acct">@${escapeHTML(s.account.acct)}</span>
                  <span class="post-time">${relativeTime(s.created_at)}</span>
                </div>
              </div>
            </div>
            ${contentHTML}
            <div class="post-footer">
              <button class="post-stat post-reply-btn" data-post-id="${s.id}" data-account-acct="${s.account.acct}" title="Reply">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 10l5-5v3c8 0 13 4 13 11-3-4-7-5-13-5v3l-5-5z"></path></svg>
                <span style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim);">${s.replies_count || 0}</span>
              </button>
              <div style="position:relative;display:inline-flex;">
                <button class="post-stat post-boost-btn ${s.reblogged ? 'boosted' : ''}" data-post-id="${s.id}" title="Boost or Quote">
                  <svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" style="color:var(--boost)"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                  <span class="boost-count" style="font-family:var(--font-mono);font-size:12px;color:var(--text-dim);">${(s.reblogs_count || 0) + (s.quotes_count || 0)}</span>
                </button>
                <div class="boost-dropdown" id="boost-menu-${s.id}">
                  <button class="boost-dropdown-item" data-action="boost" data-post-id="${s.id}" data-is-boosted="${s.reblogged ? 'true' : 'false'}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M17 1l4 4-4 4"/><path d="M3 11V9a4 4 0 0 1 4-4h14"/><path d="M7 23l-4-4 4-4"/><path d="M21 13v2a4 4 0 0 1-4 4H3"/></svg>
                    <span>${s.reblogged ? 'Undo Boost' : 'Boost'}</span>
                    <span class="dropdown-stat-count" style="margin-left:auto;color:var(--text-muted);font-size:12.5px;font-family:var(--font-mono);">${s.reblogs_count || 0}</span>
                  </button>
                  <button class="boost-dropdown-item" data-action="quote" data-post-id="${s.id}" data-acct="${escapeHTML(s.account.acct)}">
                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M10 11h-4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2zm10 0h-4a2 2 0 0 1-2-2v-4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v4a2 2 0 0 1-2 2z"/></svg>
                    <span>Quote</span>
                    <span class="dropdown-stat-count" style="margin-left:auto;color:var(--text-muted);font-size:12.5px;font-family:var(--font-mono);">${s.quotes_count || 0}</span>
                  </button>
                </div>
              </div>
              <button class="post-stat post-fav-btn ${s.favourited ? 'favourited' : ''}" data-post-id="${s.id}" data-favourited="${s.favourited ? 'true' : 'false'}" title="${s.favourited ? 'Unfavorite' : 'Favorite'}">
                <svg width="13" height="13" viewBox="0 0 24 24" fill="${s.favourited ? 'currentColor' : 'none'}" stroke="currentColor" stroke-width="2" style="color:var(--fav)"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>
                <span class="post-fav-count">${s.favourites_count || 0}</span>
              </button>
              <a href="${s.url}" target="_blank" rel="noopener" style="margin-left:auto;color:var(--text-dim);font-family:var(--font-mono);font-size:11px;text-decoration:none;" title="Open original">↗</a>
            </div>
          </article>
        </div>`;
    }

    /**
     * Render the reply tree using a flat timeline approach.
     * Direct replies to root are shown at full width.
     * Their children are grouped in a .thread-reply-children container
     * with a left-border line — at most ONE level of visual indentation.
     * A "Replying to @user" tag is shown above each non-root reply.
     * Deep sub-replies (depth 3+) are shown flat after the parent, with
     * a reply-to tag identifying the chain.
     */
    function renderReplyTree(nodes, depth, parentAcct) {
      return nodes.map(node => {
        const s = node.status.reblog ? node.status.reblog : node.status;
        const replyToTag = (depth > 1 && parentAcct)
          ? `<div class="thread-reply-to">
               <svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"><path d="M3 10l5-5v3c8 0 13 4 13 11-3-4-7-5-13-5v3l-5-5z"/></svg>
               Replying to <span class="thread-reply-to-acct">@${escapeHTML(parentAcct)}</span>
             </div>`
          : '';

        const postHTML = replyToTag + renderThreadPost(node.status, 'reply');

        // Children: indent 1 level with a left border, then go flat
        const childrenHTML = node.children.length > 0
          ? `<div class="thread-reply-children">${renderReplyTree(node.children, depth + 1, s.account.acct)}</div>`
          : '';

        return postHTML + childrenHTML;
      }).join('');
    }

    function renderThread(focalStatus, ancestors, descendants, container) {
      const parts = [];

      // ANCESTORS — show from oldest to newest, each with a connector line threading them down
      if (ancestors.length > 0) {
        parts.push(`<div class="thread-section-label">Context (${ancestors.length})</div>`);
        ancestors.forEach(s => {
          parts.push(renderThreadPost(s, 'ancestor'));
        });
      }

      // FOCAL POST label
      parts.push(`<div class="thread-focal-label">This post</div>`);

      // FOCAL POST
      parts.push(renderThreadPost(focalStatus, 'focal'));

      // DESCENDANTS — build tree from flat list
      if (descendants.length > 0) {
        parts.push(`<div class="thread-section-label">Replies (${descendants.length})</div>`);
        const focalId = focalStatus.reblog ? focalStatus.reblog.id : focalStatus.id;
        const tree = buildReplyTree(descendants, focalId);
        parts.push(renderReplyTree(tree, 1, null));
      } else {
        parts.push(`<div class="thread-status" style="padding:24px;"><span style="font-size:12px;font-family:var(--font-mono);opacity:0.6;">No replies yet</span></div>`);
      }

      container.innerHTML = parts.join('');

      // Scroll to focal post
      const focalEl = container.querySelector('.thread-post-focal');
      if (focalEl) {
        requestAnimationFrame(() => {
          focalEl.scrollIntoView({ block: 'start', behavior: 'instant' });
          // Offset for the sticky header
          container.scrollTop = Math.max(0, container.scrollTop - 60);
        });
      }
    }

    /* ═══════════════════════════════════════════════
       COMPOSE DRAWER
    ══════════════════════════════════════════════════ */

    const composeState = {
      mediaFiles: [],
      mediaUrls: [],
      mediaDescriptions: [],
      sidebarMediaFiles: [],
      sidebarMediaUrls: [],
      sidebarMediaDescriptions: [],
      replyToId: null,
      replyToAcct: null,
      quoteId: null,
      activeAltIndex: -1,
      activeAltSuffix: ''
    };

    function openAltModal(url, index, suffix, currentDesc) {
      composeState.activeAltIndex = index;
      composeState.activeAltSuffix = suffix;

      $('alt-modal-img').src = url;
      $('alt-modal-input').value = currentDesc || '';
      $('alt-modal-count').textContent = 1500 - (currentDesc || '').length;

      $('alt-text-modal').style.display = 'flex';
      $('alt-modal-input').focus();
    }

    function closeAltModal() {
      $('alt-text-modal').style.display = 'none';
      composeState.activeAltIndex = -1;
      composeState.activeAltSuffix = '';
    }

    $('alt-modal-close').addEventListener('click', closeAltModal);
    $('alt-modal-cancel').addEventListener('click', closeAltModal);

    $('alt-modal-input').addEventListener('input', (e) => {
      let val = e.target.value;
      if (val.length > 1500) {
        e.target.value = val.slice(0, 1500);
        val = e.target.value;
      }
      $('alt-modal-count').textContent = 1500 - val.length;
    });

    $('alt-modal-save').addEventListener('click', () => {
      const idx = composeState.activeAltIndex;
      const sfx = composeState.activeAltSuffix;
      const desc = $('alt-modal-input').value.trim();

      if (idx > -1) {
        if (sfx === '-sidebar') {
          composeState.sidebarMediaDescriptions[idx] = desc;
        } else {
          composeState.mediaDescriptions[idx] = desc;
        }

        // Update alt button UI in preview
        const preview = $('compose-media-preview' + sfx);
        if (preview && preview.children[idx]) {
          const btn = preview.children[idx].querySelector('.compose-media-item-alt-btn');
          if (btn) {
            if (desc) {
              btn.classList.remove('missing');
              btn.textContent = 'ALT';
            } else {
              btn.classList.add('missing');
              btn.textContent = 'ALT';
            }
          }
        }
      }
      closeAltModal();
    });

    function resetReplyState() {
      composeState.replyToId = null;
      composeState.replyToAcct = null;
      composeState.quoteId = null;
      ['', '-sidebar'].forEach(suffix => {
        const bar = $('compose-reply-bar' + suffix);
        const nameNode = $('compose-reply-to' + suffix);
        const typeNode = $('compose-context-type' + suffix);
        const textarea = $('compose-textarea' + suffix);
        if (bar) bar.style.display = 'none';
        if (nameNode) nameNode.textContent = '';
        if (typeNode) typeNode.textContent = 'Replying to';
        if (textarea) textarea.innerText = '';
      });
      if (window.innerWidth > 900) updateSidebarCharCount(); else updateCharCount();
    }

    function handleReply(postId, acct) {
      composeState.replyToId = postId;
      composeState.replyToAcct = acct;
      const isDesktop = window.innerWidth > 900;
      const suffix = isDesktop ? '-sidebar' : '';
      const textarea = $('compose-textarea' + suffix);
      const bar = $('compose-reply-bar' + suffix);
      const to = $('compose-reply-to' + suffix);

      if (bar && to) {
        const typeNode = $('compose-context-type' + suffix);
        if (typeNode) typeNode.textContent = 'Replying to';
        bar.style.display = 'block';
        to.textContent = '@' + acct;
      }

      const mentionText = `@${acct} `;
      if (!textarea.innerText.includes(mentionText)) {
        textarea.innerText = mentionText + textarea.innerText;
      }

      if (!isDesktop) {
        openComposeDrawer();
      } else {
        textarea.focus();
        try {
          const sel = window.getSelection();
          const range = document.createRange();
          range.selectNodeContents(textarea);
          range.collapse(false);
          sel.removeAllRanges();
          sel.addRange(range);
        } catch (e) { }
      }
      if (isDesktop) updateSidebarCharCount(); else updateCharCount();
    }

    window.toggleBoostMenu = function (postId, triggerBtn) {
      document.querySelectorAll('.boost-dropdown').forEach(m => m.classList.remove('show'));
      // Prefer finding the menu relative to the clicked button to avoid duplicate-ID
      // collisions when the same post appears in multiple feed panels (e.g. Home + Following).
      const menu = triggerBtn
        ? triggerBtn.parentElement.querySelector('.boost-dropdown')
        : $(`boost-menu-${postId}`);
      if (menu) menu.classList.toggle('show');
    };

    window.addEventListener('click', () => {
      document.querySelectorAll('.boost-dropdown').forEach(m => m.classList.remove('show'));
    });

    window.handleQuoteInit = function (postId, acct) {
      document.querySelectorAll('.boost-dropdown').forEach(m => m.classList.remove('show'));
      composeState.quoteId = postId;
      composeState.replyToAcct = acct;
      const isDesktop = window.innerWidth > 900;
      const suffix = isDesktop ? '-sidebar' : '';
      const textarea = $('compose-textarea' + suffix);
      const bar = $('compose-reply-bar' + suffix);
      const to = $('compose-reply-to' + suffix);

      if (bar && to) {
        const typeNode = $('compose-context-type' + suffix);
        if (typeNode) typeNode.textContent = 'Quoting';
        bar.style.display = 'block';
        to.textContent = '@' + acct;
      }

      if (!isDesktop) {
        openComposeDrawer();
      } else {
        textarea.focus();
      }
    };

    window.handleBoostSubmit = async function (postId, isBoosted) {
      document.querySelectorAll('.boost-dropdown').forEach(m => m.classList.remove('show'));
      if (!state.token) {
        showToast("Please sign in to boost posts.");
        return;
      }

      const endpoint = isBoosted ? `/api/v1/statuses/${postId}/unreblog` : `/api/v1/statuses/${postId}/reblog`;

      try {
        const res = await fetch(`https://${state.server}${endpoint}`, {
          method: 'POST',
          headers: { 'Authorization': `Bearer ${state.token}` }
        });

        if (!res.ok) throw new Error("Failed to process boost");
        const statusResponse = await res.json();
        const actualStatus = statusResponse.reblog || statusResponse;

        // Optimistic UI update
        const menuBtn = document.querySelector(`.post-boost-btn[data-post-id="${postId}"]`);
        if (menuBtn) {
          const countSpan = menuBtn.querySelector('.boost-count');
          const isNowBoosted = actualStatus.reblogged === true;
          menuBtn.classList.toggle('boosted', isNowBoosted);
          if (countSpan) countSpan.textContent = (actualStatus.reblogs_count || 0) + (actualStatus.quotes_count || 0);

          const dropdownItems = menuBtn.nextElementSibling.querySelectorAll('.boost-dropdown-item');
          if (dropdownItems.length > 0) {
            const boostDropdownBtn = dropdownItems[0];
            boostDropdownBtn.setAttribute('onclick', `event.stopPropagation(); window.handleBoostSubmit('${postId}', ${isNowBoosted})`);

            // first span is the text 'Boost' / 'Undo Boost'
            const textSpan = boostDropdownBtn.querySelector('span:not(.dropdown-stat-count)');
            if (textSpan) textSpan.textContent = isNowBoosted ? 'Undo Boost' : 'Boost';

            // second span is the count
            const countNode = boostDropdownBtn.querySelector('.dropdown-stat-count');
            if (countNode) countNode.textContent = actualStatus.reblogs_count || 0;
          }
        }

      } catch (e) {
        showToast("Error updating boost: " + e.message);
      }
    };

    function openComposeDrawer() {
      const drawer = $('compose-drawer');
      const backdrop = $('compose-backdrop');

      drawer.classList.add('open');
      drawer.setAttribute('aria-hidden', 'false');
      backdrop.classList.add('open');

      // On mobile, lock background scroll so the feed doesn't drift
      if (window.innerWidth <= 900) {
        document.body.style.overflow = 'hidden';
      }

      // Focus textarea — slight delay lets the drawer animation start first
      setTimeout(() => $('compose-textarea').focus(), 300);
    }

    function closeComposeDrawer() {
      const drawer = $('compose-drawer');
      const backdrop = $('compose-backdrop');

      drawer.classList.remove('open');
      drawer.setAttribute('aria-hidden', 'true');
      backdrop.classList.remove('open');

      // Restore scroll lock
      document.body.style.overflow = '';

      // Blur textarea to dismiss the keyboard
      $('compose-textarea').blur();

      // Reset form
      $('compose-textarea').innerHTML = '';
      $('compose-cw-input').value = '';
      $('compose-cw-section').style.display = 'none';
      $('compose-cw-btn').classList.remove('active');
      $('compose-visibility').value = 'public';
      composeState.mediaFiles = [];
      composeState.mediaUrls = [];
      composeState.mediaDescriptions = [];
      $('compose-media-preview').innerHTML = '';
      resetReplyState();
      updateCharCount();
    }

    function updateCharCount() {
      const textarea = $('compose-textarea');
      const cwInput = $('compose-cw-input');
      const counter = $('compose-char-count');

      const textLength = textarea.innerText.trim().length;
      const cwLength = cwInput.value.length;
      const remaining = 500 - textLength - cwLength;

      counter.textContent = remaining;
      counter.classList.toggle('warning', remaining <= 50 && remaining > 0);
      counter.classList.toggle('error', remaining < 0);

      $('compose-post-btn').disabled = remaining < 0 || (textLength === 0 && composeState.mediaFiles.length === 0);
    }

    function updateSidebarCharCount() {
      const suffix = '-sidebar';
      const textarea = $('compose-textarea' + suffix);
      const cwInput = $('compose-cw-input' + suffix);
      const counter = $('compose-char-count' + suffix);

      const textLength = textarea.innerText.trim().length;
      const cwLength = cwInput.value.length;
      const remaining = 500 - textLength - cwLength;

      counter.textContent = remaining;
      counter.classList.toggle('warning', remaining <= 50 && remaining > 0);
      counter.classList.toggle('error', remaining < 0);

      $('compose-post-btn' + suffix).disabled = remaining < 0 || (textLength === 0 && composeState.sidebarMediaFiles.length === 0);
    }

    // Compose button click
    $('compose-btn').addEventListener('click', openComposeDrawer);
    $('compose-close').addEventListener('click', closeComposeDrawer);
    const closeCompose = () => closeComposeDrawer();
    $('compose-backdrop').addEventListener('click', closeCompose);
    $('compose-backdrop').addEventListener('touchend', closeCompose);

    // Character counter
    $('compose-textarea').addEventListener('input', updateCharCount);
    $('compose-cw-input').addEventListener('input', updateCharCount);

    // Content warning toggle
    $('compose-cw-btn').addEventListener('click', () => {
      const section = $('compose-cw-section');
      const btn = $('compose-cw-btn');
      const isVisible = section.style.display !== 'none';

      section.style.display = isVisible ? 'none' : 'block';
      btn.classList.toggle('active', !isVisible);

      if (!isVisible) {
        $('compose-cw-input').focus();
      } else {
        $('compose-cw-input').value = '';
        updateCharCount();
      }
    });

    // Media upload
    $('compose-media-btn').addEventListener('click', () => {
      $('compose-media-input').click();
    });

    $('compose-media-input').addEventListener('change', (e) => {
      const files = Array.from(e.target.files);
      if (files.length === 0) return;

      // Limit to 4 media files
      const available = 4 - composeState.mediaFiles.length;
      const toAdd = files.slice(0, available);

      toAdd.forEach(file => {
        composeState.mediaFiles.push(file);
        const url = URL.createObjectURL(file);
        composeState.mediaUrls.push(url);
        composeState.mediaDescriptions.push(''); // Empty desc to start

        const preview = $('compose-media-preview');
        const item = document.createElement('div');
        item.className = 'compose-media-item';

        const isVideo = file.type.startsWith('video/');
        const mediaEl = isVideo ? document.createElement('video') : document.createElement('img');
        mediaEl.src = url;
        if (isVideo) mediaEl.muted = true;

        const altBtn = document.createElement('button');
        altBtn.className = 'compose-media-item-alt-btn missing';
        altBtn.textContent = 'ALT';
        altBtn.onclick = () => {
          const idx = composeState.mediaUrls.indexOf(url);
          openAltModal(url, idx, '', composeState.mediaDescriptions[idx]);
        };

        const removeBtn = document.createElement('button');
        removeBtn.className = 'compose-media-remove';
        removeBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
        removeBtn.onclick = () => {
          const index = composeState.mediaUrls.indexOf(url);
          if (index > -1) {
            URL.revokeObjectURL(url);
            composeState.mediaFiles.splice(index, 1);
            composeState.mediaUrls.splice(index, 1);
            composeState.mediaDescriptions.splice(index, 1);
          }
          item.remove();
          updateCharCount();
        };

        item.appendChild(mediaEl);
        if (!isVideo) item.appendChild(altBtn);
        item.appendChild(removeBtn);
        preview.appendChild(item);
      });

      updateCharCount();
      e.target.value = ''; // Reset input
    });

    /* ─── MENTION AUTOCOMPLETE ─── */
    let mentionActiveRequest = null;
    let mentionCurrentQuery = '';
    let mentionTargetTextarea = null;
    let mentionSuggestions = [];
    let mentionSelectedIndex = -1;

    function initMentionAutocomplete() {
      const t1 = $('compose-textarea');
      const t2 = $('compose-textarea-sidebar');
      const list = $('mention-suggestions');

      [t1, t2].forEach(textarea => {
        if (!textarea) return;
        textarea.addEventListener('input', (e) => handleMentionInput(e, textarea));
        textarea.addEventListener('keydown', (e) => handleMentionKeydown(e, textarea));
        textarea.addEventListener('scroll', closeMentionSuggestions);
      });

      document.addEventListener('click', (e) => {
        if (!list.contains(e.target)) closeMentionSuggestions();
      });
      window.addEventListener('scroll', closeMentionSuggestions, { passive: true });
    }

    function handleMentionInput(e, textarea) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);
      if (range.startContainer.nodeType !== Node.TEXT_NODE) {
        closeMentionSuggestions();
        return;
      }
      const textBefore = range.startContainer.textContent.substring(0, range.startOffset);

      // Match @username (only at start or after whitespace)
      const match = textBefore.match(/(?:^|\s)@([a-zA-Z0-9_]*)$/);

      if (match) {
        mentionCurrentQuery = match[1];
        mentionTargetTextarea = textarea;
        fetchMentions(mentionCurrentQuery);
      } else {
        closeMentionSuggestions();
      }
    }

    async function fetchMentions(q) {
      if (mentionActiveRequest) mentionActiveRequest.abort();
      const controller = new AbortController();
      mentionActiveRequest = controller;

      try {
        const results = await apiGet(`/api/v1/accounts/search?q=${encodeURIComponent(q)}&limit=5&following=true`, state.token, null, controller.signal);
        mentionSuggestions = results;
        renderMentionSuggestions(results);
      } catch (err) {
        if (err.name !== 'AbortError') console.warn('Mention search failed:', err);
      }
    }

    function renderMentionSuggestions(users) {
      const list = $('mention-suggestions');
      if (!users.length) {
        closeMentionSuggestions();
        return;
      }

      list.innerHTML = users.map((u, i) => `
        <div class="mention-item ${i === 0 ? 'selected' : ''}" data-index="${i}" data-acct="${escapeHTML(u.acct)}">
          <img src="${u.avatar_static || u.avatar}" class="mention-avatar" loading="lazy" />
          <div class="mention-info">
            <span class="mention-name">${renderCustomEmojis(u.display_name || u.username, u.emojis)}</span>
            <span class="mention-acct">@${escapeHTML(u.acct)}</span>
          </div>
        </div>
      `).join('');

      list.style.display = 'flex';
      mentionSelectedIndex = users.length > 0 ? 0 : -1;

      // Position the list
      const sel = window.getSelection();
      if (sel.rangeCount) {
        const range = sel.getRangeAt(0);
        const rects = range.getClientRects();
        if (rects.length > 0) {
          const rect = rects[0];
          let top = rect.bottom + 10;
          let left = rect.left;

          // Keep within viewport
          if (left + 280 > window.innerWidth) left = window.innerWidth - 290;
          if (top + 300 > window.innerHeight) {
            top = rect.top - (users.length * 52) - 10;
          }

          list.style.top = top + 'px';
          list.style.left = Math.max(10, left) + 'px';
        }
      }

      // Handle click on item
      list.querySelectorAll('.mention-item').forEach(item => {
        item.onmousedown = (e) => e.preventDefault(); // maintain focus
        item.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          insertMention(item.dataset.acct);
        };
      });
    }

    function handleMentionKeydown(e, textarea) {
      const list = $('mention-suggestions');
      if (list.style.display === 'none') return;

      if (e.key === 'ArrowDown') {
        e.preventDefault();
        moveMentionSelection(1);
      } else if (e.key === 'ArrowUp') {
        e.preventDefault();
        moveMentionSelection(-1);
      } else if (e.key === 'Enter' || e.key === 'Tab') {
        if (mentionSelectedIndex > -1) {
          e.preventDefault();
          const acct = mentionSuggestions[mentionSelectedIndex].acct;
          insertMention(acct);
        }
      } else if (e.key === 'Escape') {
        closeMentionSuggestions();
      }
    }

    function moveMentionSelection(dir) {
      const items = $('mention-suggestions').querySelectorAll('.mention-item');
      if (!items.length) return;

      items[mentionSelectedIndex]?.classList.remove('selected');
      mentionSelectedIndex = (mentionSelectedIndex + dir + items.length) % items.length;
      items[mentionSelectedIndex].classList.add('selected');
      items[mentionSelectedIndex].scrollIntoView({ block: 'nearest' });
    }

    function insertMention(acct) {
      const sel = window.getSelection();
      if (!sel.rangeCount) return;
      const range = sel.getRangeAt(0);

      // Find the @ and the following text to replace it
      const node = range.startContainer;
      const text = node.textContent;
      const textBefore = text.substring(0, range.startOffset);
      const match = textBefore.match(/@([a-zA-Z0-9_]*)$/);

      if (match) {
        const startPos = match.index + (match[0].startsWith('@') ? 0 : 1);
        const endPos = range.startOffset;

        const newRange = document.createRange();
        newRange.setStart(node, startPos);
        newRange.setEnd(node, endPos);
        sel.removeAllRanges();
        sel.addRange(newRange);

        document.execCommand('insertText', false, `@${acct} `);
      }

      closeMentionSuggestions();
      if (mentionTargetTextarea === $('compose-textarea')) updateCharCount();
      else updateSidebarCharCount();
    }

    function closeMentionSuggestions() {
      $('mention-suggestions').style.display = 'none';
      mentionSelectedIndex = -1;
      if (mentionActiveRequest) mentionActiveRequest.abort();
      mentionActiveRequest = null;
    }

    initMentionAutocomplete();

    // Emoji picker logic
    let emojiPickerTarget = null;
    let updateCountCallback = null;
    let standardEmojis = [];
    let customEmojis = [];
    let standardEmojisLoaded = false;
    let customEmojisLoadedForServer = null;

    const emojiGroupNames = {
      0: "Smileys & Emotion",
      1: "People & Body",
      3: "Animals & Nature",
      4: "Food & Drink",
      5: "Travel & Places",
      6: "Activities",
      7: "Objects",
      8: "Symbols",
      9: "Flags"
    };

    async function loadStandardEmojis() {
      if (standardEmojisLoaded) return;
      standardEmojisLoaded = true;
      try {
        const res = await fetch('https://cdn.jsdelivr.net/npm/emojibase-data@7.0.1/en/compact.json');
        const standard = await res.json();
        standardEmojis = standard.filter(e => e.unicode && e.group !== 2).map(e => ({
          type: 'standard',
          char: e.unicode,
          name: e.label.toLowerCase(),
          group: e.group !== undefined ? e.group : 8
        }));
      } catch (e) {
        console.error('Failed to load standard emojis', e);
      }
    }

    async function loadCustomEmojis() {
      if (!state.server) return;
      if (customEmojisLoadedForServer === state.server) return;

      try {
        const headers = {};
        if (state.token) headers['Authorization'] = `Bearer ${state.token}`;
        const cres = await fetch(`https://${state.server}/api/v1/custom_emojis`, { headers });
        if (cres.ok) {
          const custom = await cres.json();
          customEmojis = custom.filter(c => c.visible_in_picker).map(c => ({
            type: 'custom',
            shortcode: c.shortcode,
            url: c.url,
            name: c.shortcode.toLowerCase(),
            group: c.category || 'Custom'
          }));

          // Sort custom emojis by category name then alphabetically
          customEmojis.sort((a, b) => {
            if (a.group !== b.group) return a.group.localeCompare(b.group);
            return a.name.localeCompare(b.name);
          });

          customEmojisLoadedForServer = state.server;
        }
      } catch (e) {
        console.error('Failed to load custom emojis', e);
      }
    }

    function initEmojiPicker() {
      const picker = $('emoji-picker');
      const search = $('emoji-search');
      const body = $('emoji-picker-body');

      function renderEmojis(filter = "") {
        body.innerHTML = '';
        const all = [...customEmojis, ...standardEmojis];
        const searchPhrase = filter.toLowerCase().trim();

        const filtered = searchPhrase
          ? all.filter(e => e.name.includes(searchPhrase)).slice(0, 140)
          : all;

        if (filtered.length === 0) {
          body.innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-dim); padding: 10px;">No emojis found</div>';
          return;
        }

        const fragment = document.createDocumentFragment();
        let currentGroup = null;

        filtered.forEach(e => {
          if (!searchPhrase) {
            let catName = e.type === 'custom' ? e.group : (emojiGroupNames[e.group] || 'Other');
            if (currentGroup !== catName) {
              currentGroup = catName;
              const header = document.createElement('div');
              header.className = 'emoji-category-title';
              header.textContent = catName;
              fragment.appendChild(header);
            }
          }

          const btn = document.createElement('button');
          btn.className = 'emoji-btn';
          btn.title = e.type === 'custom' ? `:${e.shortcode}:` : e.name;

          if (e.type === 'custom') {
            const img = document.createElement('img');
            img.src = e.url;
            img.style.width = '24px';
            img.style.height = '24px';
            img.style.objectFit = 'contain';
            img.loading = 'lazy';
            btn.appendChild(img);
          } else {
            btn.textContent = e.char;
          }

          btn.onmousedown = (ev) => ev.preventDefault(); // keep focus on textarea
          btn.onclick = (ev) => {
            ev.preventDefault();
            if (!emojiPickerTarget) return;
            const textarea = emojiPickerTarget;
            textarea.focus();

            if (e.type === 'custom') {
              document.execCommand('insertHTML', false, `&nbsp;<img src="${e.url}" alt=":${e.shortcode}:" class="compose-custom-emoji"/>&nbsp;`);
            } else {
              document.execCommand('insertText', false, e.char);
            }

            if (updateCountCallback) updateCountCallback();
            closeEmojiPicker();
          };
          fragment.appendChild(btn);
        });

        body.appendChild(fragment);
      }

      search.addEventListener('input', (e) => {
        renderEmojis(e.target.value);
      });

      document.addEventListener('click', (e) => {
        if (picker.style.display === 'flex' &&
          !picker.contains(e.target) &&
          !e.target.closest('#compose-emoji-btn') &&
          !e.target.closest('#compose-emoji-btn-sidebar')) {
          closeEmojiPicker();
        }
      });

      picker._renderEmojis = renderEmojis;
    }

    async function openEmojiPicker(btn, textarea, updateCb) {
      const picker = $('emoji-picker');
      emojiPickerTarget = textarea;
      updateCountCallback = updateCb;

      const rect = btn.getBoundingClientRect();
      picker.style.display = 'flex';

      // Attempt to place above or below depending on space
      if (rect.bottom + 250 > window.innerHeight) {
        picker.style.top = (rect.top - 280) + 'px';
      } else {
        picker.style.top = (rect.bottom + 10) + 'px';
      }
      picker.style.left = Math.max(10, rect.left - 100) + 'px';

      $('emoji-search').value = '';

      if (!standardEmojisLoaded) {
        $('emoji-picker-body').innerHTML = '<div style="grid-column: 1 / -1; text-align: center; color: var(--text-dim); padding: 20px;">Loading emojis...</div>';
      }

      await loadStandardEmojis();
      await loadCustomEmojis();

      picker._renderEmojis();
      $('emoji-search').focus();
    }

    function closeEmojiPicker() {
      $('emoji-picker').style.display = 'none';
      emojiPickerTarget = null;
      updateCountCallback = null;
    }

    initEmojiPicker();

    $('compose-emoji-btn').addEventListener('click', (e) => {
      e.stopPropagation();
      openEmojiPicker(e.currentTarget, $('compose-textarea'), updateCharCount);
    });

    // Post button
    $('compose-post-btn').addEventListener('click', handlePost);

    // Initialize sidebar compose form
    function setupSidebarCompose() {
      const suffix = '-sidebar';

      $('hashtag-filter-select').addEventListener('change', (e) => {
        state.selectedHashtagFilter = e.target.value;
        loadHashtagsTab();
      });

      // Event listeners for sidebar
      $('compose-textarea' + suffix).addEventListener('input', updateSidebarCharCount);
      $('compose-cw-input' + suffix).addEventListener('input', updateSidebarCharCount);

      $('compose-cw-btn' + suffix).addEventListener('click', () => {
        const section = $('compose-cw-section' + suffix);
        const btn = $('compose-cw-btn' + suffix);
        const isVisible = section.style.display !== 'none';

        section.style.display = isVisible ? 'none' : 'block';
        btn.classList.toggle('active', !isVisible);

        if (!isVisible) {
          $('compose-cw-input' + suffix).focus();
        } else {
          $('compose-cw-input' + suffix).value = '';
          updateSidebarCharCount();
        }
      });

      $('compose-media-btn' + suffix).addEventListener('click', () => {
        $('compose-media-input' + suffix).click();
      });

      $('compose-media-input' + suffix).addEventListener('change', (e) => {
        const files = Array.from(e.target.files);
        if (files.length === 0) return;

        const available = 4 - composeState.sidebarMediaFiles.length;
        const toAdd = files.slice(0, available);

        toAdd.forEach(file => {
          composeState.sidebarMediaFiles.push(file);
          const url = URL.createObjectURL(file);
          composeState.sidebarMediaUrls.push(url);
          composeState.sidebarMediaDescriptions.push(''); // Empty desc to start

          const preview = $('compose-media-preview' + suffix);
          const item = document.createElement('div');
          item.className = 'compose-media-item';

          const isVideo = file.type.startsWith('video/');
          const mediaEl = isVideo ? document.createElement('video') : document.createElement('img');
          mediaEl.src = url;
          if (isVideo) mediaEl.muted = true;

          const altBtn = document.createElement('button');
          altBtn.className = 'compose-media-item-alt-btn missing';
          altBtn.textContent = 'ALT';
          altBtn.onclick = () => {
            const idx = composeState.sidebarMediaUrls.indexOf(url);
            openAltModal(url, idx, suffix, composeState.sidebarMediaDescriptions[idx]);
          };

          const removeBtn = document.createElement('button');
          removeBtn.className = 'compose-media-remove';
          removeBtn.innerHTML = '<svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>';
          removeBtn.onclick = () => {
            const index = composeState.sidebarMediaUrls.indexOf(url);
            if (index > -1) {
              URL.revokeObjectURL(url);
              composeState.sidebarMediaFiles.splice(index, 1);
              composeState.sidebarMediaUrls.splice(index, 1);
              composeState.sidebarMediaDescriptions.splice(index, 1);
            }
            item.remove();
            updateSidebarCharCount();
          };

          item.appendChild(mediaEl);
          if (!isVideo) item.appendChild(altBtn);
          item.appendChild(removeBtn);
          preview.appendChild(item);
        });

        updateSidebarCharCount();
        e.target.value = '';
      });

      $('compose-emoji-btn' + suffix).addEventListener('click', (e) => {
        e.stopPropagation();
        openEmojiPicker(e.currentTarget, $('compose-textarea' + suffix), updateSidebarCharCount);
      });

      $('compose-post-btn' + suffix).addEventListener('click', async () => {
        const btn = $('compose-post-btn' + suffix);
        const textarea = $('compose-textarea' + suffix);
        const cwInput = $('compose-cw-input' + suffix);
        const visibility = $('compose-visibility' + suffix).value;

        const status = textarea.innerText.trim();
        const spoilerText = cwInput.value.trim();

        if (!status && composeState.sidebarMediaFiles.length === 0) return;

        btn.disabled = true;
        btn.textContent = 'Posting...';

        try {
          const mediaIds = [];
          for (let i = 0; i < composeState.sidebarMediaFiles.length; i++) {
            const file = composeState.sidebarMediaFiles[i];
            const desc = composeState.sidebarMediaDescriptions[i];
            const formData = new FormData();
            formData.append('file', file);
            if (desc) formData.append('description', desc);

            const res = await fetch(`https://${state.server}/api/v1/media`, {
              method: 'POST',
              headers: { 'Authorization': `Bearer ${state.token}` },
              body: formData,
            });

            if (!res.ok) throw new Error('Failed to upload media');
            const media = await res.json();
            mediaIds.push(media.id);
          }

          const postData = { status, visibility };
          if (composeState.replyToId) postData.in_reply_to_id = composeState.replyToId;
          if (composeState.quoteId) postData.quoted_status_id = composeState.quoteId;
          if (spoilerText) postData.spoiler_text = spoilerText;
          if (mediaIds.length) postData.media_ids = mediaIds;

          const res = await fetch(`https://${state.server}/api/v1/statuses`, {
            method: 'POST',
            headers: {
              'Authorization': `Bearer ${state.token}`,
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(postData),
          });

          if (!res.ok) {
            const error = await res.json().catch(() => ({}));
            throw new Error(error.error || 'Failed to post');
          }

          showToast('Posted successfully!');

          // Reset form
          textarea.innerHTML = '';
          cwInput.value = '';
          $('compose-cw-section' + suffix).style.display = 'none';
          $('compose-cw-btn' + suffix).classList.remove('active');
          $('compose-visibility' + suffix).value = 'public';
          composeState.sidebarMediaFiles = [];
          composeState.sidebarMediaUrls.forEach(url => URL.revokeObjectURL(url));
          composeState.sidebarMediaUrls = [];
          composeState.sidebarMediaDescriptions = [];
          $('compose-media-preview' + suffix).innerHTML = '';
          resetReplyState();
          updateSidebarCharCount();

          // Refresh current tab
          if (state.activeTab === 'home') loadHomeTab();
          else if (state.activeTab === 'following') loadFollowingTab();

        } catch (err) {
          showToast('Failed to post: ' + err.message);
        } finally {
          btn.disabled = false;
          btn.textContent = 'Post';
        }
      });
    }

    function setupContentEditable(editor) {
      editor.addEventListener('paste', (e) => {
        e.preventDefault();
        const text = (e.originalEvent || e).clipboardData.getData('text/plain');
        document.execCommand('insertText', false, text);
      });
    }

    setupContentEditable($('compose-textarea'));
    setupContentEditable($('compose-textarea-sidebar'));

    function setupHashtagTab() {
      const input = $('hashtag-search-input');
      if (input) {
        input.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const val = input.value.trim().replace(/^#/, '');
            if (val) {
              state.selectedHashtagFilter = val.toLowerCase();
              loadHashtagsTab();
              input.value = '';
            }
          }
        });
      }

      const followBtn = $('hashtag-follow-btn');
      if (followBtn) {
        followBtn.addEventListener('click', () => handleHashtagFollowToggle(followBtn));
      }
    }

    setupSidebarCompose();
    setupHashtagTab();


    async function handlePost() {
      const btn = $('compose-post-btn');
      const textarea = $('compose-textarea');
      const cwInput = $('compose-cw-input');
      const visibility = $('compose-visibility').value;

      const status = textarea.innerText.trim();
      const spoilerText = cwInput.value.trim();

      if (!status && composeState.mediaFiles.length === 0) return;

      btn.disabled = true;
      btn.textContent = 'Posting...';

      try {
        // Upload media first if any
        const mediaIds = [];
        for (let i = 0; i < composeState.mediaFiles.length; i++) {
          const file = composeState.mediaFiles[i];
          const desc = composeState.mediaDescriptions[i];
          const formData = new FormData();
          formData.append('file', file);
          if (desc) formData.append('description', desc);

          const res = await fetch(`https://${state.server}/api/v1/media`, {
            method: 'POST',
            headers: { 'Authorization': `Bearer ${state.token}` },
            body: formData,
          });

          if (!res.ok) throw new Error('Failed to upload media');
          const media = await res.json();
          mediaIds.push(media.id);
        }

        // Create the post
        const postData = {
          status,
          visibility,
        };
        if (composeState.replyToId) postData.in_reply_to_id = composeState.replyToId;
        if (composeState.quoteId) postData.quoted_status_id = composeState.quoteId;

        if (spoilerText) postData.spoiler_text = spoilerText;
        if (mediaIds.length) postData.media_ids = mediaIds;

        const res = await fetch(`https://${state.server}/api/v1/statuses`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(postData),
        });

        if (!res.ok) {
          const error = await res.json().catch(() => ({}));
          throw new Error(error.error || 'Failed to post');
        }

        showToast('Posted successfully!');
        closeComposeDrawer();

        // Refresh current tab
        if (state.activeTab === 'home') loadHomeTab();
        else if (state.activeTab === 'following') loadFollowingTab();

      } catch (err) {
        showToast('Failed to post: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Post';
      }
    }

    /* ═══════════════════════════════════════════════
       DELEGATION EVENT HANDLERS
    ══════════════════════════════════════════════════ */

    // Delegate avatar/name clicks to open profile drawer
    document.addEventListener('click', e => {
      const trigger = e.target.closest('[data-profile-id]');
      if (trigger) {
        e.preventDefault();
        closeThreadDrawer();
        closeComposeDrawer();
        openProfileDrawer(trigger.dataset.profileId, trigger.dataset.profileServer);
        return;
      }

      // Handle follow/unfollow button clicks
      const followBtn = e.target.closest('.profile-follow-btn');
      if (followBtn) {
        e.preventDefault();
        handleFollowToggle(followBtn);
        return;
      }

      // Handle favorite/star button clicks
      const favBtn = e.target.closest('.post-fav-btn');
      if (favBtn) {
        e.preventDefault();
        handleFavoriteToggle(favBtn);
        return;
      }

      // Handle boost button clicks
      const boostBtn = e.target.closest('.post-boost-btn');
      if (boostBtn) {
        e.preventDefault();
        e.stopPropagation();
        window.toggleBoostMenu(boostBtn.dataset.postId, boostBtn);
        return;
      }

      // Handle reply button clicks
      const replyBtn = e.target.closest('.post-reply-btn');
      if (replyBtn) {
        e.preventDefault();
        handleReply(replyBtn.dataset.postId, replyBtn.dataset.accountAcct);
        return;
      }

      // Handle boost dropdown item clicks
      const boostItem = e.target.closest('.boost-dropdown-item');
      if (boostItem) {
        e.preventDefault();
        e.stopPropagation();
        if (boostItem.dataset.action === 'boost') {
          window.handleBoostSubmit(boostItem.dataset.postId, boostItem.dataset.isBoosted === 'true');
        } else if (boostItem.dataset.action === 'quote') {
          window.handleQuoteInit(boostItem.dataset.postId, boostItem.dataset.acct);
        }
        return;
      }

      // Handle Load More button clicks
      const loadMoreBtn = e.target.closest('.load-more-btn');
      if (loadMoreBtn) {
        e.preventDefault();
        handleLoadMore(loadMoreBtn);
        return;
      }

      // Handle Hashtag clicks
      const hashtagLink = e.target.closest('a.hashtag');
      if (hashtagLink) {
        e.preventDefault();
        // Prefer the inner .trending-tag text for Trending panel links,
        // otherwise fall back to the anchor text (post hashtags).
        const tagSourceEl = hashtagLink.querySelector('.trending-tag');
        const rawText = tagSourceEl ? tagSourceEl.textContent : hashtagLink.textContent;
        const tag = rawText.replace(/^#/, '').split(/\s+/)[0].toLowerCase();

        // Set the active filter state
        state.selectedHashtagFilter = tag;

        // Switch to the Hashtags tab visually
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.tab === 'hashtags');
        });
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.toggle('active', p.id === 'panel-hashtags');
        });
        state.activeTab = 'hashtags';

        closeProfileDrawer();
        closeThreadDrawer();
        closeComposeDrawer();

        window.scrollTo({ top: 0, behavior: 'smooth' });
        loadHashtagsTab();
        return;
      }

      // Handle Trending Hashtag row clicks
      const trendingTagLink = e.target.closest('[data-trending-tag]');
      if (trendingTagLink) {
        e.preventDefault();
        const tag = trendingTagLink.dataset.trendingTag.toLowerCase();

        state.selectedHashtagFilter = tag;

        // Switch to Hashtags tab
        document.querySelectorAll('.tab-btn').forEach(b => {
          b.classList.toggle('active', b.dataset.tab === 'hashtags');
        });
        document.querySelectorAll('.tab-panel').forEach(p => {
          p.classList.toggle('active', p.id === 'panel-hashtags');
        });
        state.activeTab = 'hashtags';

        closeProfileDrawer();
        closeThreadDrawer();
        closeComposeDrawer();

        window.scrollTo({ top: 0, behavior: 'smooth' });
        loadHashtagsTab();
      }

      // Handle post article clicks → open thread view
      // Skip if we're inside the thread drawer (no re-opening from thread)
      // Skip if clicked on interactive elements
      const INTERACTIVE = 'a, button, input, select, textarea, [data-profile-id], .post-footer, .cw-wrapper, .post-quote, .media-item, .boost-dropdown, video, .sensitive-overlay';
      const postArticle = e.target.closest('article.post');
      if (postArticle && !e.target.closest(INTERACTIVE) && !e.target.closest('.thread-drawer')) {
        e.preventDefault();
        const statusId = postArticle.dataset.id;
        if (statusId) {
          // Close other drawers so the inline thread or thread drawer is clearly visible
          closeProfileDrawer();
          closeComposeDrawer();
          openThreadDrawer(statusId);
        }
        return;
      }
    });

    async function handleLoadMore(btn) {
      const feed = state.activeTab;

      let maxIdToUse = state.homeMaxId;
      if (feed === 'hashtags' && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
        maxIdToUse = state.hashtagMaxId;
      }
      if (!maxIdToUse) return;

      btn.disabled = true;
      btn.textContent = 'Loading...';

      try {
        let newPosts = [];
        if (feed === 'hashtags' && state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
          const tag = encodeURIComponent(state.selectedHashtagFilter);
          newPosts = await apiGet(`/api/v1/timelines/tag/${tag}?limit=40&max_id=${maxIdToUse}`, state.token);
          newPosts.forEach(p => p._sourceTags = [state.selectedHashtagFilter]);
          state.hashtagFeed = [...(state.hashtagFeed || []), ...newPosts];
          state.hashtagMaxId = newPosts.length ? newPosts[newPosts.length - 1].id : null;
          maxIdToUse = state.hashtagMaxId;
        } else {
          newPosts = await apiGet(`/api/v1/timelines/home?limit=40&max_id=${state.homeMaxId}`, state.token);

          const followedTagNames = new Set((state.followedHashtags || []).map(t => t.name.toLowerCase()));
          newPosts.forEach(p => {
            p._sourceTags = [];
            const inner = p.reblog || p;
            if (inner.tags && Array.isArray(inner.tags)) {
              inner.tags.forEach(t => {
                if (followedTagNames.has(t.name.toLowerCase())) p._sourceTags.push(t.name.toLowerCase());
              });
            }
          });

          state.homeFeed = [...(state.homeFeed || []), ...newPosts];
          state.homeMaxId = newPosts.length ? newPosts[newPosts.length - 1].id : null;
          maxIdToUse = state.homeMaxId;
          renderTrendingNowFromState();
        }

        let display = newPosts;
        if (feed === 'following' && !state.demoMode) display = await filterForFollowing(newPosts);
        else if (feed === 'hashtags') {
          if (state.selectedHashtagFilter && state.selectedHashtagFilter !== 'all') {
            display = newPosts;
          } else {
            display = newPosts.filter(p => p._sourceTags && p._sourceTags.length > 0);
          }
        }

        const html = display.map(p => renderPost(p, { tags: p._sourceTags || [] })).join('');
        const container = $(`${feed}-posts`);
        const tmp = document.createElement('div');
        tmp.innerHTML = html;
        while (tmp.firstChild) container.insertBefore(tmp.firstChild, btn);

        btn.disabled = false;
        btn.textContent = 'Load More';

        if (!maxIdToUse) btn.remove();
        else setTimeout(checkInfiniteScroll, 100);

      } catch (err) {
        showToast('Failed to load more: ' + err.message);
        btn.disabled = false;
        btn.textContent = 'Load More';
      }
    }


    async function handleFollowToggle(btn) {
      if (btn.disabled) return;

      const accountId = btn.dataset.accountId;
      const isFollowing = btn.dataset.following === 'true';

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = '...';

      try {
        const endpoint = isFollowing
          ? `/api/v1/accounts/${accountId}/unfollow`
          : `/api/v1/accounts/${accountId}/follow`;

        const res = await fetch(`https://${state.server}${endpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-store',
        });

        if (!res.ok) throw new Error('Failed to update relationship');

        const relationship = await res.json();
        const nowFollowing = relationship.following;

        // Update button state
        btn.dataset.following = nowFollowing ? 'true' : 'false';
        btn.textContent = nowFollowing ? 'Following' : 'Follow';
        btn.classList.toggle('following', nowFollowing);

        showToast(nowFollowing ? 'Now following' : 'Unfollowed');
      } catch (err) {
        btn.textContent = originalText;
        showToast('Action failed: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function handleHashtagFollowToggle(btn) {
      if (btn.disabled) return;

      const tag = btn.dataset.tag;
      const isFollowing = btn.dataset.following === 'true';

      btn.disabled = true;
      const originalText = btn.textContent;
      btn.textContent = '...';

      try {
        const endpoint = isFollowing
          ? `/api/v1/tags/${tag}/unfollow`
          : `/api/v1/tags/${tag}/follow`;

        const res = await fetch(`https://${state.server}${endpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-store',
        });

        if (!res.ok) throw new Error('Failed to update hashtag follow status');

        const tagInfo = await res.json();
        const nowFollowing = tagInfo.following;

        // Update button state
        btn.dataset.following = nowFollowing ? 'true' : 'false';
        btn.textContent = nowFollowing ? 'Following' : `Follow #${tag}`;
        btn.classList.toggle('following', nowFollowing);

        // Update state
        if (nowFollowing) {
          if (!state.followedHashtags.some(t => t.name.toLowerCase() === tag.toLowerCase())) {
            state.followedHashtags.push(tagInfo);
          }
        } else {
          state.followedHashtags = state.followedHashtags.filter(t => t.name.toLowerCase() !== tag.toLowerCase());
        }

        showToast(nowFollowing ? `Following #${tag}` : `Unfollowed #${tag}`);
      } catch (err) {
        btn.textContent = originalText;
        showToast('Action failed: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    async function handleFavoriteToggle(btn) {
      if (btn.disabled) return;

      const postId = btn.dataset.postId;
      const isFavourited = btn.dataset.favourited === 'true';
      const willBeFavourited = !isFavourited;

      // Store original state for rollback on error
      const originalFavourited = isFavourited;
      const svg = btn.querySelector('svg');
      const countSpan = btn.querySelector('.post-fav-count');
      const originalCount = countSpan ? parseInt(countSpan.textContent) || 0 : 0;

      btn.disabled = true;

      // Optimistically update UI immediately
      if (willBeFavourited) {
        btn.classList.add('favoriting');
        setTimeout(() => btn.classList.remove('favoriting'), 500);
      } else {
        btn.classList.add('unfavoriting');
        setTimeout(() => btn.classList.remove('unfavoriting'), 500);
      }

      btn.dataset.favourited = willBeFavourited ? 'true' : 'false';
      btn.classList.toggle('favourited', willBeFavourited);
      btn.title = willBeFavourited ? 'Unfavorite' : 'Favorite';

      if (svg) {
        // Keep filled during animation
        svg.setAttribute('fill', 'currentColor');

        if (!willBeFavourited) {
          // On unfavorite, after the spin animation completes, fade out
          setTimeout(() => {
            btn.classList.add('unfavorite-fade');
            setTimeout(() => {
              svg.setAttribute('fill', 'none');
              btn.classList.remove('unfavorite-fade');
            }, 300);
          }, 500);
        }
      }

      if (countSpan) {
        const newCount = willBeFavourited ? originalCount + 1 : Math.max(0, originalCount - 1);
        countSpan.textContent = newCount;
      }

      // Now make the API call
      try {
        const endpoint = originalFavourited
          ? `/api/v1/statuses/${postId}/unfavourite`
          : `/api/v1/statuses/${postId}/favourite`;

        const res = await fetch(`https://${state.server}${endpoint}`, {
          method: 'POST',
          headers: {
            'Authorization': `Bearer ${state.token}`,
            'Content-Type': 'application/json'
          },
          cache: 'no-store',
        });

        if (!res.ok) throw new Error('Failed to favorite');

        const post = await res.json();

        // Sync with actual server state (in case count differs)
        if (countSpan) {
          countSpan.textContent = post.favourites_count || 0;
        }
      } catch (err) {
        // Rollback on error
        btn.dataset.favourited = originalFavourited ? 'true' : 'false';
        btn.classList.toggle('favourited', originalFavourited);
        btn.title = originalFavourited ? 'Unfavorite' : 'Favorite';

        if (svg) {
          svg.setAttribute('fill', originalFavourited ? 'currentColor' : 'none');
          btn.classList.remove('unfavorite-fade');
        }

        if (countSpan) {
          countSpan.textContent = originalCount;
        }

        showToast('Failed to favorite: ' + err.message);
      } finally {
        btn.disabled = false;
      }
    }

    /* ═══════════════════════════════════════════════
       DEMO DATA
    ══════════════════════════════════════════════════ */
    function getDemoHomePosts() {
      const now = Date.now();
      const t = (ms) => new Date(now - ms).toISOString();

      // Interleave hashtag-sourced posts to demonstrate badges on home feed
      return [
        {
          id: '1', created_at: t(1000 * 60 * 3), in_reply_to_id: null, spoiler_text: '',
          reblog: null, sensitive: false, replies_count: 4, reblogs_count: 12, favourites_count: 87,
          url: '#', poll: null, media_attachments: [],
          _sourceTags: ['webdev', 'performance'],
          account: { id: 'a1', acct: 'talia@mastodon.social', display_name: 'Talia Voss', avatar: 'https://i.pravatar.cc/80?img=47', avatar_static: 'https://i.pravatar.cc/80?img=47', url: '#' },
          content: `<p>Just pushed a pretty big refactor of our rendering pipeline. Going from a pull-based to a push-based model cut latency by ~40% in our tests. Sometimes the boring architectural decisions are the most impactful ones. <a href="#" class="hashtag">#webdev</a> <a href="#" class="hashtag">#performance</a></p>`,
        },
        {
          id: 'h1', created_at: t(1000 * 60 * 5), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 2, reblogs_count: 8, favourites_count: 34,
          url: '#', poll: null, media_attachments: [],
          _sourceTags: ['webdev'],
          account: { id: 'ha1', acct: 'lena@fosstodon.org', display_name: 'Lena Brandt', avatar: 'https://i.pravatar.cc/80?img=16', avatar_static: 'https://i.pravatar.cc/80?img=16', url: '#' },
          content: `<p>TIL that the <code>:has()</code> CSS selector is now supported in all major browsers. The number of JS-dependent patterns this makes purely CSS is genuinely exciting. <a href="#" class="hashtag">#webdev</a> <a href="#" class="hashtag">#css</a></p>`,
        },
        {
          id: '2', created_at: t(1000 * 60 * 9), spoiler_text: '', sensitive: false,
          reblog: {
            id: '2r', created_at: t(1000 * 60 * 30), spoiler_text: '', sensitive: false,
            replies_count: 22, reblogs_count: 341, favourites_count: 1204,
            url: '#', poll: null, media_attachments: [],
            account: { id: 'a3', acct: 'mireille@fosstodon.org', display_name: 'Mireille Chen', avatar: 'https://i.pravatar.cc/80?img=5', avatar_static: 'https://i.pravatar.cc/80?img=5', url: '#' },
            content: `<p>The thing nobody tells you about open source is that the hardest part isn't writing the code—it's writing the docs clearly enough that someone at 2am in a timezone 12 hours from yours can figure it out without asking. That empathy muscle is the actual skill.</p>`,
          },
          replies_count: 0, reblogs_count: 0, favourites_count: 0, poll: null, media_attachments: [],
          _sourceTags: [],
          account: { id: 'a2', acct: 'joel@hachyderm.io', display_name: 'Joel Ramírez', avatar: 'https://i.pravatar.cc/80?img=12', avatar_static: 'https://i.pravatar.cc/80?img=12', url: '#' },
          url: '#', content: '',
        },
        {
          id: '3', created_at: t(1000 * 60 * 17), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 8, reblogs_count: 5, favourites_count: 66,
          url: '#', poll: null, media_attachments: [],
          _sourceTags: ['fediverse'],
          account: { id: 'a4', acct: 'priyanka@chaos.social', display_name: 'Priyanka S.', avatar: 'https://i.pravatar.cc/80?img=9', avatar_static: 'https://i.pravatar.cc/80?img=9', url: '#' },
          content: `<p>Trying to explain why I prefer Mastodon over other platforms and I keep coming back to: the people here seem to be *here* because they want to talk about things, not because they're optimizing for followers. It's a subtle but very real difference. <a href="#" class="hashtag">#fediverse</a></p>`,
        },
        {
          id: '4', created_at: t(1000 * 60 * 28), spoiler_text: 'mild rant about CSS grid', sensitive: false,
          reblog: null, replies_count: 14, reblogs_count: 9, favourites_count: 103,
          url: '#', poll: null, media_attachments: [],
          _sourceTags: [],
          account: { id: 'a5', acct: 'dex@infosec.exchange', display_name: 'Dex Fontaine', avatar: 'https://i.pravatar.cc/80?img=33', avatar_static: 'https://i.pravatar.cc/80?img=33', url: '#' },
          content: `<p>CSS grid is genuinely magic and I will die on this hill. Subgrid support finally landing everywhere means I can delete about 30% of my layout hacks. The number of "why won't this align" problems that just... disappear is not small.</p>`,
        },
        {
          id: '5', created_at: t(1000 * 60 * 45), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 3, reblogs_count: 18, favourites_count: 72,
          url: '#', _sourceTags: [],
          poll: {
            votes_count: 847,
            expired: false,
            options: [
              { title: 'Tabs', votes_count: 523 },
              { title: 'Spaces', votes_count: 289 },
              { title: 'I use a formatter, this is a non-issue', votes_count: 35 },
            ]
          },
          media_attachments: [],
          account: { id: 'a6', acct: 'sam@mastodon.online', display_name: 'Sam Okafor', avatar: 'https://i.pravatar.cc/80?img=51', avatar_static: 'https://i.pravatar.cc/80?img=51', url: '#' },
          content: `<p>The eternal question. Settle this for me:</p>`,
        },
        {
          id: '6', created_at: t(1000 * 60 * 62), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 6, reblogs_count: 24, favourites_count: 198,
          url: '#', poll: null, media_attachments: [],
          _sourceTags: [],
          account: { id: 'a7', acct: 'nevada@mastodon.social', display_name: 'Nevada Park', avatar: 'https://i.pravatar.cc/80?img=22', avatar_static: 'https://i.pravatar.cc/80?img=22', url: '#' },
          content: `<p>Reminder that "move fast and break things" was never good advice — it just happened to work for a narrow window when consumer internet was forgiving and the stakes were low. Both those things are very much no longer true. <a href="#" class="hashtag">#tech</a> <a href="#" class="hashtag">#engineering</a></p>`,
        },
      ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
    }

    function getDemoFollowingPosts() {
      const now = Date.now();
      const t = (ms) => new Date(now - ms).toISOString();
      return getDemoHomePosts().filter(p => !p.reblog);
    }

    function getDemoHashtagData() {
      const now = Date.now();
      const t = (ms) => new Date(now - ms).toISOString();
      const tags = ['webdev', 'fediverse', 'opensource'];
      const posts = [
        {
          id: 'h1', created_at: t(1000 * 60 * 5), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 2, reblogs_count: 8, favourites_count: 34,
          url: '#', poll: null, media_attachments: [], _tag: 'webdev',
          account: { id: 'ha1', acct: 'lena@fosstodon.org', display_name: 'Lena Brandt', avatar: 'https://i.pravatar.cc/80?img=16', avatar_static: 'https://i.pravatar.cc/80?img=16', url: '#' },
          content: `<p>TIL that the <code>:has()</code> CSS selector is now supported in all major browsers. The number of JS-dependent patterns this makes purely CSS is genuinely exciting. <a href="#" class="hashtag">#webdev</a> <a href="#" class="hashtag">#css</a></p>`,
        },
        {
          id: 'h2', created_at: t(1000 * 60 * 22), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 11, reblogs_count: 31, favourites_count: 156,
          url: '#', poll: null, media_attachments: [], _tag: 'fediverse',
          account: { id: 'ha2', acct: 'orion@chaos.social', display_name: 'Orion Wells', avatar: 'https://i.pravatar.cc/80?img=60', avatar_static: 'https://i.pravatar.cc/80?img=60', url: '#' },
          content: `<p>The fediverse is doing something quietly remarkable: proving that decentralized social infrastructure can actually work at scale. Not perfectly, not without challenges — but it works, and it's growing. <a href="#" class="hashtag">#fediverse</a> <a href="#" class="hashtag">#activitypub</a></p>`,
        },
        {
          id: 'h3', created_at: t(1000 * 60 * 48), spoiler_text: '', sensitive: false,
          reblog: null, replies_count: 5, reblogs_count: 14, favourites_count: 89,
          url: '#', poll: null, media_attachments: [], _tag: 'opensource',
          account: { id: 'ha3', acct: 'piero@mastodon.social', display_name: 'Piero Gallo', avatar: 'https://i.pravatar.cc/80?img=39', avatar_static: 'https://i.pravatar.cc/80?img=39', url: '#' },
          content: `<p>Six years of maintaining this library and someone just opened a PR that rewrote the core algorithm in a way I'd never considered. It's faster, cleaner, and frankly I don't know why I didn't think of it. This is why I still love <a href="#" class="hashtag">#opensource</a>.</p>`,
        },
      ];
      return { tags, posts };
    }

    /* ═══════════════════════════════════════════════
       STARTUP LOGIC
    ══════════════════════════════════════════════════ */
    async function boot() {
      // If we're a popup completing OAuth, just run the callback and close
      const params = new URLSearchParams(location.search);
      const code = params.get('code');

      if (code) {
        await handleCallback(code);
        return;
      }

      // Detect file:// — OAuth popups need a real HTTP origin
      if (location.protocol === 'file:') {
        showScreen('login-screen');
        showLoginError(
          '⚠ Opened as a local file (file://).\n\n' +
          'OAuth requires a real HTTP origin. Serve it locally:\n\n' +
          '  python3 -m http.server 8080\n\n' +
          'Then open: http://localhost:8080/elefeed.html'
        );
        return;
      }

      // Check for stored session
      const token = store.get('token');
      const server = store.get('server');
      const tokenScopes = store.get('token_scopes');

      if (token && server) {
        // Validate token scopes match current SCOPES
        if (tokenScopes === SCOPES) {
          await initApp(server, token);
          return;
        }
        // Token has wrong scopes - clear it and force re-login
        store.del('token');
        store.del('server');
        store.del('token_scopes');
      }

      showScreen('login-screen');
    }

    /* Network status */
    window.addEventListener('offline', () => $('offline-bar').classList.add('visible'));
    window.addEventListener('online', () => $('offline-bar').classList.remove('visible'));

    boot().catch(err => {
      console.error('Boot error:', err);
      showScreen('login-screen');
    });
  </script>
</body>

</html>